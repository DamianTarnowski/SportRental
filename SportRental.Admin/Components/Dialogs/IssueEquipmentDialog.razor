@rendermode InteractiveServer
@using SportRental.Infrastructure.Data
@using SportRental.Infrastructure.Domain
@using Microsoft.EntityFrameworkCore

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@Icons.Material.Filled.Output" Color="Color.Success" />
            <MudText Typo="Typo.h6">ðŸ“¦ Wydanie sprzÄ™tu</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="2">
            @* Info o kliencie - kompaktowe *@
            <MudAlert Severity="Severity.Info" Dense="true" Class="pa-2">
                <div class="d-flex align-center gap-2">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                    <MudText Typo="Typo.body2" Style="font-weight: 600;">
                        @(Rental?.Customer?.FullName ?? "Nieznany klient")
                    </MudText>
                </div>
            </MudAlert>
            
            @* Lista produktÃ³w - kompaktowa *@
            <MudText Typo="Typo.caption" Style="font-weight: 600;">Produkty:</MudText>
            <MudStack Spacing="1">
                @if (Rental?.Items != null)
                {
                    @foreach (var item in Rental.Items)
                    {
                        <div class="d-flex align-center gap-2 pa-1" style="background: var(--mud-palette-background-grey); border-radius: 6px;">
                            <MudIcon Icon="@Icons.Material.Filled.SportsSoccer" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.body2">@(item.Product?.Name ?? "Produkt")</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">Ã—@item.Quantity</MudChip>
                        </div>
                    }
                }
            </MudStack>
            
            @* Uwagi *@
            <MudTextField @bind-Value="_issueNotes" 
                          Label="Uwagi (opcjonalne)"
                          Variant="Variant.Outlined"
                          Lines="2"
                          Dense="true"
                          Placeholder="Stan sprzÄ™tu, dodatkowe info..." />
            
            @* Checkbox potwierdzenia *@
            <MudCheckBox @bind-Value="_confirmChecklist" 
                         Label="Potwierdzam sprawdzenie stanu sprzÄ™tu"
                         Color="Color.Success"
                         Dense="true" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Size="Size.Small">Anuluj</MudButton>
        <MudButton OnClick="Submit" 
                   Variant="Variant.Filled" 
                   Color="Color.Success"
                   Disabled="@(!_confirmChecklist || _isProcessing)"
                   StartIcon="@Icons.Material.Filled.Check"
                   Size="Size.Small">
            @if (_isProcessing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
            }
            Wydaj
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance? MudDialog { get; set; }
    
    [Parameter]
    public Rental? Rental { get; set; }
    
    private string? _issueNotes;
    private bool _confirmChecklist;
    private bool _isProcessing;

    private void Cancel() => MudDialog?.Cancel();

    private async Task Submit()
    {
        if (Rental == null || !_confirmChecklist) return;
        
        _isProcessing = true;
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            var rental = await db.Rentals.FirstOrDefaultAsync(r => r.Id == Rental.Id);
            if (rental == null)
            {
                Snackbar.Add("Nie znaleziono wypoÅ¼yczenia", Severity.Error);
                MudDialog?.Cancel();
                return;
            }
            
            rental.IssuedAtUtc = DateTime.UtcNow;
            rental.IssueNotes = _issueNotes;
            rental.Status = RentalStatus.Active;
            
            await db.SaveChangesAsync();
            
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"BÅ‚Ä…d: {ex.Message}", Severity.Error);
            MudDialog?.Cancel();
        }
        finally
        {
            _isProcessing = false;
        }
    }
}
