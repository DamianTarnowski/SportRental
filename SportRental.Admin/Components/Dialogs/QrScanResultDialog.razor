@using SportRental.Infrastructure.Domain
@using SportRental.Admin.Services.QrCode

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            @if (Product != null)
            {
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                <MudText Typo="Typo.h6">Znaleziono produkt</MudText>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" />
                <MudText Typo="Typo.h6">Nie znaleziono</MudText>
            }
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (Product != null)
        {
            <MudStack Spacing="3">
                <!-- Product Image -->
                @if (!string.IsNullOrEmpty(Product.ImageUrl))
                {
                    <MudImage Src="@Product.ImageUrl" Alt="@Product.Name" 
                              ObjectFit="ObjectFit.Cover" Height="150" 
                              Class="rounded-lg mx-auto" />
                }
                else
                {
                    <MudPaper Class="pa-4 text-center rounded-lg" Elevation="0" 
                              Style="background: var(--mud-palette-background-grey);">
                        <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Large" Color="Color.Default" />
                    </MudPaper>
                }
                
                <!-- Product Info -->
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h5" Class="fw-bold">@Product.Name</MudText>
                    
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Filled">
                            @Product.Category
                        </MudChip>
                        @if (!string.IsNullOrEmpty(Product.Sku))
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                SKU: @Product.Sku
                            </MudChip>
                        }
                    </MudStack>
                </MudStack>
                
                <!-- Stats -->
                <MudSimpleTable Dense="true" Hover="true" Bordered="true">
                    <tbody>
                        <tr>
                            <td><strong>Cena dzienna</strong></td>
                            <td>@Product.DailyPrice.ToString("C")</td>
                        </tr>
                        @if (Product.HourlyPrice.HasValue)
                        {
                            <tr>
                                <td><strong>Cena godzinowa</strong></td>
                                <td>@Product.HourlyPrice.Value.ToString("C")</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>Dostępne</strong></td>
                            <td>
                                <MudChip T="string" Size="Size.Small" 
                                         Color="@(Product.AvailableQuantity > 0 ? Color.Success : Color.Error)">
                                    @Product.AvailableQuantity szt.
                                </MudChip>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Status</strong></td>
                            <td>
                                @if (Product.IsActive)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">✓ Aktywny</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error">✗ Nieaktywny</MudChip>
                                }
                            </td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudStack>
        }
        else
        {
            <MudStack Spacing="2" AlignItems="AlignItems.Center" Class="pa-4">
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Warning" />
                <MudText Typo="Typo.body1">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        @ErrorMessage
                    }
                    else
                    {
                        <span>Nie znaleziono produktu o podanym kodzie QR.</span>
                    }
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Zeskanowany kod: @QrData
                </MudText>
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        @if (Product != null)
        {
            <MudButton Variant="Variant.Text" OnClick="Cancel">Zamknij</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Success" 
                       OnClick="() => SelectAction(QrAction.IssueEquipment)"
                       StartIcon="@Icons.Material.Filled.Output">
                Wydaj sprzęt
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Info"
                       OnClick="() => SelectAction(QrAction.ReturnEquipment)"
                       StartIcon="@Icons.Material.Filled.Input">
                Przyjmij zwrot
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="() => SelectAction(QrAction.ViewDetails)"
                       StartIcon="@Icons.Material.Filled.Visibility">
                Szczegóły
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Text" OnClick="Cancel">Zamknij</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ScanAgain">
                Skanuj ponownie
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter] public Product? Product { get; set; }
    [Parameter] public string QrData { get; set; } = "";
    [Parameter] public string? ErrorMessage { get; set; }
    
    private void Cancel() => MudDialog.Cancel();
    
    private void ScanAgain() => MudDialog.Close(DialogResult.Ok(QrAction.ScanAgain));
    
    private void SelectAction(QrAction action)
    {
        MudDialog.Close(DialogResult.Ok(action));
    }
}
