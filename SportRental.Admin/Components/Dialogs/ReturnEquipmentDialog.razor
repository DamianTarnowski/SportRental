@rendermode InteractiveServer
@using SportRental.Infrastructure.Data
@using SportRental.Infrastructure.Domain
@using Microsoft.EntityFrameworkCore

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@Icons.Material.Filled.Input" Color="Color.Primary" />
            <MudText Typo="Typo.h6">üì• Przyjƒôcie zwrotu</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="2">
            @* Info o kliencie *@
            <MudAlert Severity="Severity.Info" Dense="true" Class="pa-2">
                <div class="d-flex align-center gap-2">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                    <MudText Typo="Typo.body2" Style="font-weight: 600;">
                        @(Rental?.Customer?.FullName ?? "Nieznany klient")
                    </MudText>
                </div>
            </MudAlert>
            
            @* Lista produkt√≥w - kompaktowa *@
            <MudText Typo="Typo.caption" Style="font-weight: 600;">Produkty:</MudText>
            <MudStack Spacing="1">
                @if (Rental?.Items != null)
                {
                    @foreach (var item in Rental.Items)
                    {
                        <div class="d-flex align-center gap-2 pa-1" style="background: var(--mud-palette-background-grey); border-radius: 6px;">
                            <MudIcon Icon="@Icons.Material.Filled.SportsSoccer" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.body2">@(item.Product?.Name ?? "Produkt")</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">√ó@item.Quantity</MudChip>
                        </div>
                    }
                }
            </MudStack>
            
            @* Depozyt *@
            <MudAlert Severity="Severity.Warning" Dense="true" Class="pa-2">
                <div class="d-flex align-center justify-space-between">
                    <MudText Typo="Typo.body2">Depozyt pobrany:</MudText>
                    <MudText Typo="Typo.body2" Style="font-weight: 600;">@(Rental?.DepositAmount.ToString("0.00") ?? "0") z≈Ç</MudText>
                </div>
            </MudAlert>
            
            <MudGrid Spacing="2">
                <MudItem xs="6">
                    <MudNumericField @bind-Value="_depositRefund" 
                                     Label="Do zwrotu"
                                     Variant="Variant.Outlined"
                                     Adornment="Adornment.End"
                                     AdornmentText="z≈Ç"
                                     Min="0"
                                     Max="@(Rental?.DepositAmount ?? 0)"
                                     Dense="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudNumericField @bind-Value="_damageCharge" 
                                     Label="Za uszkodzenia"
                                     Variant="Variant.Outlined"
                                     Adornment="Adornment.End"
                                     AdornmentText="z≈Ç"
                                     Min="0"
                                     Dense="true" />
                </MudItem>
            </MudGrid>
            
            @* Stan sprzƒôtu *@
            <MudText Typo="Typo.caption" Style="font-weight: 600;">Stan sprzƒôtu:</MudText>
            <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                <MudChip T="string" 
                         Color="@(_equipmentCondition == "good" ? Color.Success : Color.Default)" 
                         Variant="@(_equipmentCondition == "good" ? Variant.Filled : Variant.Outlined)"
                         Size="Size.Small"
                         OnClick="SetConditionGood">
                    ‚úÖ Dobry
                </MudChip>
                <MudChip T="string" 
                         Color="@(_equipmentCondition == "minor" ? Color.Warning : Color.Default)" 
                         Variant="@(_equipmentCondition == "minor" ? Variant.Filled : Variant.Outlined)"
                         Size="Size.Small"
                         OnClick="SetConditionMinor">
                    ‚ö†Ô∏è Drobne
                </MudChip>
                <MudChip T="string" 
                         Color="@(_equipmentCondition == "damaged" ? Color.Error : Color.Default)" 
                         Variant="@(_equipmentCondition == "damaged" ? Variant.Filled : Variant.Outlined)"
                         Size="Size.Small"
                         OnClick="SetConditionDamaged">
                    ‚ùå Uszkodzony
                </MudChip>
            </MudStack>
            
            @* Uwagi *@
            <MudTextField @bind-Value="_returnNotes" 
                          Label="Uwagi (opcjonalne)"
                          Variant="Variant.Outlined"
                          Lines="2"
                          Dense="true"
                          Placeholder="Stan sprzƒôtu, uszkodzenia..." />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Size="Size.Small">Anuluj</MudButton>
        <MudButton OnClick="Submit" 
                   Variant="Variant.Filled" 
                   Color="Color.Primary"
                   Disabled="@(string.IsNullOrEmpty(_equipmentCondition) || _isProcessing)"
                   StartIcon="@Icons.Material.Filled.Check"
                   Size="Size.Small">
            @if (_isProcessing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
            }
            Potwierd≈∫
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance? MudDialog { get; set; }
    
    [Parameter]
    public Rental? Rental { get; set; }
    
    private string? _returnNotes;
    private decimal _depositRefund;
    private decimal _damageCharge;
    private string? _equipmentCondition;
    private bool _isProcessing;

    protected override void OnParametersSet()
    {
        _depositRefund = Rental?.DepositAmount ?? 0;
    }

    private void Cancel() => MudDialog?.Cancel();
    
    private void SetConditionGood() => _equipmentCondition = "good";
    private void SetConditionMinor() => _equipmentCondition = "minor";
    private void SetConditionDamaged() => _equipmentCondition = "damaged";

    private async Task Submit()
    {
        if (Rental == null || string.IsNullOrEmpty(_equipmentCondition)) return;
        
        _isProcessing = true;
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            var rental = await db.Rentals.FirstOrDefaultAsync(r => r.Id == Rental.Id);
            if (rental == null)
            {
                Snackbar.Add("Nie znaleziono wypo≈ºyczenia", Severity.Error);
                MudDialog?.Cancel();
                return;
            }
            
            rental.ReturnedAtUtc = DateTime.UtcNow;
            rental.ReturnNotes = _returnNotes;
            rental.ReturnDepositRefund = _depositRefund;
            rental.DamageCharge = _damageCharge > 0 ? _damageCharge : null;
            rental.Status = RentalStatus.Completed;
            
            var conditionText = _equipmentCondition switch
            {
                "good" => "Stan: dobry",
                "minor" => "Stan: drobne uszkodzenia",
                "damaged" => "Stan: powa≈ºne uszkodzenia",
                _ => ""
            };
            
            if (!string.IsNullOrEmpty(conditionText))
            {
                rental.ReturnNotes = string.IsNullOrEmpty(rental.ReturnNotes) 
                    ? conditionText 
                    : $"{conditionText}. {rental.ReturnNotes}";
            }
            
            await db.SaveChangesAsync();
            
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd: {ex.Message}", Severity.Error);
            MudDialog?.Cancel();
        }
        finally
        {
            _isProcessing = false;
        }
    }
}
