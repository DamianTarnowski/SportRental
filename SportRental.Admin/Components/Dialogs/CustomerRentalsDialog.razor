@using SportRental.Infrastructure.Domain
@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            @* Nag贸wek - kompaktowy *@
            <div class="d-flex align-center justify-space-between flex-wrap gap-1">
                <div>
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                         @CustomerName
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Default" Class="d-none d-sm-block">
                        Historia wypo偶ycze
                    </MudText>
                </div>
                <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">
                    @Rentals.Count wynajm贸w
                </MudChip>
            </div>

            @if (Rentals.Count == 0)
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    Brak wypo偶ycze dla tego klienta.
                </MudAlert>
            }
            else
            {
                <MudStack Spacing="1">
                    @foreach (var rental in Rentals.OrderByDescending(r => r.CreatedAtUtc))
                    {
                        <MudCard Elevation="2" Style="border-radius: 10px;">
                            <MudCardContent Class="pa-2">
                                @* Nag贸wek wynajmu *@
                                <div class="d-flex align-center justify-space-between flex-wrap gap-1 mb-1">
                                    <div class="d-flex align-center gap-1">
                                        <MudChip T="string" Color="@StatusColor(rental.Status)" Variant="Variant.Filled" Size="Size.Small">
                                            @StatusText(rental.Status)
                                        </MudChip>
                                        <MudText Typo="Typo.caption" Color="Color.Success" Style="font-weight: 600;">
                                            @rental.TotalAmount.ToString("0") z
                                        </MudText>
                                    </div>
                                    <MudText Typo="Typo.caption">
                                        @rental.StartDateUtc.ToLocalTime().ToString("dd.MM") - @rental.EndDateUtc.ToLocalTime().ToString("dd.MM.yy")
                                    </MudText>
                                </div>

                                @if (!string.IsNullOrWhiteSpace(rental.Notes))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Default" Class="mb-1" Style="font-style: italic;">
                                         @(rental.Notes.Length > 50 ? rental.Notes.Substring(0, 50) + "..." : rental.Notes)
                                    </MudText>
                                }

                                @* Pozycje - kompaktowe *@
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach (var item in rental.Items.Take(3))
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">
                                            @(item.Product?.Name ?? "?") @item.Quantity
                                        </MudChip>
                                    }
                                    @if (rental.Items.Count > 3)
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text">
                                            +@(rental.Items.Count - 3) wicej
                                        </MudChip>
                                    }
                                </div>
                            </MudCardContent>
                        </MudCard>
                    }
                </MudStack>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Close" Size="Size.Small">
            Zamknij
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Info"
                   StartIcon="@Icons.Material.Filled.OpenInNew"
                   OnClick="GoToRentalsPage"
                   Size="Size.Small">
            <span class="d-none d-sm-inline">Otw贸rz w wynajmach</span>
            <span class="d-sm-none">Wynajmy</span>
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public string CustomerName { get; set; } = string.Empty;
    [Parameter] public Guid CustomerId { get; set; }
    [Parameter] public List<Rental> Rentals { get; set; } = new();

    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private void Close() => MudDialog.Cancel();

    private void GoToRentalsPage()
    {
        MudDialog.Close();
        Navigation.NavigateTo($"/admin/rentals?customerId={CustomerId}");
    }

    private static string StatusText(RentalStatus status) => status switch
    {
        RentalStatus.Draft => "Szkic",
        RentalStatus.Pending => "Oczekuje",
        RentalStatus.Confirmed => "Potwierdz.",
        RentalStatus.Active => "Aktywne",
        RentalStatus.Completed => "Zakocz.",
        RentalStatus.Cancelled => "Anulowane",
        _ => status.ToString()
    };

    private static Color StatusColor(RentalStatus status) => status switch
    {
        RentalStatus.Draft => Color.Default,
        RentalStatus.Pending => Color.Warning,
        RentalStatus.Confirmed => Color.Primary,
        RentalStatus.Active => Color.Success,
        RentalStatus.Completed => Color.Success,
        RentalStatus.Cancelled => Color.Error,
        _ => Color.Default
    };
}
