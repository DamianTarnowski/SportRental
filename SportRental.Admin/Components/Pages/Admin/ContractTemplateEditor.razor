@page "/admin/contract-template"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Owner,SuperAdmin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject SportRental.Infrastructure.Tenancy.ITenantProvider TenantProvider
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-6 mb-4" Elevation="4" Style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; border-radius: 20px;">
        <MudStack Row="true" Class="mud-align-center" Spacing="3">
            <MudAvatar Size="Size.Large" Style="background: rgba(255,255,255,0.2);">
                <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Large" />
            </MudAvatar>
            <div>
                <MudText Typo="Typo.h4" Style="font-weight: 700;">Szablon umowy</MudText>
                <MudText Typo="Typo.subtitle1" Style="opacity: 0.9;">Dostosuj treÅ›Ä‡ umowy wypoÅ¼yczenia</MudText>
            </div>
        </MudStack>
    </MudPaper>

    <MudGrid Spacing="4">
        <MudItem xs="12" md="8">
            <MudCard Elevation="4" Style="border-radius: 16px;">
                <MudCardContent Class="pa-5">
                    <MudStack Spacing="4">
                        <MudStack Row="true" Class="mud-align-center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" />
                            <MudText Typo="Typo.h6" Style="font-weight: 600;">Edytor szablonu</MudText>
                        </MudStack>

                        <MudTextField @bind-Value="content" 
                                      Lines="20" 
                                      FullWidth="true" 
                                      Label="TreÅ›Ä‡ szablonu umowy"
                                      Variant="Variant.Outlined"
                                      Class="rounded-lg"
                                      Style="font-family: 'Consolas', 'Monaco', monospace; font-size: 14px;" />

                        <MudStack Row="true" Spacing="2" Class="mt-4">
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.Save"
                                       OnClick="Save"
                                       Size="Size.Large"
                                       Class="rounded-pill px-6">
                                ğŸ’¾ Zapisz szablon
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Warning"
                                       StartIcon="@Icons.Material.Filled.Refresh"
                                       OnClick="ResetDefault"
                                       Class="rounded-pill">
                                PrzywrÃ³Ä‡ domyÅ›lny
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudStack Spacing="3">
                @* DOSTÄ˜PNE ZMIENNE *@
                <MudCard Elevation="4" Style="border-radius: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <MudCardContent Class="pa-5">
                        <MudStack Spacing="3">
                            <MudStack Row="true" Class="mud-align-center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Code" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">DostÄ™pne zmienne</MudText>
                            </MudStack>
                            <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                                Kliknij na zmiennÄ…, aby skopiowaÄ‡ do schowka
                            </MudText>
                            <MudStack Spacing="2">
                                @foreach (var variable in availableVariables)
                                {
                                    <MudButton Variant="Variant.Filled" 
                                               FullWidth="true"
                                               Style="background: rgba(255,255,255,0.15); color: white; text-transform: none; justify-content: flex-start;"
                                               StartIcon="@Icons.Material.Filled.ContentCopy"
                                               OnClick="() => CopyVariable(variable.Key)"
                                               Class="rounded-lg">
                                        <MudStack Spacing="0" Class="text-left">
                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@variable.Key</MudText>
                                            <MudText Typo="Typo.caption" Style="opacity: 0.8;">@variable.Value</MudText>
                                        </MudStack>
                                    </MudButton>
                                }
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                @* WSKAZÃ“WKI *@
                <MudCard Elevation="2" Style="border-radius: 16px;">
                    <MudCardContent Class="pa-4">
                        <MudStack Spacing="2">
                            <MudStack Row="true" Class="mud-align-center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Color="Color.Warning" />
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">WskazÃ³wki</MudText>
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Default">
                                â€¢ Zmienne w formacie <code>@("{{Zmienna}}")</code> zostanÄ… automatycznie zastÄ…pione danymi<br/>
                                â€¢ Szablon jest uÅ¼ywany przy generowaniu PDF umowy<br/>
                                â€¢ MoÅ¼esz uÅ¼yÄ‡ znacznikÃ³w HTML dla formatowania<br/>
                                â€¢ Dane firmy sÄ… pobierane z ustawieÅ„
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                @* PODGLÄ„D *@
                <MudCard Elevation="2" Style="border-radius: 16px;">
                    <MudCardContent Class="pa-4">
                        <MudStack Spacing="2">
                            <MudStack Row="true" Class="mud-align-center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Preview" Color="Color.Info" />
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">PrzykÅ‚adowe dane</MudText>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Default">
                                <strong>Klient:</strong> Jan Kowalski<br/>
                                <strong>Dokument:</strong> ABC123456<br/>
                                <strong>Okres:</strong> 15.12.2025 - 22.12.2025<br/>
                                <strong>Produkt:</strong> Narty Atomic Pro (2 szt.)<br/>
                                <strong>Kwota:</strong> 840.00 zÅ‚
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private string content = "";
    private Guid TenantId => TenantProvider.GetCurrentTenantId() ?? Guid.Empty;

    private readonly Dictionary<string, string> availableVariables = new()
    {
        { "{{CustomerName}}", "ImiÄ™ i nazwisko klienta" },
        { "{{CustomerDocument}}", "Numer dokumentu klienta" },
        { "{{CustomerPhone}}", "Telefon klienta" },
        { "{{CustomerEmail}}", "Email klienta" },
        { "{{CustomerAddress}}", "Adres klienta" },
        { "{{StartDate}}", "Data rozpoczÄ™cia wynajmu" },
        { "{{EndDate}}", "Data zakoÅ„czenia wynajmu" },
        { "{{RentalDays}}", "Liczba dni wynajmu" },
        { "{{ItemsTable}}", "Tabela z produktami" },
        { "{{Total}}", "Suma do zapÅ‚aty" },
        { "{{Deposit}}", "Kwota kaucji" },
        { "{{CompanyName}}", "Nazwa wypoÅ¼yczalni" },
        { "{{CompanyAddress}}", "Adres wypoÅ¼yczalni" },
        { "{{CompanyNIP}}", "NIP wypoÅ¼yczalni" },
        { "{{CompanyPhone}}", "Telefon wypoÅ¼yczalni" },
        { "{{CurrentDate}}", "Aktualna data" },
        { "{{RentalId}}", "Numer rezerwacji" }
    };

    [Inject] private IJSRuntime JS { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(TenantId);
        var tpl = await Db.ContractTemplates.FirstOrDefaultAsync(ct => ct.TenantId == TenantId);
        if (tpl == null)
        {
            content = DefaultTemplate();
        }
        else
        {
            content = tpl.Content;
        }
    }

    private async Task Save()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(TenantId);
        var tpl = await Db.ContractTemplates.FirstOrDefaultAsync(ct => ct.TenantId == TenantId);
        if (tpl == null)
        {
            tpl = new ContractTemplate { Id = Guid.NewGuid(), TenantId = TenantId, Content = content };
            await Db.ContractTemplates.AddAsync(tpl);
        }
        else
        {
            tpl.Content = content;
            tpl.UpdatedAtUtc = DateTime.UtcNow;
            Db.ContractTemplates.Update(tpl);
        }
        await Db.SaveChangesAsync();
        Snackbar.Add("âœ… Szablon zostaÅ‚ zapisany", MudBlazor.Severity.Success);
    }

    private void ResetDefault()
    {
        content = DefaultTemplate();
        Snackbar.Add("ğŸ”„ PrzywrÃ³cono domyÅ›lny szablon", MudBlazor.Severity.Info);
    }

    private async Task CopyVariable(string variable)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", variable);
        Snackbar.Add($"ğŸ“‹ Skopiowano: {variable}", MudBlazor.Severity.Success);
    }

    private static string DefaultTemplate() => @"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    UMOWA WYPOÅ»YCZENIA SPRZÄ˜TU SPORTOWEGO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Nr rezerwacji: {{RentalId}}
Data zawarcia: {{CurrentDate}}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                         STRONY UMOWY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

WYPOÅ»YCZAJÄ„CY:
  {{CompanyName}}
  {{CompanyAddress}}
  NIP: {{CompanyNIP}}
  Tel: {{CompanyPhone}}

NAJEMCA:
  {{CustomerName}}
  Dokument toÅ¼samoÅ›ci: {{CustomerDocument}}
  Adres: {{CustomerAddress}}
  Telefon: {{CustomerPhone}}
  Email: {{CustomerEmail}}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                      OKRES WYPOÅ»YCZENIA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Data wydania sprzÄ™tu:    {{StartDate}}
  Data zwrotu sprzÄ™tu:     {{EndDate}}
  Liczba dni wypoÅ¼yczenia: {{RentalDays}}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                     WYPOÅ»YCZONY SPRZÄ˜T
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{{ItemsTable}}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                      PÅATNOÅšCI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  CaÅ‚kowita wartoÅ›Ä‡ wypoÅ¼yczenia:  {{Total}} zÅ‚
  Kaucja zwrotna:                  {{Deposit}} zÅ‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                      WARUNKI UMOWY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Najemca zobowiÄ…zuje siÄ™ do zwrotu sprzÄ™tu w stanie niepogorszonym.
2. W przypadku uszkodzenia lub zagubienia sprzÄ™tu, Najemca ponosi 
   peÅ‚nÄ… odpowiedzialnoÅ›Ä‡ finansowÄ….
3. Kaucja zostanie zwrÃ³cona po pozytywnej weryfikacji stanu sprzÄ™tu.
4. PrzedÅ‚uÅ¼enie okresu wypoÅ¼yczenia wymaga wczeÅ›niejszego uzgodnienia.
5. Najemca oÅ›wiadcza, Å¼e posiada umiejÄ™tnoÅ›ci do bezpiecznego 
   uÅ¼ytkowania wypoÅ¼yczonego sprzÄ™tu.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                         PODPISY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


_________________________          _________________________
       WypoÅ¼yczajÄ…cy                        Najemca
       ({{CompanyName}})                    ({{CustomerName}})


DziÄ™kujemy za skorzystanie z naszych usÅ‚ug!
Å»yczymy udanego wypoczynku! ğŸ¿â›·ï¸ğŸ‚
";
}
