@page "/admin/rentals"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@attribute [Authorize(Roles = "Owner,SuperAdmin,Employee")]

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject SportRental.Admin.Services.Sms.ISmsSender SmsSender
@inject SportRental.Admin.Services.Sms.ISmsConfirmationService SmsConfirmationService
@inject ILogger<Rentals> Logger
@if (_isMobile)
{
    @* ==================== MOBILE UI ==================== *@
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-2 px-2">
        @* Nag≈Ç√≥wek mobilny *@
        <MudPaper Class="pa-3 mb-2" Elevation="2" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
            <div class="d-flex align-center justify-space-between">
                <MudText Typo="Typo.h6" Style="font-weight: 700;">üìã Wynajmy</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Add" 
                               Color="Color.Inherit" 
                               OnClick="CreateNew" />
            </div>
        </MudPaper>

        @* Wyszukiwarka mobilna *@
        <MudTextField @bind-Value="searchTerm"
                      Placeholder="Szukaj..." 
                      Immediate="true" 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" 
                      Clearable="true"
                      Variant="Variant.Outlined"
                      Dense="true"
                      Class="mb-2" />
        
        @* Filtry mobilne *@
        <div class="d-flex gap-1 mb-2 flex-wrap">
            <MudChip T="string" 
                     Color="@(cbStarted ? Color.Success : Color.Default)" 
                     Variant="@(cbStarted ? Variant.Filled : Variant.Outlined)"
                     Size="Size.Small"
                     OnClick="() => cbStarted = !cbStarted">
                Aktywne
            </MudChip>
            <MudChip T="string" 
                     Color="@(cbEnded ? Color.Warning : Color.Default)" 
                     Variant="@(cbEnded ? Variant.Filled : Variant.Outlined)"
                     Size="Size.Small"
                     OnClick="() => cbEnded = !cbEnded">
                Zako≈Ñczone
            </MudChip>
            <MudChip T="string" 
                     Color="@(cbIncoming ? Color.Info : Color.Default)" 
                     Variant="@(cbIncoming ? Variant.Filled : Variant.Outlined)"
                     Size="Size.Small"
                     OnClick="() => cbIncoming = !cbIncoming">
                NadchodzƒÖce
            </MudChip>
        </div>

        @if (!filteredRentals.Any())
        {
            <MudAlert Severity="Severity.Info" Dense="true">Brak wynajm√≥w</MudAlert>
        }
        else
        {
            @* Lista wynajm√≥w mobilna *@
            <MudStack Spacing="1">
                @foreach (var rental in filteredRentals)
                {
                    <MudCard Elevation="2" Style="@($"border-radius: 10px; border-left: 3px solid {GetStatusColorHex(rental.Status)};")">
                        <MudCardContent Class="pa-2">
                            <div class="d-flex align-center gap-2">
                                <MudAvatar Color="@GetStatusColor(rental.Status)" Size="Size.Medium">
                                    <MudIcon Icon="@GetStatusIcon(rental.Status)" Size="Size.Small" />
                                </MudAvatar>
                                <div class="flex-1 overflow-hidden">
                                    <MudText Typo="Typo.body2" Style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        @(customersDict.GetValueOrDefault(rental.CustomerId)?.FullName ?? "‚Äî")
                                    </MudText>
                                    <div class="d-flex align-center gap-1 flex-wrap">
                                        <MudText Typo="Typo.caption" Color="Color.Success" Style="font-weight: 600;">
                                            @rental.TotalAmount.ToString("0") z≈Ç
                                        </MudText>
                                        <MudText Typo="Typo.caption">‚Ä¢</MudText>
                                        <MudText Typo="Typo.caption">
                                            @rental.StartDateUtc.ToLocalTime().ToString("dd.MM") - @rental.EndDateUtc.ToLocalTime().ToString("dd.MM")
                                        </MudText>
                                    </div>
                                </div>
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                                    <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="() => Edit(rental)">Edytuj</MudMenuItem>
                                    @if (!string.IsNullOrWhiteSpace(rental.ContractUrl))
                                    {
                                        <MudMenuItem Icon="@Icons.Material.Filled.Description" Href="@rental.ContractUrl" Target="_blank">Umowa</MudMenuItem>
                                    }
                                    <MudMenuItem Icon="@Icons.Material.Filled.Email" OnClick="() => SendContractByEmail(rental)">Email</MudMenuItem>
                                    @if (rental.Status == RentalStatus.Active || rental.Status == RentalStatus.Confirmed)
                                    {
                                        <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle" OnClick="() => CompleteRental(rental)">Zako≈Ñcz</MudMenuItem>
                                    }
                                    <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="() => Delete(rental)">Usu≈Ñ</MudMenuItem>
                                </MudMenu>
                            </div>
                            @if (IsOverdue(rental))
                            {
                                <MudChip T="string" Color="Color.Error" Size="Size.Small" Class="mt-1">
                                    ‚ö†Ô∏è Przeterminowany (@GetOverdueDays(rental) dni)
                                </MudChip>
                            }
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }
    </MudContainer>
}
else
{
    @* ==================== DESKTOP UI ==================== *@
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        <MudPaper Class="pa-6 mb-4" Elevation="4" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px;">
            <MudStack Row="true" Class="mud-space-between">
                <MudStack Row="true" Class="mud-align-center" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" />
                    <div>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;">Wynajmy</MudText>
                        <MudText Typo="Typo.subtitle1" Style="opacity: 0.9;">ZarzƒÖdzaj wypo≈ºyczeniami sprzƒôtu sportowego</MudText>
                    </div>
                </MudStack>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Surface" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="CreateNew"
                           Size="Size.Large"
                           Class="rounded-pill px-6">
                    Nowy wynajem
                </MudButton>
            </MudStack>
        </MudPaper>

        @if (!string.IsNullOrWhiteSpace(CustomerId) && Guid.TryParse(CustomerId, out var customerGuid))
        {
            var customerName = customersDict.GetValueOrDefault(customerGuid)?.FullName ?? "Nieznany klient";
            <MudAlert Severity="Severity.Info" Class="mb-4" Elevation="2" Style="border-radius: 12px;">
                <div Class="d-flex align-center justify-space-between">
                    <div Class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Class="mr-2" />
                        <MudText>Wy≈õwietlane wynajmy dla klienta: <strong>@customerName</strong></MudText>
                    </div>
                    <MudButton Href="/admin/rentals" 
                               Size="Size.Small" 
                               Variant="Variant.Outlined" 
                               StartIcon="@Icons.Material.Filled.Clear"
                               Class="rounded-pill">
                        Poka≈º wszystkie
                    </MudButton>
                </div>
            </MudAlert>
        }
        
        @if (!string.IsNullOrEmpty(loadError))
        {
            <MudAlert Severity="Severity.Error" Elevation="0" Class="mb-4">
                @loadError
            </MudAlert>
        }

        <MudCard Elevation="4" Class="mb-4" Style="border-radius: 16px;">
            <MudCardContent Class="pa-4">
                <MudGrid Class="mud-align-end" Spacing="3">
                    <MudItem xs="12" md="4">
                        <MudTextField 
                            @bind-Value="searchTerm"
                            Placeholder="Wyszukaj wynajem..." 
                            Immediate="true" 
                            Adornment="Adornment.Start" 
                            AdornmentIcon="@Icons.Material.Filled.Search" 
                            Clearable="true"
                            Variant="Variant.Outlined"
                            Class="rounded-lg" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudStack Row="true" Spacing="4" Class="mud-align-center">
                            <MudSwitch @bind-Value="cbStarted" 
                                       Label="Rozpoczƒôte" 
                                       Color="Color.Success"
                                       ThumbIcon="@Icons.Material.Filled.PlayArrow" />
                            <MudSwitch @bind-Value="cbEnded" 
                                       Label="Zako≈Ñczone" 
                                       Color="Color.Warning"
                                       ThumbIcon="@Icons.Material.Filled.CheckCircle" />
                            <MudSwitch @bind-Value="cbIncoming" 
                                       Label="NadchodzƒÖce" 
                                       Color="Color.Info"
                                       ThumbIcon="@Icons.Material.Filled.Schedule" />
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" md="2">
                        <MudTooltip Text="Od≈õwie≈º listƒô wynajm√≥w">
                            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                           Color="Color.Primary" 
                                           OnClick="RefreshRentals"
                                           Size="Size.Large" />
                        </MudTooltip>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>
        
        @if (!filteredRentals.Any())
        {
            <MudAlert Severity="Severity.Info">Brak wynajm√≥w do wy≈õwietlenia</MudAlert>
        }
        else
        {
            <MudStack Spacing="3">
                @foreach (var rental in filteredRentals)
                {
                    <MudCard Elevation="6" Class="@GetRentalCardClass(rental)" Style="@GetRentalCardStyle(rental)">
                        <MudCardContent Class="pa-5">
                            <MudGrid Spacing="3" Class="mud-align-center">
                                <MudItem xs="12" md="8">
                                    <MudStack Spacing="2">
                                        <div Class="d-flex align-center mb-2">
                                            <MudAvatar Color="@GetStatusColor(rental.Status)" Size="Size.Large" Class="mr-3">
                                                <MudIcon Icon="@GetStatusIcon(rental.Status)" />
                                            </MudAvatar>
                                            <div>
                                                <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                                    @GetRentalTitle(rental)
                                                </MudText>
                                                <MudText Typo="Typo.body2" Color="Color.Default">
                                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" />
                                                    @(customersDict.GetValueOrDefault(rental.CustomerId)?.FullName ?? "brak")
                                                </MudText>
                                            </div>
                                        </div>
                                        
                                        <MudGrid Spacing="2">
                                            <MudItem xs="12" sm="6">
                                                <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                                                    <MudStack Row="true" Class="mud-align-center" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" />
                                                        <div>
                                                            <MudText Typo="Typo.caption" Color="Color.Default">PoczƒÖtek</MudText>
                                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                                                @rental.StartDateUtc.ToLocalTime().ToString("dd.MM HH:mm")
                                                            </MudText>
                                                        </div>
                                                    </MudStack>
                                                </MudPaper>
                                            </MudItem>
                                            <MudItem xs="12" sm="6">
                                                <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%);">
                                                    <MudStack Row="true" Class="mud-align-center" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.Stop" Color="Color.Warning" />
                                                        <div>
                                                            <MudText Typo="Typo.caption" Color="Color.Default">Koniec</MudText>
                                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                                                @rental.EndDateUtc.ToLocalTime().ToString("dd.MM HH:mm")
                                                            </MudText>
                                                        </div>
                                                    </MudStack>
                                                </MudPaper>
                                            </MudItem>
                                        </MudGrid>

                                        <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                                            <MudChip T="string" Icon="@Icons.Material.Filled.AttachMoney" 
                                                     Color="Color.Success" 
                                                     Variant="Variant.Filled"
                                                     Size="Size.Small">
                                                @rental.TotalAmount.ToString("0.00") z≈Ç
                                            </MudChip>
                                            <MudChip T="string" Icon="@GetStatusIcon(rental.Status)" 
                                                     Color="@GetStatusColor(rental.Status)" 
                                                     Variant="Variant.Text"
                                                     Size="Size.Small">
                                                @GetStatusText(rental.Status)
                                            </MudChip>
                                            <MudChip T="string" Icon="@Icons.Material.Filled.Email" 
                                                     Color="@(rental.IsEmailSent ? Color.Success : Color.Default)" 
                                                     Variant="Variant.Text"
                                                     Size="Size.Small">
                                                Email: @(rental.IsEmailSent ? "‚úì" : "‚úó")
                                            </MudChip>
                                            <MudChip T="string" Icon="@GetSourceIcon(rental.Source)" 
                                                     Color="@GetSourceColor(rental.Source)" 
                                                     Variant="Variant.Text"
                                                     Size="Size.Small">
                                                @GetSourceText(rental.Source)
                                            </MudChip>
                                            <MudChip T="string" Icon="@GetEquipmentStatusIcon(rental)" 
                                                     Color="@GetEquipmentStatusColor(rental)" 
                                                     Variant="Variant.Filled"
                                                     Size="Size.Small">
                                                @GetEquipmentStatusText(rental)
                                            </MudChip>
                                            @if (IsOverdue(rental))
                                            {
                                                <MudChip T="string" Icon="@Icons.Material.Filled.Warning" 
                                                         Color="Color.Error" 
                                                         Variant="Variant.Filled"
                                                         Size="Size.Small">
                                                    PRZETERMINOWANE (@GetOverdueDays(rental) dni)
                                                </MudChip>
                                            }
                                        </MudStack>

                                        @if (!string.IsNullOrEmpty(rental.Notes))
                                        {
                                            <MudAlert Severity="Severity.Info" Dense="true" NoIcon="true" Class="mt-2">
                                                <MudText Typo="Typo.caption">
                                                    <MudIcon Icon="@Icons.Material.Filled.StickyNote2" Size="Size.Small" Class="mr-1" />
                                                    @rental.Notes
                                                </MudText>
                                            </MudAlert>
                                        }
                                    </MudStack>
                                </MudItem>
                                
                                <MudItem xs="12" md="4">
                                    <MudStack Spacing="2">
                                        <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary" OverrideStyles="false">
                                            <MudButton StartIcon="@Icons.Material.Filled.Edit" 
                                                       OnClick="() => Edit(rental)"
                                                       Size="Size.Small">
                                                Edytuj
                                            </MudButton>
                                            <MudButton StartIcon="@Icons.Material.Filled.Delete" 
                                                       OnClick="() => Delete(rental)"
                                                       Color="Color.Error"
                                                       Size="Size.Small">
                                                Usu≈Ñ
                                            </MudButton>
                                        </MudButtonGroup>
                                        
                                        <MudButtonGroup Variant="Variant.Outlined" Color="Color.Secondary" OverrideStyles="false">
                                            @if (!string.IsNullOrWhiteSpace(rental.ContractUrl))
                                            {
                                                <MudButton StartIcon="@Icons.Material.Filled.Description" 
                                                           Href="@rental.ContractUrl" 
                                                           Target="_blank"
                                                           Size="Size.Small">
                                                    Umowa
                                                </MudButton>
                                            }
                                            <MudButton StartIcon="@Icons.Material.Filled.FileDownload" 
                                                       OnClick="() => GenerateContract(rental)"
                                                       Size="Size.Small">
                                                Generuj
                                            </MudButton>
                                            <MudButton StartIcon="@Icons.Material.Filled.Email" 
                                                       OnClick="() => SendContractByEmail(rental)"
                                                       Size="Size.Small">
                                                Email
                                            </MudButton>
                                        </MudButtonGroup>
                                        
                                        <MudStack Row="true" Spacing="1">
                                            @if (rental.Status == RentalStatus.Active || rental.Status == RentalStatus.Confirmed)
                                            {
                                                <MudButton StartIcon="@Icons.Material.Filled.CheckCircle" 
                                                           OnClick="() => CompleteRental(rental)"
                                                           Color="Color.Success"
                                                           Variant="Variant.Filled"
                                                           Size="Size.Small"
                                                           Class="flex-1">
                                                    Zako≈Ñcz
                                                </MudButton>
                                            }
                                        </MudStack>
                                        @if (IsOverdue(rental))
                                        {
                                            <MudButton StartIcon="@Icons.Material.Filled.Update" 
                                                       OnClick="() => ExtendRental(rental)"
                                                       Color="Color.Error"
                                                       Variant="Variant.Filled"
                                                       FullWidth="true"
                                                       Size="Size.Small">
                                                ‚ö†Ô∏è Przed≈Çu≈º wynajem
                                            </MudButton>
                                        }
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }
    </MudContainer>
}

@* ==================== DIALOG (wsp√≥lny) ==================== *@
<MudDialog @bind-Visible="dialogOpen" Options="@rentalDialogOptions">
    <TitleContent>
        <MudStack Row="true" Class="mud-align-center" Spacing="3">
            <MudAvatar Color="Color.Primary" Size="Size.Large" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" />
            </MudAvatar>
            <div>
                <MudText Typo="Typo.h5" Style="font-weight: 700;">@(editModel.Id == Guid.Empty ? "Nowy wynajem" : "Edytuj wynajem")</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Wype≈Çnij dane wynajmu sprzƒôtu</MudText>
            </div>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4" Class="pa-2">
            @* SEKCJA: KLIENT I DATY *@
            <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 16px; background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);">
                <MudStack Spacing="3">
                    <MudStack Row="true" Class="mud-align-center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" />
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Dane podstawowe</MudText>
                    </MudStack>
                    
                    <MudAutocomplete T="Customer"
                                     Label="Wybierz klienta"
                                     Placeholder="Zacznij pisaƒá imiƒô lub email..."
                                     Value="@(customers.FirstOrDefault(c => c.Id == editModel.CustomerId))"
                                     ValueChanged="@(c => { if (c != null) editModel.CustomerId = c.Id; })"
                                     SearchFunc="@((string s, CancellationToken ct) => Task.FromResult(customers.Where(c => string.IsNullOrWhiteSpace(s) || (c.FullName?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false) || (c.Email?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false))))"
                                     ToStringFunc="@(c => c?.FullName ?? "")"
                                     Variant="Variant.Outlined"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.PersonSearch"
                                     Class="rounded-lg">
                        <ItemTemplate>
                            <MudStack Row="true" Spacing="2" Class="mud-align-center pa-1">
                                <MudAvatar Color="Color.Primary" Size="Size.Small">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body1">@context.FullName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                        @(context.Email ?? context.PhoneNumber ?? "brak kontaktu")
                                    </MudText>
                                </div>
                            </MudStack>
                        </ItemTemplate>
                    </MudAutocomplete>
                    
                    <MudGrid Spacing="3">
                        <MudItem xs="12" md="6">
                            <MudDatePicker Date="@startDate" 
                                           DateChanged="OnStartDateChanged" 
                                           Label="üìÖ Data rozpoczƒôcia"
                                           Variant="Variant.Outlined"
                                           Editable="true"
                                           DateFormat="dd.MM.yyyy"
                                           Class="rounded-lg" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudDatePicker Date="@endDate" 
                                           DateChanged="OnEndDateChanged" 
                                           Label="üìÖ Data zako≈Ñczenia"
                                           Variant="Variant.Outlined"
                                           Editable="true"
                                           DateFormat="dd.MM.yyyy"
                                           Class="rounded-lg" />
                        </MudItem>
                    </MudGrid>
                    
                    <MudGrid Spacing="3">
                        <MudItem xs="12" md="6">
                            <MudSelect T="RentalType" @bind-Value="editModel.RentalType" 
                                       Label="Typ wynajmu"
                                       Variant="Variant.Outlined"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.AccessTime"
                                       Class="rounded-lg">
                                <MudSelectItem Value="RentalType.Daily">üìÖ Dzienny</MudSelectItem>
                                <MudSelectItem Value="RentalType.Hourly">‚è∞ Godzinowy</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        @if (editModel.RentalType == RentalType.Hourly)
                        {
                            <MudItem xs="12" md="6">
                                <MudNumericField T="int?" @bind-Value="editModel.HoursRented" 
                                                  Label="Liczba godzin"
                                                  Min="1"
                                                  Max="24"
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.End"
                                                  AdornmentText="godz."
                                                  Class="rounded-lg" />
                            </MudItem>
                        }
                    </MudGrid>
                    
                    @if (startDate.HasValue && endDate.HasValue)
                    {
                        @if (editModel.RentalType == RentalType.Hourly && editModel.HoursRented.HasValue)
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" NoIcon="true" Class="rounded-lg">
                                <MudStack Row="true" Class="mud-align-center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">Czas trwania: <strong>@editModel.HoursRented.Value godzin</strong></MudText>
                                </MudStack>
                            </MudAlert>
                        }
                        else
                        {
                            var days = Math.Max(1, (int)Math.Ceiling((endDate.Value - startDate.Value).TotalDays));
                            <MudAlert Severity="Severity.Info" Dense="true" NoIcon="true" Class="rounded-lg">
                                <MudStack Row="true" Class="mud-align-center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">Czas trwania: <strong>@days dni</strong></MudText>
                                </MudStack>
                            </MudAlert>
                        }
                    }
                </MudStack>
            </MudPaper>

            @* SEKCJA: DODAWANIE PRODUKT√ìW *@
            <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                <MudStack Spacing="3">
                    <MudStack Row="true" Class="mud-align-center mud-justify-space-between">
                        <MudStack Row="true" Class="mud-align-center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Color="Color.Success" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Dodaj sprzƒôt</MudText>
                        </MudStack>
                        <MudChip T="string" Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">
                            @editItems.Count pozycji
                        </MudChip>
                    </MudStack>
                    
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudAutocomplete T="Product"
                                              Label="Wyszukaj produkt"
                                              Placeholder="Nazwa, SKU lub kategoria..."
                                              Adornment="Adornment.Start" 
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              Variant="Variant.Outlined"
                                              Value="@selectedProduct"
                                              ValueChanged="@(p => selectedProduct = p)"
                                              SearchFunc="SearchProducts"
                                              ToStringFunc="@(p => p is null ? string.Empty : $"{p.Name}")"
                                              Class="rounded-lg">
                                <ItemTemplate>
                                    <MudStack Row="true" Spacing="2" Class="mud-align-center pa-1">
                                        @if (!string.IsNullOrWhiteSpace(context.ImageUrl))
                                        {
                                            <MudAvatar Size="Size.Medium" Style="border-radius: 8px;">
                                                <MudImage Src="@context.ImageUrl" Alt="@context.Name" />
                                            </MudAvatar>
                                        }
                                        else
                                        {
                                            <MudAvatar Color="Color.Default" Size="Size.Medium">
                                                <MudIcon Icon="@Icons.Material.Filled.SportsTennis" />
                                            </MudAvatar>
                                        }
                                        <div class="flex-1">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">@context.Name</MudText>
                                            <MudStack Row="true" Spacing="1" Class="mud-align-center">
                                                <MudText Typo="Typo.caption" Color="Color.Default">@context.Sku</MudText>
                                                <MudText Typo="Typo.caption">‚Ä¢</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Success" Style="font-weight: 600;">@context.DailyPrice.ToString("0.00") z≈Ç/dzie≈Ñ</MudText>
                                                <MudText Typo="Typo.caption">‚Ä¢</MudText>
                                                <MudChip T="string" Size="Size.Small" Color="@(GetAvail(context.Id) > 0 ? Color.Success : Color.Error)" Variant="Variant.Text">
                                                    @GetAvail(context.Id) szt.
                                                </MudChip>
                                            </MudStack>
                                        </div>
                                    </MudStack>
                                </ItemTemplate>
                            </MudAutocomplete>
                        </MudItem>
                        <MudItem xs="6" md="2">
                            <MudNumericField T="int" @bind-Value="selectedQty" 
                                              Label="Ilo≈õƒá" 
                                              Min="1" 
                                              Max="@CurrentAvail"
                                              Variant="Variant.Outlined"
                                              Class="rounded-lg" />
                        </MudItem>
                        <MudItem xs="6" md="2">
                            <MudStack Class="h-100 mud-justify-center">
                                <MudChip T="string" Color="@(CurrentAvail > 0 ? Color.Success : Color.Error)" 
                                         Variant="Variant.Outlined" 
                                         Style="height: 40px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Warehouse" Size="Size.Small" Class="mr-1" />
                                    @CurrentAvail dostƒôpne
                                </MudChip>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" md="2">
                            <MudButton FullWidth="true" 
                                       Variant="Variant.Filled" 
                                       Color="Color.Success"
                                       StartIcon="@Icons.Material.Filled.Add" 
                                       Disabled="@(selectedProduct is null || CurrentAvail == 0)" 
                                       OnClick="AddSelectedProduct"
                                       Style="height: 56px;"
                                       Class="rounded-lg">
                                Dodaj
                            </MudButton>
                        </MudItem>
                    </MudGrid>

                    @* Szybkie dodawanie po SKU *@
                    <MudExpansionPanels Elevation="0">
                        <MudExpansionPanel Text="‚ö° Szybkie dodawanie po SKU / kamerƒÖ" Style="background: transparent;">
                            <MudGrid Spacing="2">
                                <MudItem xs="12" md="5">
                                    <MudTextField @bind-Value="skuInput" 
                                                  Label="Kod SKU" 
                                                  Placeholder="Wpisz lub zeskanuj..." 
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.QrCode"
                                                  Class="rounded-lg" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudNumericField T="int" @bind-Value="skuQty" Label="Ilo≈õƒá" Min="1" Variant="Variant.Outlined" Class="rounded-lg" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudButton FullWidth="true" 
                                               Variant="Variant.Outlined" 
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Add" 
                                               OnClick="AddItemBySku"
                                               Style="height: 56px;"
                                               Class="rounded-lg">
                                        Dodaj
                                    </MudButton>
                                </MudItem>
                                <MudItem xs="12" md="3">
                                    <MudStack Row="true" Spacing="1">
                                        @if (!_scannerActive)
                                        {
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="StartScanner" StartIcon="@Icons.Material.Filled.CameraAlt">Kamera</MudButton>
                                        }
                                        else
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small" OnClick="StopScanner" StartIcon="@Icons.Material.Filled.Stop">Stop</MudButton>
                                        }
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                            <MudPaper Elevation="2" Class="pa-3 mt-3" Style="@GetScannerContainerStyle()">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.Videocam" Size="Size.Small" Class="mr-1" />
                                        Skieruj kamerƒô na kod QR produktu
                                    </MudText>
                                    <video id="videoScanner" width="100%" height="200" autoplay muted playsinline style="border-radius:8px; border:2px solid #4caf50; max-width: 300px;"></video>
                                </MudStack>
                            </MudPaper>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudStack>
            </MudPaper>

            @* SEKCJA: LISTA PRODUKT√ìW *@
            @if (editItems.Any())
            {
                <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 16px; border: 1px solid #e0e0e0;">
                    <MudStack Spacing="3">
                        <MudStack Row="true" Class="mud-align-center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.ListAlt" Color="Color.Primary" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Koszyk (@editItems.Count)</MudText>
                        </MudStack>

                        <MudTable Items="editItems" Dense="true" Hover="true" Elevation="0" Class="rounded-lg">
                            <HeaderContent>
                                <MudTh Style="font-weight: 600;">Produkt</MudTh>
                                <MudTh Style="font-weight: 600; text-align: center;">Ilo≈õƒá</MudTh>
                                <MudTh Style="font-weight: 600; text-align: right;">Cena/dzie≈Ñ</MudTh>
                                <MudTh Style="font-weight: 600; text-align: right;">Suma</MudTh>
                                <MudTh Style="width: 50px;"></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>
                                    <MudStack Row="true" Spacing="2" Class="mud-align-center">
                                        <MudAvatar Size="Size.Small" Color="Color.Default">
                                            <MudIcon Icon="@Icons.Material.Filled.SportsTennis" Size="Size.Small" />
                                        </MudAvatar>
                                        <MudText>@(products.FirstOrDefault(p => p.Id == context.ProductId)?.Name ?? "‚Äî")</MudText>
                                    </MudStack>
                                </MudTd>
                                <MudTd Style="text-align: center;">
                                    <MudNumericField T="int" @bind-Value="context.Quantity" Min="1" Variant="Variant.Text" Style="width: 60px; text-align: center;" />
                                </MudTd>
                                <MudTd Style="text-align: right;">
                                    <MudText Color="Color.Default">@context.PricePerDay.ToString("0.00") z≈Ç</MudText>
                                </MudTd>
                                <MudTd Style="text-align: right;">
                                    <MudText Color="Color.Success" Style="font-weight: 600;">@context.Subtotal.ToString("0.00") z≈Ç</MudText>
                                </MudTd>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.DeleteOutline" 
                                                   Color="Color.Error" 
                                                   Size="Size.Small"
                                                   OnClick="() => RemoveItem(context)" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>

                        <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <MudStack Row="true" Class="mud-justify-space-between mud-align-center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">Do zap≈Çaty</MudText>
                                    <MudText Typo="Typo.h4" Style="font-weight: 700;">@total.ToString("0.00") z≈Ç</MudText>
                                </MudStack>
                                <MudStack Spacing="0" Class="text-right">
                                    <MudText Typo="Typo.caption" Style="opacity: 0.8;">@editItems.Sum(i => i.Quantity) produkt√≥w</MudText>
                                    @if (startDate.HasValue && endDate.HasValue)
                                    {
                                        var days = Math.Max(1, (int)Math.Ceiling((endDate.Value - startDate.Value).TotalDays));
                                        <MudText Typo="Typo.caption" Style="opacity: 0.8;">@days dni</MudText>
                                    }
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </MudStack>
                </MudPaper>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="rounded-lg">
                    <MudStack Row="true" Spacing="2" Class="mud-align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Info" />
                        <MudText>Dodaj produkty do wynajmu u≈ºywajƒÖc wyszukiwarki powy≈ºej</MudText>
                    </MudStack>
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudPaper Elevation="0" Class="pa-4 mud-width-full" Style="background: #f5f5f5; border-top: 1px solid #e0e0e0;">
            <MudStack Row="true" Class="mud-width-full mud-justify-space-between">
                <MudButton Variant="Variant.Text" 
                           Color="Color.Default"
                           StartIcon="@Icons.Material.Filled.Close"
                           OnClick="() => dialogOpen=false">
                    Anuluj
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           Disabled="@(editModel.CustomerId == Guid.Empty || !editItems.Any())"
                           OnClick="Save"
                           Class="rounded-pill px-6">
                    @(editModel.Id == Guid.Empty ? "Utw√≥rz wynajem" : "Zapisz zmiany")
                </MudButton>
            </MudStack>
        </MudPaper>
    </DialogActions>
</MudDialog>

@* Dialog do wysy≈Çania customowego SMS *@
<MudDialog @bind-Visible="customSmsDialogOpen" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" Class="mud-align-center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Sms" Color="Color.Info" />
            <MudText Typo="Typo.h6">Wy≈õlij SMS do klienta</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @if (customSmsRental != null)
            {
                var customer = customersDict.GetValueOrDefault(customSmsRental.CustomerId);
                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudText Typo="Typo.body2">
                        <strong>Odbiorca:</strong> @(customer?.FullName ?? "Nieznany")<br/>
                        <strong>Telefon:</strong> @(customer?.PhoneNumber ?? "Brak numeru")
                    </MudText>
                </MudAlert>
            }
            <MudTextField @bind-Value="customSmsMessage"
                          Label="Tre≈õƒá wiadomo≈õci SMS"
                          Placeholder="Wpisz tre≈õƒá SMS..."
                          Variant="Variant.Outlined"
                          Lines="4"
                          MaxLength="480"
                          Counter="480"
                          HelperText="Maksymalnie 480 znak√≥w (3 SMS-y)" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="CloseCustomSmsDialog">
            Anuluj
        </MudButton>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Info"
                   StartIcon="@Icons.Material.Filled.Send"
                   Disabled="@(string.IsNullOrWhiteSpace(customSmsMessage) || sendingCustomSms)"
                   OnClick="SendCustomSms">
            @if (sendingCustomSms)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Wysy≈Çanie...</span>
            }
            else
            {
                <span>Wy≈õlij SMS</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

<MudBreakpointProvider OnBreakpointChanged="OnBreakpointChanged" />

@code {
    // ==================== BREAKPOINT ====================
    private bool _isMobile = false;
    
    private void OnBreakpointChanged(Breakpoint breakpoint)
    {
        _isMobile = breakpoint < Breakpoint.Md;
        StateHasChanged();
    }

    // ==================== DATA ====================
    [Parameter] [SupplyParameterFromQuery] public string? CustomerId { get; set; }

    private List<Rental> rentals = new();
    private List<Product> products = new();
    private List<Customer> customers = new();
    private Dictionary<Guid, Customer> customersDict = new();
    private Dictionary<Guid, int> reservedByProduct = new();

    private bool dialogOpen;
    private readonly DialogOptions rentalDialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };
    private Rental editModel = new();
    private List<RentalItem> editItems = new();
    private DateTime? startDate;
    private DateTime? endDate;
    private decimal total => editItems.Sum(i => i.Subtotal);
    private string? skuInput;
    private int skuQty = 1;
    private Product? selectedProduct;
    private int selectedQty = 1;
    private int CurrentAvail => selectedProduct is null ? 0 : GetAvail(selectedProduct.Id);
    private string? searchTerm;
    private bool cbStarted = true;
    private bool cbEnded = true; 
    private bool cbIncoming = true;
    private IEnumerable<Rental> filteredRentals => FilterRentals();
    
    private bool customSmsDialogOpen;
    private Rental? customSmsRental;
    private string customSmsMessage = "";
    private bool sendingCustomSms;

    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private SportRental.Admin.Services.Contracts.IContractGenerator ContractGenerator { get; set; } = default!;
    [Inject] private SportRental.Admin.Services.Email.IEmailSender EmailSender { get; set; } = default!;
    [Inject] private MudBlazor.ISnackbar Snackbar { get; set; } = default!;

    private string? loadError;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(CurrentTenantId());
            products = await Db.Products.AsNoTracking().OrderBy(p => p.Name).ToListAsync();
            customers = await Db.Customers.AsNoTracking().OrderBy(c => c.FullName).ToListAsync();
            customersDict = customers.ToDictionary(c => c.Id, c => c);
            rentals = await Db.Rentals.AsNoTracking().OrderByDescending(r => r.CreatedAtUtc).Take(200).ToListAsync();
            await UpdateReservedMap();
        }
        catch (Exception ex)
        {
            loadError = "Nie uda≈Ço siƒô za≈Çadowaƒá listy wynajm√≥w. Sprawd≈∫ logi.";
            Logger.LogError(ex, "B≈ÇƒÖd podczas wczytywania wynajm√≥w (tenant {TenantId})", CurrentTenantId());
        }
    }

    private void CreateNew()
    {
        editModel = new Rental
        {
            Id = Guid.Empty,
            TenantId = CurrentTenantId(),
            Status = RentalStatus.Draft
        };
        editItems = new();
        startDate = DateTime.Today;
        endDate = DateTime.Today.AddDays(1);
        dialogOpen = true;
        _ = UpdateReservedMap();
    }

    private void Edit(Rental r)
    {
        using var Db = DbFactory.CreateDbContext();
        Db.SetTenant(CurrentTenantId());
        editModel = new Rental
        {
            Id = r.Id,
            TenantId = r.TenantId,
            CustomerId = r.CustomerId,
            StartDateUtc = r.StartDateUtc,
            EndDateUtc = r.EndDateUtc,
            Status = r.Status,
            TotalAmount = r.TotalAmount,
            ContractUrl = r.ContractUrl
        };
        startDate = r.StartDateUtc.ToLocalTime();
        endDate = r.EndDateUtc.ToLocalTime();
        editItems = Db.RentalItems.Where(i => i.RentalId == r.Id).ToList();
        dialogOpen = true;
        _ = UpdateReservedMap();
    }

    private void AddItem()
    {
        editItems.Add(new RentalItem
        {
            Id = Guid.NewGuid(),
            ProductId = products.FirstOrDefault()?.Id ?? Guid.Empty,
            Quantity = 1,
            PricePerDay = products.FirstOrDefault()?.DailyPrice ?? 0,
            Subtotal = products.FirstOrDefault()?.DailyPrice ?? 0
        });
        Recalculate();
    }

    private void AddItemBySku()
    {
        if (string.IsNullOrWhiteSpace(skuInput)) return;
        var product = products.FirstOrDefault(p => string.Equals(p.Sku, skuInput, StringComparison.OrdinalIgnoreCase));
        if (product == null) return;
        var qty = Math.Max(1, skuQty);
        var days = Math.Max(1, (int)Math.Ceiling(((endDate ?? DateTime.Today.AddDays(1)) - (startDate ?? DateTime.Today)).TotalDays));
        var subtotal = product.DailyPrice * qty * days;
        editItems.Add(new RentalItem
        {
            Id = Guid.NewGuid(),
            ProductId = product.Id,
            Quantity = qty,
            PricePerDay = product.DailyPrice,
            Subtotal = subtotal
        });
        skuQty = 1;
        skuInput = string.Empty;
        Recalculate();
    }

    private Task<IEnumerable<Product>> SearchProducts(string value, CancellationToken token = default)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(products.AsEnumerable());
        value = value.Trim();
        var q = products.Where(p =>
            (p.Name?.Contains(value, StringComparison.OrdinalIgnoreCase) ?? false)
            || (p.Sku?.Contains(value, StringComparison.OrdinalIgnoreCase) ?? false)
            || (p.Category?.Contains(value, StringComparison.OrdinalIgnoreCase) ?? false));
        return Task.FromResult(q);
    }

    private void AddSelectedProduct()
    {
        if (selectedProduct is null) return;
        var qty = Math.Max(1, selectedQty);
        var days = Math.Max(1, (int)Math.Ceiling(((endDate ?? DateTime.Today.AddDays(1)) - (startDate ?? DateTime.Today)).TotalDays));
        var available = GetAvail(selectedProduct.Id);
        if (qty > available)
        {
            Snackbar.Add($"Dostƒôpnych jest tylko {available} szt.", MudBlazor.Severity.Warning);
            qty = available;
            if (qty <= 0) return;
        }
        var subtotal = selectedProduct.DailyPrice * qty * days;
        editItems.Add(new RentalItem
        {
            Id = Guid.NewGuid(),
            ProductId = selectedProduct.Id,
            Quantity = qty,
            PricePerDay = selectedProduct.DailyPrice,
            Subtotal = subtotal
        });
        selectedProduct = null;
        selectedQty = 1;
        Recalculate();
    }

    private bool _scannerActive = false;
    
    private string GetScannerContainerStyle()
    {
        var baseStyle = "border-radius: 12px; background: #f5f5f5;";
        return _scannerActive ? baseStyle : baseStyle + " display: none;";
    }
    
    private async Task StartScanner()
    {
        try
        {
            // Video element is always in DOM now, just hidden
            var success = await JS.InvokeAsync<bool>("srBarcode.start", "videoScanner");
            if (success)
            {
                _scannerActive = true;
                Snackbar.Add("Kamera uruchomiona", Severity.Success);
            }
            else
            {
                Snackbar.Add("Nie uda≈Ço siƒô uruchomiƒá kamery. Sprawd≈∫ uprawnienia w ustawieniach przeglƒÖdarki.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd kamery: {ex.Message}", Severity.Error);
        }
    }

    private async Task StopScanner()
    {
        try
        {
            await JS.InvokeVoidAsync("srBarcode.stop", "videoScanner");
        }
        catch { }
        _scannerActive = false;
    }

    private void RemoveItem(RentalItem item)
    {
        editItems.Remove(item);
        Recalculate();
    }

    private void Recalculate()
    {
        var start = startDate ?? DateTime.Today;
        var end = endDate ?? DateTime.Today.AddDays(1);
        var days = Math.Max(1, (int)Math.Ceiling((end - start).TotalDays));
        var hours = editModel.HoursRented ?? 1;
        
        foreach (var item in editItems)
        {
            var product = products.FirstOrDefault(p => p.Id == item.ProductId);
            
            if (editModel.RentalType == RentalType.Hourly && product?.HourlyPrice.HasValue == true)
            {
                item.PricePerHour = product.HourlyPrice;
                item.PricePerDay = product.DailyPrice;
                item.Subtotal = product.HourlyPrice.Value * item.Quantity * hours;
            }
            else
            {
                var price = product?.DailyPrice ?? item.PricePerDay;
                item.PricePerDay = price;
                item.PricePerHour = product?.HourlyPrice;
                item.Subtotal = price * item.Quantity * days;
            }
        }
    }

    private int GetAvail(Guid productId)
    {
        var baseQty = products.FirstOrDefault(p => p.Id == productId)?.AvailableQuantity ?? 0;
        var alreadyReserved = reservedByProduct.GetValueOrDefault(productId);
        var inCart = editItems.Where(i => i.ProductId == productId).Sum(i => i.Quantity);
        return Math.Max(0, baseQty - alreadyReserved - inCart);
    }

    private async Task OnStartDateChanged(DateTime? date)
    {
        startDate = date;
        await UpdateReservedMap();
        Recalculate();
    }

    private async Task OnEndDateChanged(DateTime? date)
    {
        endDate = date;
        await UpdateReservedMap();
        Recalculate();
    }

    private async Task UpdateReservedMap()
    {
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(CurrentTenantId());
            var sUtc = (startDate ?? DateTime.Today).Date;
            var eUtc = (endDate ?? DateTime.Today.AddDays(1)).Date;
            sUtc = DateTime.SpecifyKind(sUtc, DateTimeKind.Local).ToUniversalTime();
            eUtc = DateTime.SpecifyKind(eUtc, DateTimeKind.Local).ToUniversalTime();

            var query = await Db.RentalItems
                .Join(Db.Rentals, ri => ri.RentalId, r => r.Id, (ri, r) => new { ri, r })
                .Where(x => x.r.Status != RentalStatus.Cancelled
                            && x.r.EndDateUtc > sUtc
                            && x.r.StartDateUtc < eUtc)
                .GroupBy(x => x.ri.ProductId)
                .Select(g => new { ProductId = g.Key, Qty = g.Sum(x => x.ri.Quantity) })
                .ToListAsync();

            reservedByProduct = query.ToDictionary(x => x.ProductId, x => x.Qty);
        }
        catch
        {
            reservedByProduct = new();
        }
    }

    private async Task Save()
    {
        try
        {
            if (editModel.CustomerId == Guid.Empty)
            {
                Snackbar.Add("Wybierz klienta!", MudBlazor.Severity.Error);
                return;
            }
            if (!editItems.Any())
            {
                Snackbar.Add("Dodaj przynajmniej jeden produkt!", MudBlazor.Severity.Error);
                return;
            }
            if (!startDate.HasValue || !endDate.HasValue)
            {
                Snackbar.Add("Ustaw daty rozpoczƒôcia i zako≈Ñczenia!", MudBlazor.Severity.Error);
                return;
            }

            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(CurrentTenantId());
            editModel.StartDateUtc = startDate.Value.ToUniversalTime();
            editModel.EndDateUtc = endDate.Value.ToUniversalTime();
            editModel.TotalAmount = editItems.Sum(i => i.Subtotal);

            if (editModel.Id == Guid.Empty)
            {
                editModel.Id = Guid.NewGuid();
                editModel.CreatedAtUtc = DateTime.UtcNow;
                editModel.TenantId = CurrentTenantId();
                editModel.Status = RentalStatus.Confirmed;
                await Db.Rentals.AddAsync(editModel);
            }
            else
            {
                Db.Rentals.Update(editModel);
                var existing = Db.RentalItems.Where(i => i.RentalId == editModel.Id);
                Db.RentalItems.RemoveRange(existing);
            }

            foreach (var item in editItems)
            {
                item.Id = Guid.NewGuid();
                item.RentalId = editModel.Id;
                await Db.RentalItems.AddAsync(item);
            }

            await Db.SaveChangesAsync();
            
            var customer = await Db.Customers.FindAsync(editModel.CustomerId);
            var productIds = editItems.Select(i => i.ProductId).ToList();
            var productsForContract = await Db.Products.Where(p => productIds.Contains(p.Id)).ToListAsync();
            var companyInfo = await Db.CompanyInfos.FirstOrDefaultAsync(ci => ci.TenantId == CurrentTenantId());
            
            try
            {
                var contractUrl = await ContractGenerator.GenerateAndSaveRentalContractAsync(
                    editModel, editItems.ToList(), customer!, productsForContract, companyInfo);
                editModel.ContractUrl = contractUrl;
                Db.Rentals.Update(editModel);
                await Db.SaveChangesAsync();
                Snackbar.Add("üìÑ Umowa zosta≈Ça wygenerowana", MudBlazor.Severity.Success);
            }
            catch (Exception contractEx)
            {
                Logger.LogError(contractEx, "Failed to generate contract for rental {RentalId}", editModel.Id);
                Snackbar.Add($"‚ö†Ô∏è Wynajem zapisany, ale b≈ÇƒÖd generowania umowy: {contractEx.Message}", MudBlazor.Severity.Warning);
            }
            
            if (customer != null && !string.IsNullOrWhiteSpace(customer.Email))
            {
                try
                {
                    await ContractGenerator.SendRentalConfirmationEmailAsync(
                        editModel, editItems.ToList(), customer, productsForContract, companyInfo);
                    editModel.IsEmailSent = true;
                    Db.Rentals.Update(editModel);
                    await Db.SaveChangesAsync();
                    Snackbar.Add($"üìß Email wys≈Çany do {customer.Email}", MudBlazor.Severity.Success);
                }
                catch (Exception emailEx)
                {
                    Logger.LogError(emailEx, "Failed to send email for rental {RentalId}", editModel.Id);
                    Snackbar.Add($"‚ö†Ô∏è B≈ÇƒÖd wysy≈Çania emaila: {emailEx.Message}", MudBlazor.Severity.Warning);
                }
            }
            
            if (companyInfo?.SmsConfirmationEnabled == true && customer != null && !string.IsNullOrWhiteSpace(customer.PhoneNumber))
            {
                try
                {
                    await SmsConfirmationService.GenerateConfirmationCodeAsync(editModel.Id);
                    await SmsSender.SendContractConfirmationRequestAsync(
                        customer.PhoneNumber, 
                        customer.FullName ?? "Klient", 
                        editModel.Id,
                        customer.Email);
                    
                    editModel.IsSmsConfirmationSent = true;
                    editModel.Status = RentalStatus.Pending;
                    Db.Rentals.Update(editModel);
                    await Db.SaveChangesAsync();
                    
                    Snackbar.Add($"üì± SMS z pro≈õbƒÖ o potwierdzenie wys≈Çany do {customer.PhoneNumber}", MudBlazor.Severity.Info);
                }
                catch (Exception smsEx)
                {
                    Logger.LogError(smsEx, "Failed to send SMS for rental {RentalId}", editModel.Id);
                    Snackbar.Add($"‚ö†Ô∏è B≈ÇƒÖd wysy≈Çania SMS: {smsEx.Message}", MudBlazor.Severity.Warning);
                }
            }
            
            rentals = await Db.Rentals.AsNoTracking().OrderByDescending(r => r.CreatedAtUtc).Take(200).ToListAsync();
            dialogOpen = false;
            Snackbar.Add("‚úÖ Wynajem zosta≈Ç zapisany!", MudBlazor.Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving rental");
            Snackbar.Add($"B≈ÇƒÖd zapisu: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    [Inject] private SportRental.Infrastructure.Tenancy.ITenantProvider TenantProvider { get; set; } = default!;
    private Guid CurrentTenantId() => TenantProvider.GetCurrentTenantId() ?? Guid.Empty;

    private async Task RefreshRentals()
    {
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(CurrentTenantId());
            rentals = await Db.Rentals.AsNoTracking().OrderByDescending(r => r.CreatedAtUtc).Take(200).ToListAsync();
            Snackbar.Add("Lista wynajm√≥w od≈õwie≈ºona", MudBlazor.Severity.Info);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing rentals");
            Snackbar.Add($"B≈ÇƒÖd od≈õwie≈ºania: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private IEnumerable<Rental> FilterRentals()
    {
        var query = rentals.AsEnumerable();
        
        if (!string.IsNullOrWhiteSpace(CustomerId) && Guid.TryParse(CustomerId, out var customerGuid))
        {
            query = query.Where(r => r.CustomerId == customerGuid);
        }
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(r => 
                (customersDict.GetValueOrDefault(r.CustomerId)?.FullName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                r.Id.ToString().Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (r.Notes?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
        }
        
        var statusFilter = new List<RentalStatus>();
        if (cbStarted) statusFilter.Add(RentalStatus.Active);
        if (cbEnded) statusFilter.Add(RentalStatus.Completed);
        if (cbIncoming) statusFilter.Add(RentalStatus.Confirmed);
        
        if (statusFilter.Any())
        {
            query = query.Where(r => statusFilter.Contains(r.Status));
        }
        
        return query.OrderByDescending(r => r.CreatedAtUtc);
    }

    private string GetRentalTitle(Rental rental)
    {
        var customerName = customersDict.GetValueOrDefault(rental.CustomerId)?.FullName ?? "brak";
        return $"{rental.Id}. {customerName}";
    }

    private string GetRentalCardClass(Rental rental)
    {
        var baseClass = "rental-card";
        if (IsOverdue(rental))
            return $"{baseClass} overdue-rental";
        return baseClass;
    }

    private string GetRentalCardStyle(Rental rental)
    {
        var borderColor = IsOverdue(rental) ? "#f44336" : GetStatusColorHex(rental.Status);
        var bgColor = IsOverdue(rental) ? "background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);" : "";
        return $"border-radius: 16px; transition: all 0.3s ease; border-left: 4px solid {borderColor}; {bgColor}";
    }

    private bool IsOverdue(Rental rental)
    {
        return (rental.Status == RentalStatus.Active || rental.Status == RentalStatus.Confirmed)
               && rental.IssuedAtUtc.HasValue
               && !rental.ReturnedAtUtc.HasValue
               && rental.EndDateUtc < DateTime.UtcNow;
    }

    private int GetOverdueDays(Rental rental)
    {
        if (!IsOverdue(rental)) return 0;
        return (int)Math.Ceiling((DateTime.UtcNow - rental.EndDateUtc).TotalDays);
    }

    private string GetSourceIcon(RentalSource source) => source switch
    {
        RentalSource.Online => Icons.Material.Filled.Language,
        RentalSource.InStore => Icons.Material.Filled.Store,
        _ => Icons.Material.Filled.Help
    };

    private Color GetSourceColor(RentalSource source) => source switch
    {
        RentalSource.Online => Color.Info,
        RentalSource.InStore => Color.Secondary,
        _ => Color.Default
    };

    private string GetSourceText(RentalSource source) => source switch
    {
        RentalSource.Online => "Online",
        RentalSource.InStore => "W sklepie",
        _ => "Nieznane"
    };

    private string GetEquipmentStatusIcon(Rental rental)
    {
        if (rental.ReturnedAtUtc.HasValue)
            return Icons.Material.Filled.AssignmentTurnedIn;
        if (rental.IssuedAtUtc.HasValue)
            return Icons.Material.Filled.Output;
        return Icons.Material.Filled.Pending;
    }

    private Color GetEquipmentStatusColor(Rental rental)
    {
        if (rental.ReturnedAtUtc.HasValue)
            return Color.Success;
        if (rental.IssuedAtUtc.HasValue)
            return Color.Warning;
        return Color.Default;
    }

    private string GetEquipmentStatusText(Rental rental)
    {
        if (rental.ReturnedAtUtc.HasValue)
            return $"Zwr√≥cono {rental.ReturnedAtUtc.Value.ToLocalTime():dd.MM HH:mm}";
        if (rental.IssuedAtUtc.HasValue)
            return $"Wydano {rental.IssuedAtUtc.Value.ToLocalTime():dd.MM HH:mm}";
        return "Oczekuje na wydanie";
    }

    private Color GetStatusColor(RentalStatus status) => status switch
    {
        RentalStatus.Draft => Color.Default,
        RentalStatus.Pending => Color.Warning,
        RentalStatus.Confirmed => Color.Info,
        RentalStatus.Active => Color.Success,
        RentalStatus.Completed => Color.Primary,
        RentalStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(RentalStatus status) => status switch
    {
        RentalStatus.Draft => "Szkic",
        RentalStatus.Pending => "OczekujƒÖcy",
        RentalStatus.Confirmed => "Potwierdzony",
        RentalStatus.Active => "Aktywny",
        RentalStatus.Completed => "Zako≈Ñczony", 
        RentalStatus.Cancelled => "Anulowany",
        _ => status.ToString()
    };

    private string GetStatusColorHex(RentalStatus status) => status switch
    {
        RentalStatus.Draft => "#9e9e9e",
        RentalStatus.Pending => "#ff9800",
        RentalStatus.Confirmed => "#2196f3",
        RentalStatus.Active => "#4caf50",
        RentalStatus.Completed => "#9c27b0",
        RentalStatus.Cancelled => "#f44336",
        _ => "#9e9e9e"
    };

    private string GetStatusIcon(RentalStatus status) => status switch
    {
        RentalStatus.Draft => Icons.Material.Filled.Edit,
        RentalStatus.Pending => Icons.Material.Filled.Schedule,
        RentalStatus.Confirmed => Icons.Material.Filled.CheckCircle,
        RentalStatus.Active => Icons.Material.Filled.PlayCircle,
        RentalStatus.Completed => Icons.Material.Filled.Task,
        RentalStatus.Cancelled => Icons.Material.Filled.Cancel,
        _ => Icons.Material.Filled.Help
    };

    private async Task GenerateContract(Rental rental)
    {
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(CurrentTenantId());
            
            var items = await Db.RentalItems.Where(i => i.RentalId == rental.Id).ToListAsync();
            var customer = await Db.Customers.FindAsync(rental.CustomerId);
            var productIds = items.Select(i => i.ProductId).ToList();
            var products = await Db.Products.Where(p => productIds.Contains(p.Id)).ToListAsync();
            var companyInfo = await Db.CompanyInfos.FirstOrDefaultAsync(ci => ci.TenantId == CurrentTenantId());
            
            if (customer == null)
            {
                Snackbar.Add("Nie znaleziono klienta", MudBlazor.Severity.Error);
                return;
            }
            
            var contractUrl = await ContractGenerator.GenerateAndSaveRentalContractAsync(rental, items, customer, products, companyInfo);
            
            rental.ContractUrl = contractUrl;
            Db.Rentals.Update(rental);
            await Db.SaveChangesAsync();
            
            rentals = await Db.Rentals.AsNoTracking().OrderByDescending(r => r.CreatedAtUtc).Take(200).ToListAsync();
            StateHasChanged();
            
            Snackbar.Add("Umowa zosta≈Ça wygenerowana i zapisana", MudBlazor.Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd podczas generowania umowy: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async Task SendContractByEmail(Rental rental)
    {
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(CurrentTenantId());
            
            var items = await Db.RentalItems.Where(i => i.RentalId == rental.Id).ToListAsync();
            var customer = await Db.Customers.FindAsync(rental.CustomerId);
            var productIds = items.Select(i => i.ProductId).ToList();
            var products = await Db.Products.Where(p => productIds.Contains(p.Id)).ToListAsync();
            var companyInfo = await Db.CompanyInfos.FirstOrDefaultAsync(ci => ci.TenantId == CurrentTenantId());
            
            if (customer == null)
            {
                Snackbar.Add("Nie znaleziono klienta", MudBlazor.Severity.Error);
                return;
            }
            
            if (string.IsNullOrWhiteSpace(customer.Email))
            {
                Snackbar.Add($"Klient {customer.FullName} nie ma adresu email", MudBlazor.Severity.Warning);
                return;
            }
            
            await ContractGenerator.SendRentalConfirmationEmailAsync(rental, items, customer, products, companyInfo);
            
            rental.IsEmailSent = true;
            Db.Rentals.Update(rental);
            await Db.SaveChangesAsync();
            
            Snackbar.Add($"üìß Email z umowƒÖ wys≈Çany do {customer.Email}", MudBlazor.Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd podczas wysy≈Çania emaila: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async Task CompleteRental(Rental rental)
    {
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(CurrentTenantId());
            
            rental.Status = RentalStatus.Completed;
            Db.Rentals.Update(rental);
            await Db.SaveChangesAsync();
            
            Snackbar.Add($"Wynajem zosta≈Ç zako≈Ñczony", MudBlazor.Severity.Success);
            
            rentals = await Db.Rentals.AsNoTracking().OrderByDescending(r => r.CreatedAtUtc).Take(200).ToListAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd podczas ko≈Ñczenia wynajmu: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async Task Delete(Rental rental)
    {
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(CurrentTenantId());
            
            var items = await Db.RentalItems.Where(i => i.RentalId == rental.Id).ToListAsync();
            Db.RentalItems.RemoveRange(items);
            
            Db.Rentals.Remove(rental);
            await Db.SaveChangesAsync();
            
            Snackbar.Add($"Wynajem zosta≈Ç usuniƒôty", MudBlazor.Severity.Success);
            
            rentals.RemoveAll(r => r.Id == rental.Id);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd podczas usuwania wynajmu: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private void ExtendRental(Rental rental)
    {
        Edit(rental);
        
        var newEndDate = DateTime.Now.AddDays(7);
        endDate = newEndDate;
        editModel.EndDateUtc = DateTime.SpecifyKind(newEndDate, DateTimeKind.Utc);
        
        Snackbar.Add("Zmie≈Ñ datƒô zako≈Ñczenia aby przed≈Çu≈ºyƒá wynajem", MudBlazor.Severity.Warning);
    }
    
    private void OpenCustomSmsDialog(Rental rental)
    {
        var customer = customersDict.GetValueOrDefault(rental.CustomerId);
        if (customer == null || string.IsNullOrWhiteSpace(customer.PhoneNumber))
        {
            Snackbar.Add("Klient nie ma numeru telefonu", MudBlazor.Severity.Warning);
            return;
        }
        
        customSmsRental = rental;
        customSmsMessage = "";
        customSmsDialogOpen = true;
    }
    
    private void CloseCustomSmsDialog()
    {
        customSmsDialogOpen = false;
        customSmsRental = null;
        customSmsMessage = "";
    }
    
    private async Task SendCustomSms()
    {
        if (customSmsRental == null || string.IsNullOrWhiteSpace(customSmsMessage))
            return;
            
        var customer = customersDict.GetValueOrDefault(customSmsRental.CustomerId);
        if (customer == null || string.IsNullOrWhiteSpace(customer.PhoneNumber))
        {
            Snackbar.Add("Klient nie ma numeru telefonu", MudBlazor.Severity.Warning);
            return;
        }
        
        sendingCustomSms = true;
        StateHasChanged();
        
        try
        {
            await SmsSender.SendAsync(customer.PhoneNumber, customSmsMessage);
            Snackbar.Add($"üì± SMS wys≈Çany do {customer.PhoneNumber}", MudBlazor.Severity.Success);
            CloseCustomSmsDialog();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to send custom SMS to {Phone}", customer.PhoneNumber);
            Snackbar.Add($"B≈ÇƒÖd wysy≈Çania SMS: {ex.Message}", MudBlazor.Severity.Error);
        }
        finally
        {
            sendingCustomSms = false;
            StateHasChanged();
        }
    }
}
