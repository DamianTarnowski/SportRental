@page "/admin/customers"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Owner,SuperAdmin,Employee")]
@using SportRental.Admin.Components.Dialogs

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-6 mb-4" Elevation="4" Style="background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%); color: white; border-radius: 20px;">
        <MudStack Row="true" Class="mud-space-between">
            <MudStack Row="true" Class="mud-align-center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Large" />
                <div>
                    <MudText Typo="Typo.h4" Style="font-weight: 700;">Klienci</MudText>
                    <MudText Typo="Typo.subtitle1" Style="opacity: 0.9;">Zarządzaj bazą klientów wypożyczalni</MudText>
                </div>
            </MudStack>
                       <MudButton Variant="Variant.Filled" 
                                  Color="Color.Surface" 
                                  StartIcon="@Icons.Material.Filled.PersonAdd"
                       OnClick="OpenCreateDialog"
                       Size="Size.Large"
                       Class="rounded-pill px-6">
                Nowy klient
            </MudButton>
        </MudStack>
    </MudPaper>
    <MudCard Elevation="4" Class="mb-4" Style="border-radius: 16px;">
        <MudCardContent Class="pa-4">
            <MudGrid Class="mud-align-end" Spacing="3">
                <MudItem xs="12" md="8">
                    <MudTextField 
                        @bind-Value="search"
                        Placeholder="Wyszukaj klienta po nazwie, email lub telefonie..." 
                        Immediate="true" 
                        Adornment="Adornment.Start" 
                        AdornmentIcon="@Icons.Material.Filled.Search" 
                        Clearable="true"
                        Variant="Variant.Outlined"
                        Class="rounded-lg" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudStack Row="true" Spacing="1" Class="mud-justify-end">
                        <MudTooltip Text="Odśwież listę klientów">
                            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                           Color="Color.Primary" 
                                           OnClick="() => InvokeAsync(StateHasChanged)"
                                           Size="Size.Large" />
                        </MudTooltip>
                        <MudTooltip Text="Eksportuj do CSV">
                            <MudIconButton Icon="@Icons.Material.Filled.FileDownload" 
                                           Color="Color.Success" 
                                           OnClick="ExportToCSV"
                                           Size="Size.Large" />
                        </MudTooltip>
                        <MudTooltip Text="Statystyki klientów">
                            <MudIconButton Icon="@Icons.Material.Filled.Analytics" 
                                           Color="Color.Info" 
                                           OnClick="ShowStatistics"
                                           Size="Size.Large" />
                        </MudTooltip>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    @if (!filtered.Any())
    {
        <MudCard Elevation="2" Class="text-center pa-8" Style="border-radius: 16px;">
            <MudCardContent>
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" Class="mb-3" />
                <MudText Typo="Typo.h6" Color="Color.Default">Brak klientów do wyświetlenia</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Zmień filtry lub dodaj nowego klienta</MudText>
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var customer in filtered)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="6" Class="customer-card h-100" Style="border-radius: 16px; transition: all 0.3s ease;">
                        <MudCardContent Class="pa-5">
                            <MudStack Spacing="3">
                                <div Class="d-flex align-center">
                                    <MudAvatar Color="Color.Primary" Size="Size.Large" Class="mr-3">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" />
                                    </MudAvatar>
                                    <div Class="flex-1">
                                        <MudText Typo="Typo.h6" Style="font-weight: 600;" Class="mb-1">
                                            @customer.FullName
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Default">
                                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mr-1" />
                                            Utworzony: @customer.CreatedAtUtc.ToLocalTime().ToString("dd.MM.yyyy")
                                        </MudText>
                                    </div>
                                </div>

                                <MudStack Spacing="2">
                                    @if (!string.IsNullOrEmpty(customer.Email))
                                    {
                                        <div Class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Email" Color="Color.Info" Size="Size.Small" Class="mr-2" />
                                            <MudText Typo="Typo.body2">@customer.Email</MudText>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(customer.PhoneNumber))
                                    {
                                        <div Class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Phone" Color="Color.Success" Size="Size.Small" Class="mr-2" />
                                            <MudText Typo="Typo.body2">@customer.PhoneNumber</MudText>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(customer.Address))
                                    {
                                        <div Class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Color="Color.Warning" Size="Size.Small" Class="mr-2" />
                                            <MudText Typo="Typo.body2" Style="line-height: 1.4;">
                                                @(customer.Address.Length > 50 ? customer.Address.Substring(0, 50) + "..." : customer.Address)
                                            </MudText>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(customer.DocumentNumber))
                                    {
                                        <div Class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Badge" Color="Color.Secondary" Size="Size.Small" Class="mr-2" />
                                            <MudText Typo="Typo.body2">@customer.DocumentNumber</MudText>
                                        </div>
                                    }
                                </MudStack>

                                @if (!string.IsNullOrWhiteSpace(customer.Notes))
                                {
                                    <MudAlert Severity="Severity.Info" Dense="true" NoIcon="true" Class="pa-2">
                                        <MudText Typo="Typo.caption">
                                            <MudIcon Icon="@Icons.Material.Filled.StickyNote2" Size="Size.Small" Class="mr-1" />
                                            @(customer.Notes.Length > 60 ? customer.Notes.Substring(0, 60) + "..." : customer.Notes)
                                        </MudText>
                                    </MudAlert>
                                }
                            </MudStack>
                        </MudCardContent>
                        
                        <MudCardActions Class="pa-3 pt-0">
                            <MudStack Spacing="1" Class="w-100">
                                <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary" OverrideStyles="false" FullWidth="true">
                                    <MudButton StartIcon="@Icons.Material.Filled.Edit" 
                                               OnClick="async () => await OpenEditDialog(customer)"
                                               Size="Size.Small">
                                        Edytuj
                                    </MudButton>
                                    <MudButton StartIcon="@Icons.Material.Filled.Assignment" 
                                               OnClick="async () => await ViewRentals(customer)"
                                               Color="Color.Info"
                                               Size="Size.Small">
                                        Wynajmy
                                    </MudButton>
                                </MudButtonGroup>
                                <MudButton StartIcon="@Icons.Material.Filled.Delete" 
                                           OnClick="async () => await Delete(customer)"
                                           Color="Color.Error"
                                           Variant="Variant.Outlined"
                                           Size="Size.Small"
                                           FullWidth="true">
                                    Usuń klienta
                                </MudButton>
                            </MudStack>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

</MudContainer>

@code {
    private List<Customer> customers = new();
    private IEnumerable<Customer> filtered => string.IsNullOrWhiteSpace(search)
        ? customers
        : customers.Where(c => (c.FullName?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false)
                             || (c.Email?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false)
                             || (c.PhoneNumber?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false));

    private string? search;

    protected override async Task OnInitializedAsync()
    {
        await RefreshCustomers();
    }

    private async Task OpenCreateDialog()
    {
        await OpenCustomerDialog();
    }

    private async Task OpenEditDialog(Customer c)
    {
        await OpenCustomerDialog(c);
    }

    private async Task OpenCustomerDialog(Customer? existing = null)
    {
        var isNew = existing is null || existing.Id == Guid.Empty;
        var parameters = new DialogParameters
        {
            ["Customer"] = isNew ? CreateEmptyCustomer() : CloneCustomer(existing!),
            ["IsNew"] = isNew
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true,
            NoHeader = false,
            BackdropClick = false
        };

        var dialog = await DialogService.ShowAsync<CustomerEditDialog>(
            isNew ? "Nowy klient" : "Edytuj klienta",
            parameters,
            options);

        var result = await dialog.Result;
        if (!result.Canceled && result.Data is Customer updatedCustomer)
        {
            await SaveCustomerAsync(updatedCustomer, isNew);
        }
    }

    private Customer CreateEmptyCustomer() => new()
    {
        Id = Guid.Empty,
        TenantId = CurrentTenantId()
    };

    private static Customer CloneCustomer(Customer source) => new()
    {
        Id = source.Id,
        TenantId = source.TenantId,
        FullName = source.FullName,
        Email = source.Email,
        PhoneNumber = source.PhoneNumber,
        DocumentNumber = source.DocumentNumber,
        Address = source.Address,
        Notes = source.Notes,
        CreatedAtUtc = source.CreatedAtUtc
    };

    private async Task SaveCustomerAsync(Customer model, bool isNew)
    {
        // Walidacja i normalizacja numeru telefonu jak w starym projekcie
        model.PhoneNumber = NormalizePhone(model.PhoneNumber);
        model.FullName = model.FullName?.Trim() ?? string.Empty;
        model.Email = model.Email?.Trim();
        model.Address = model.Address?.Trim();
        model.DocumentNumber = model.DocumentNumber?.Trim();
        model.Notes = model.Notes?.Trim();

        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());
        if (isNew || model.Id == Guid.Empty)
        {
            model.Id = Guid.NewGuid();
            model.CreatedAtUtc = DateTime.UtcNow;
            model.TenantId = CurrentTenantId();
            await Db.Customers.AddAsync(model);
            Snackbar.Add("Klient został dodany", Severity.Success);
        }
        else
        {
            var existing = await Db.Customers.FirstOrDefaultAsync(x => x.Id == model.Id);
            if (existing is null)
            {
                Snackbar.Add("Nie znaleziono klienta do edycji", Severity.Warning);
                return;
            }

            existing.FullName = model.FullName;
            existing.Email = model.Email;
            existing.PhoneNumber = model.PhoneNumber;
            existing.DocumentNumber = model.DocumentNumber;
            existing.Address = model.Address;
            existing.Notes = model.Notes;
            Db.Customers.Update(existing);
            Snackbar.Add("Klient został zaktualizowany", Severity.Success);
        }
        await Db.SaveChangesAsync();
        await RefreshCustomers();
    }

    private async Task ViewRentals(Customer customer)
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());

        var rentals = await Db.Rentals
            .Where(r => r.CustomerId == customer.Id)
            .Include(r => r.Items)
                .ThenInclude(i => i.Product)
            .OrderByDescending(r => r.CreatedAtUtc)
            .AsNoTracking()
            .ToListAsync();

        var parameters = new DialogParameters
        {
            ["CustomerName"] = customer.FullName,
            ["CustomerId"] = customer.Id,
            ["Rentals"] = rentals
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<CustomerRentalsDialog>("Wynajmy klienta", parameters, options);
    }

    [Inject] private SportRental.Infrastructure.Tenancy.ITenantProvider TenantProvider { get; set; } = default!;
    private Guid CurrentTenantId() => TenantProvider.GetCurrentTenantId() ?? Guid.Empty;

    private Task ExportToCSV()
    {
        Snackbar.Add("Eksport do CSV - funkcja w przygotowaniu", Severity.Info);
        return Task.CompletedTask;
    }

    private Task ShowStatistics()
    {
        Snackbar.Add("Statystyki klientów - funkcja w przygotowaniu", Severity.Info);
        return Task.CompletedTask;
    }

    private async Task Delete(Customer c)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Usuń klienta",
            $"Czy na pewno chcesz usunąć klienta \"{c.FullName}\" wraz z jego danymi?",
            yesText: "Usuń",
            cancelText: "Anuluj",
            options: new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.ExtraSmall
            });

        if (confirm is not true)
            return;

        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());

        var existing = await Db.Customers.FirstOrDefaultAsync(x => x.Id == c.Id);
        if (existing is null)
        {
            Snackbar.Add("Klient nie istnieje lub został już usunięty", Severity.Warning);
            return;
        }

        Db.Customers.Remove(existing);
        await Db.SaveChangesAsync();
        customers.RemoveAll(x => x.Id == c.Id);
        Snackbar.Add("Klient został usunięty", Severity.Success);
        StateHasChanged();
    }

    private async Task RefreshCustomers()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());
        customers = await Db.Customers.AsNoTracking()
            .OrderByDescending(p => p.CreatedAtUtc)
            .Take(500)
            .ToListAsync();
        StateHasChanged();
    }

    private string? NormalizePhone(string? phoneNumber)
    {
        if (string.IsNullOrWhiteSpace(phoneNumber))
            return phoneNumber;

        var trimmed = new string(phoneNumber.Where(ch => char.IsDigit(ch) || ch == '+').ToArray());
        if (!trimmed.StartsWith("+"))
        {
            trimmed = "+48" + trimmed.TrimStart('0');
            Snackbar.Add("Numer telefonu został uzupełniony prefiksem +48.", Severity.Info);
        }
        return trimmed;
    }
}
