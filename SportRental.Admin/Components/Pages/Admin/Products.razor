@page "/admin/products"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Owner,SuperAdmin,Employee")]
@using SportRental.Infrastructure.Domain


@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject MudBlazor.ISnackbar Snackbar
@inject SportRental.Admin.Services.Storage.IFileStorage FileStorage
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-6 mb-4" Elevation="4" Style="background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%); color: white; border-radius: 20px;">
        <MudStack Row="true" Class="mud-space-between">
            <MudStack Row="true" Class="mud-align-center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" />
                <div>
                    <MudText Typo="Typo.h4" Style="font-weight: 700;">Produkty</MudText>
                    <MudText Typo="Typo.subtitle1" Style="opacity: 0.9;">ZarzƒÖdzaj sprzƒôtem sportowym</MudText>
                </div>
            </MudStack>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Surface" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateNew"
                       Size="Size.Large"
                       Class="rounded-pill px-6">
                Nowy produkt
            </MudButton>
        </MudStack>
    </MudPaper>
    <MudCard Elevation="4" Class="mb-4" Style="border-radius: 16px;">
        <MudCardContent Class="pa-4">
            <MudGrid Class="mud-align-end" Spacing="3">
                <MudItem xs="12" md="4">
                    <MudTextField 
                        @bind-Value="search"
                        Placeholder="Wyszukaj produkt..." 
                        Immediate="true" 
                        Adornment="Adornment.Start" 
                        AdornmentIcon="@Icons.Material.Filled.Search" 
                        Clearable="true"
                        Variant="Variant.Outlined"
                        Class="rounded-lg" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudStack Row="true" Spacing="4" Class="mud-align-center">
                        <MudSwitch @bind-Value="cbAvailable" 
                                   Label="Dostƒôpne" 
                                   Color="Color.Success"
                                   ThumbIcon="@Icons.Material.Filled.CheckCircle" />
                        <MudSwitch @bind-Value="cbRented" 
                                   Label="Wypo≈ºyczone" 
                                   Color="Color.Warning"
                                   ThumbIcon="@Icons.Material.Filled.Schedule" />
                    </MudStack>
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudStack Row="true" Spacing="1">
                        <MudTooltip Text="Od≈õwie≈º listƒô produkt√≥w">
                            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                           Color="Color.Primary" 
                                           OnClick="() => InvokeAsync(StateHasChanged)"
                                           Size="Size.Large" />
                        </MudTooltip>
                        <MudTooltip Text="Widok siatki/lista">
                            <MudIconButton Icon="@(gridView ? Icons.Material.Filled.ViewList : Icons.Material.Filled.GridView)" 
                                           Color="Color.Primary" 
                                           OnClick="() => gridView = !gridView"
                                           Size="Size.Large" />
                        </MudTooltip>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    @if (!filtered.Any())
    {
        <MudCard Elevation="2" Class="text-center pa-8" Style="border-radius: 16px;">
            <MudCardContent>
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" Class="mb-3" />
                <MudText Typo="Typo.h6" Color="Color.Default">Brak produkt√≥w do wy≈õwietlenia</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Zmie≈Ñ filtry lub dodaj nowy produkt</MudText>
            </MudCardContent>
        </MudCard>
    }
    else
    {
        @if (gridView)
        {
            <MudGrid Spacing="3">
                @foreach (var product in filtered)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudCard Elevation="6" Class="product-card h-100" Style="@($"border-radius: 16px; transition: all 0.3s ease;{(IsCurrentlyRented(product.Id) ? " border: 2px solid #ff9800;" : "")}")" >
                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                            {
                                <MudCardMedia Image="@product.ImageUrl" Height="200" Style="border-radius: 16px 16px 0 0;" />
                            }
                            else
                            {
                                <MudPaper Height="200px" Class="d-flex align-center justify-center" Style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 16px 16px 0 0;">
                                    <MudIcon Icon="@GetProductIcon(product.Category)" Size="Size.Large" Color="Color.Primary" />
                                </MudPaper>
                            }
                            
                            <MudCardContent Class="pa-4">
                                <MudStack Spacing="2">
                                    <div>
                                        <MudText Typo="Typo.h6" Style="font-weight: 600;" Class="mb-1">@product.Name</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">@product.Sku</MudChip>
                                    </div>
                                    
                                    @if (IsCurrentlyRented(product.Id))
                                    {
                                        <MudAlert Severity="Severity.Warning" Dense="true" NoIcon="true" Class="pa-2">
                                            <MudText Typo="Typo.caption">
                                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mr-1" />
                                                Obecnie wypo≈ºyczony
                                            </MudText>
                                        </MudAlert>
                                    }
                                    
                                    <MudStack Row="true" Class="mud-space-between" Spacing="3">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 700;">
                                                @product.DailyPrice.ToString("0.00") z≈Ç/dzie≈Ñ
                                            </MudText>
                                            @if (product.HourlyPrice.HasValue && product.HourlyPrice.Value > 0)
                                            {
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                    @product.HourlyPrice.Value.ToString("0.00") z≈Ç/godz.
                                                </MudText>
                                            }
                                        </MudStack>
                                        <MudChip T="string" Size="Size.Small" 
                                                 Color="@(product.AvailableQuantity > 0 ? Color.Success : Color.Error)"
                                                 Variant="Variant.Filled">
                                            @product.AvailableQuantity szt.
                                        </MudChip>
                                    </MudStack>
                                    
                                    @if (!string.IsNullOrEmpty(product.Category))
                                    {
                                        <MudChip T="string" Size="Size.Small" 
                                                 Icon="@Icons.Material.Filled.Category" 
                                                 Color="Color.Info" 
                                                 Variant="Variant.Text">
                                            @product.Category
                                        </MudChip>
                                    }
                                    
                                    @if (!string.IsNullOrEmpty(product.Description))
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Default" Style="line-height: 1.4;">
                                            @(product.Description.Length > 80 ? product.Description.Substring(0, 80) + "..." : product.Description)
                                        </MudText>
                                    }
                                </MudStack>
                            </MudCardContent>
                            
                            <MudCardActions Class="pa-3 pt-0">
                                <MudStack Spacing="1" Class="w-100">
                                    <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary" OverrideStyles="false" FullWidth="true">
                                        <MudButton StartIcon="@Icons.Material.Filled.Edit" 
                                                   OnClick="() => Edit(product)"
                                                   Size="Size.Small">
                                            Edytuj
                                        </MudButton>
                                        <MudButton StartIcon="@Icons.Material.Filled.Delete" 
                                                   OnClick="() => Delete(product)"
                                                   Color="Color.Error"
                                                   Size="Size.Small">
                                            Usu≈Ñ
                                        </MudButton>
                                    </MudButtonGroup>
                                    
                                    @if (product.IsActive)
                                    {
                                        <MudButton StartIcon="@Icons.Material.Filled.VisibilityOff" 
                                                   OnClick="() => ToggleActive(product)"
                                                   Color="Color.Warning"
                                                   Variant="Variant.Filled"
                                                   Size="Size.Small"
                                                   FullWidth="true">
                                            Dezaktywuj
                                        </MudButton>
                                    }
                                    else
                                    {
                                        <MudButton StartIcon="@Icons.Material.Filled.Visibility" 
                                                   OnClick="() => ToggleActive(product)"
                                                   Color="Color.Success"
                                                   Variant="Variant.Filled"
                                                   Size="Size.Small"
                                                   FullWidth="true">
                                            Aktywuj
                                        </MudButton>
                                    }
                                </MudStack>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <MudStack Spacing="2">
                @foreach (var product in filtered)
                {
                    <MudCard Elevation="4" Style="@($"border-radius: 16px;{(IsCurrentlyRented(product.Id) ? " border-left: 4px solid #ff9800;" : "")}")" >
                        <MudCardContent Class="pa-4">
                            <MudGrid Class="mud-align-center" Spacing="3">
                                <MudItem xs="12" md="8">
                    <MudStack Row="true" Class="mud-align-center" Spacing="3">
                                        @if (!string.IsNullOrEmpty(product.ImageUrl))
                                        {
                                            <MudAvatar Size="Size.Large">
                                                <img src="@product.ImageUrl" alt="@product.Name" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;" />
                                            </MudAvatar>
                                        }
                                        else
                                        {
                                            <MudAvatar Size="Size.Large" Color="Color.Primary">
                                                <MudIcon Icon="@GetProductIcon(product.Category)" />
                                            </MudAvatar>
                                        }
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.h6" Style="font-weight: 600;">@product.Name</MudText>
                                            <MudStack Row="true" Spacing="2" Class="mud-align-center">
                                                <MudChip T="string" Size="Size.Small" Color="Color.Default">@product.Sku</MudChip>
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Category">@(product.Category ?? "Brak")</MudChip>
                                                <MudChip T="string" Size="Size.Small" Color="Color.Success">@product.DailyPrice.ToString("0.00") z≈Ç/dzie≈Ñ</MudChip>
                                                <MudChip T="string" Size="Size.Small" Color="@(product.AvailableQuantity > 0 ? Color.Success : Color.Error)">@product.AvailableQuantity szt.</MudChip>
                                            </MudStack>
                                        </MudStack>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudStack Row="true" Spacing="1" Class="mud-justify-end">
                                        <MudButton StartIcon="@Icons.Material.Filled.Edit" 
                                                   OnClick="() => Edit(product)"
                                                   Color="Color.Primary"
                                                   Size="Size.Small">
                                            Edytuj
                                        </MudButton>
                                        <MudButton StartIcon="@Icons.Material.Filled.Delete" 
                                                   OnClick="() => Delete(product)"
                                                   Color="Color.Error"
                                                   Size="Size.Small">
                                            Usu≈Ñ
                                        </MudButton>
                                        @if (product.IsActive)
                                        {
                                            <MudButton StartIcon="@Icons.Material.Filled.VisibilityOff" 
                                                       OnClick="() => ToggleActive(product)"
                                                       Color="Color.Warning"
                                                       Size="Size.Small">
                                                Dezaktywuj
                                            </MudButton>
                                        }
                                        else
                                        {
                                            <MudButton StartIcon="@Icons.Material.Filled.Visibility" 
                                                       OnClick="() => ToggleActive(product)"
                                                       Color="Color.Success"
                                                       Size="Size.Small">
                                                Aktywuj
                                            </MudButton>
                                        }
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }
    }

    <MudDialog @bind-Visible="dialogOpen" Options="@productDialogOptions">
        <TitleContent>
            <MudStack Row="true" Class="mud-align-center" Spacing="3">
                <MudAvatar Color="Color.Info" Size="Size.Large" Style="background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);">
                    <MudIcon Icon="@Icons.Material.Filled.Inventory2" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.h5" Style="font-weight: 700;">
                        @(model.Id == Guid.Empty ? "Nowy produkt" : "Edytuj produkt")
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Default">
                        @(model.Id == Guid.Empty ? "Dodaj nowy sprzƒôt do wypo≈ºyczalni" : "Zaktualizuj informacje o produkcie")
                    </MudText>
                </div>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudStack Spacing="4" Class="pa-2">
                @* SEKCJA: PODSTAWOWE INFORMACJE *@
                <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                    <MudStack Spacing="3">
                        <MudStack Row="true" Class="mud-align-center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Primary" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Podstawowe informacje</MudText>
                        </MudStack>
                        
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="8">
                                <MudTextField @bind-Value="model.Name" 
                                              Label="Nazwa produktu" 
                                              Placeholder="np. Narty Atomic Redster X9"
                                              Required="true"
                                              Variant="Variant.Outlined"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Label"
                                              Class="rounded-lg" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="model.Sku" 
                                              Label="Kod SKU" 
                                              Placeholder="np. NAR-001"
                                              Required="true"
                                              Variant="Variant.Outlined"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.QrCode"
                                              Class="rounded-lg" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField @bind-Value="model.Description" 
                                              Label="Opis produktu" 
                                              Placeholder="Kr√≥tki opis sprzƒôtu..."
                                              Lines="3"
                                              Variant="Variant.Outlined"
                                              Class="rounded-lg" />
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudPaper>

                @* SEKCJA: CENA I DOSTƒòPNO≈öƒÜ *@
                <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                    <MudStack Spacing="3">
                        <MudStack Row="true" Class="mud-align-center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Success" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Cena i dostƒôpno≈õƒá</MudText>
                        </MudStack>
                        
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="3">
                                <MudNumericField T="decimal" @bind-Value="model.DailyPrice" 
                                                  Label="Cena za dzie≈Ñ" 
                                                  Min="0" 
                                                  Format="0.00"
                                                  Adornment="Adornment.End"
                                                  AdornmentText="z≈Ç"
                                                  Variant="Variant.Outlined"
                                                  Class="rounded-lg" />
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudNumericField T="decimal?" @bind-Value="model.HourlyPrice" 
                                                  Label="Cena za godzinƒô" 
                                                  Min="0" 
                                                  Format="0.00"
                                                  Adornment="Adornment.End"
                                                  AdornmentText="z≈Ç"
                                                  Variant="Variant.Outlined"
                                                  HelperText="Opcjonalne"
                                                  Class="rounded-lg" />
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudNumericField T="int" @bind-Value="model.AvailableQuantity" 
                                                  Label="Dostƒôpna ilo≈õƒá" 
                                                  Min="0"
                                                  Adornment="Adornment.End"
                                                  AdornmentText="szt."
                                                  Variant="Variant.Outlined"
                                                  Class="rounded-lg" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudSelect T="string" @bind-Value="model.Category" 
                                           Label="Kategoria"
                                           Variant="Variant.Outlined"
                                           Adornment="Adornment.Start"
                                           AdornmentIcon="@Icons.Material.Filled.Category"
                                           Class="rounded-lg">
                                    <MudSelectItem Value="@("Narty")">üéø Narty</MudSelectItem>
                                    <MudSelectItem Value="@("Snowboard")">üèÇ Snowboard</MudSelectItem>
                                    <MudSelectItem Value="@("Buty narciarskie")">üëü Buty narciarskie</MudSelectItem>
                                    <MudSelectItem Value="@("Buty snowboardowe")">üë¢ Buty snowboardowe</MudSelectItem>
                                    <MudSelectItem Value="@("Kije")">ü•¢ Kije</MudSelectItem>
                                    <MudSelectItem Value="@("Kask")">‚õëÔ∏è Kask</MudSelectItem>
                                    <MudSelectItem Value="@("Gogle")">ü•Ω Gogle</MudSelectItem>
                                    <MudSelectItem Value="@("Rower")">üö¥ Rower</MudSelectItem>
                                    <MudSelectItem Value="@("SUP")">üèÑ SUP</MudSelectItem>
                                    <MudSelectItem Value="@("Kajak")">üõ∂ Kajak</MudSelectItem>
                                    <MudSelectItem Value="@("Inne")">üì¶ Inne</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                        </MudGrid>

                        <MudStack Row="true" Class="mud-align-center" Spacing="3">
                            <MudSwitch @bind-Value="model.IsActive" 
                                       Color="Color.Success" 
                                       Label="Produkt aktywny" />
                            @if (model.IsActive)
                            {
                                <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">
                                    <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Class="mr-1" />
                                    Widoczny dla klient√≥w
                                </MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Outlined">
                                    <MudIcon Icon="@Icons.Material.Filled.VisibilityOff" Size="Size.Small" Class="mr-1" />
                                    Ukryty
                                </MudChip>
                            }
                        </MudStack>
                    </MudStack>
                </MudPaper>

                @* SEKCJA: ZDJƒòCIE *@
                <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 16px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
                    <MudStack Spacing="3">
                        <MudStack Row="true" Class="mud-align-center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Image" Color="Color.Warning" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Zdjƒôcie produktu</MudText>
                        </MudStack>
                        
                        @if (!string.IsNullOrEmpty(model.ImageUrl))
                        {
                            <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 12px; background: white;">
                                <MudStack Row="true" Spacing="3" Class="mud-align-center">
                                    <MudImage Src="@model.ImageUrl" 
                                              Alt="@model.Name" 
                                              Width="100" 
                                              Height="100" 
                                              ObjectFit="ObjectFit.Cover"
                                              Style="border-radius: 8px;" />
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">Aktualne zdjƒôcie</MudText>
                                        <MudButton Size="Size.Small" 
                                                   Variant="Variant.Text" 
                                                   Color="Color.Error"
                                                   StartIcon="@Icons.Material.Filled.Delete"
                                                   OnClick="() => model.ImageUrl = null">
                                            Usu≈Ñ zdjƒôcie
                                        </MudButton>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                        
                        <MudTextField @bind-Value="model.ImageUrl" 
                                      Label="URL zdjƒôcia (opcjonalnie)" 
                                      Placeholder="https://..."
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Link"
                                      Class="rounded-lg" />
                        
                        <MudDivider />
                        
                        <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Small" Class="mr-1" />
                            Lub wgraj zdjƒôcie z dysku:
                        </MudText>
                        
                        <ImageCropper MaxSizeMB="8" 
                                      OnImageReady="OnImageReadySkipCrop"
                                      OnBase64ImageReady="OnImageReadyCropped" />
                    </MudStack>
                </MudPaper>
            </MudStack>
        </DialogContent>
        <DialogActions>
            <MudPaper Elevation="0" Class="pa-4 mud-width-full" Style="background: #f5f5f5; border-top: 1px solid #e0e0e0;">
                <MudStack Row="true" Class="mud-width-full mud-justify-space-between">
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Default"
                               StartIcon="@Icons.Material.Filled.Close"
                               OnClick="() => dialogOpen=false">
                        Anuluj
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Save"
                               Disabled="@(string.IsNullOrWhiteSpace(model.Name) || string.IsNullOrWhiteSpace(model.Sku))"
                               OnClick="Save"
                               Class="rounded-pill px-6">
                        @(model.Id == Guid.Empty ? "‚ú® Dodaj produkt" : "üíæ Zapisz zmiany")
                    </MudButton>
                </MudStack>
            </MudPaper>
        </DialogActions>
    </MudDialog>
</MudContainer>

@code {
    private List<Product> products = new();
    private IEnumerable<Product> filtered => FilteredProducts();
    private HashSet<Guid> currentlyRentedProductIds = new();
    
    private string? search;
    private bool cbAvailable = true;
    private bool cbRented = true;
    private bool gridView = true;
    private bool dialogOpen;
    private readonly DialogOptions productDialogOptions = new() { MaxWidth = MaxWidth.Medium };
    private Product model = new();
    private string? _selectedImageName;

    private IEnumerable<Product> FilteredProducts()
    {
        var query = products.AsEnumerable();
        
        // Filtr wyszukiwania
        if (!string.IsNullOrWhiteSpace(search))
        {
            query = query.Where(p => 
                (p.Name?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (p.Sku?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (p.Category?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false));
        }
        
        // Filtr dostƒôpno≈õci i wynajƒôcia
        if (!cbAvailable && !cbRented)
        {
            // Je≈õli oba filtry sƒÖ wy≈ÇƒÖczone, nic nie pokazuj
            return Enumerable.Empty<Product>();
        }
        
        if (cbAvailable && !cbRented)
        {
            // Tylko dostƒôpne (nie wypo≈ºyczone)
            query = query.Where(p => !IsCurrentlyRented(p.Id));
        }
        else if (!cbAvailable && cbRented)
        {
            // Tylko wypo≈ºyczone
            query = query.Where(p => IsCurrentlyRented(p.Id));
        }
        // Je≈õli oba sƒÖ zaznaczone, pokazuj wszystkie (bez filtrowania)
        
        return query;
    }

    protected override async Task OnInitializedAsync()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());
        products = await Db.Products.AsNoTracking().OrderByDescending(p => p.CreatedAtUtc).Take(500).ToListAsync();
        await LoadCurrentlyRentedProducts();
    }

    private async Task LoadCurrentlyRentedProducts()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());
        
        var now = DateTime.UtcNow;
        currentlyRentedProductIds = await Db.RentalItems
            .Where(ri => Db.Rentals.Any(r => r.Id == ri.RentalId 
                && r.StartDateUtc <= now 
                && r.EndDateUtc >= now 
                && r.Status != RentalStatus.Cancelled 
                && r.Status != RentalStatus.Completed))
            .Select(ri => ri.ProductId)
            .Distinct()
            .ToHashSetAsync();
    }

    private bool IsCurrentlyRented(Guid productId)
    {
        return currentlyRentedProductIds.Contains(productId);
    }

    private void CreateNew()
    {
        model = new Product { Id = Guid.Empty, TenantId = CurrentTenantId(), IsActive = true };
        dialogOpen = true;
        Snackbar.Add("Otwieram formularz dodawania produktu", MudBlazor.Severity.Info);
        StateHasChanged();
    }


    private void Edit(Product p)
    {
        model = new Product
        {
            Id = p.Id,
            TenantId = p.TenantId,
            Name = p.Name,
            Sku = p.Sku,
            Category = p.Category,
            DailyPrice = p.DailyPrice,
            IsActive = p.IsActive,
            ImageUrl = p.ImageUrl,
            AvailableQuantity = p.AvailableQuantity
        };
        dialogOpen = true;
    }

    private async Task Save()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());
        if (model.Id == Guid.Empty)
        {
            model.Id = Guid.NewGuid();
            model.CreatedAtUtc = DateTime.UtcNow;
            model.TenantId = CurrentTenantId();
            await Db.Products.AddAsync(model);
        }
        else
        {
            Db.Products.Update(model);
        }
        await Db.SaveChangesAsync();
        
        // Upload image (either cropped or original)
        if (!string.IsNullOrEmpty(_croppedBase64Image) || _selectedImage is not null)
        {
            using var content = new MultipartFormDataContent();
            
            if (!string.IsNullOrEmpty(_croppedBase64Image))
            {
                // Use cropped image (base64)
                var base64Data = _croppedBase64Image.Contains(",") 
                    ? _croppedBase64Image.Split(',')[1] 
                    : _croppedBase64Image;
                var bytes = Convert.FromBase64String(base64Data);
                var streamContent = new ByteArrayContent(bytes);
                streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("image/jpeg");
                content.Add(streamContent, "file", "cropped-image.jpg");
            }
            else if (_selectedImage is not null)
            {
                // Use original image (no crop)
                content.Add(new StreamContent(_selectedImage.OpenReadStream(10 * 1024 * 1024)), "file", _selectedImage.Name);
            }
            
            var client = new HttpClient { BaseAddress = new Uri(Navigation.ToAbsoluteUri("/").ToString()) };
            var res = await client.PostAsync($"api/products/{model.Id}/image", content);
            
            if (res.IsSuccessStatusCode)
            {
                var json = await res.Content.ReadFromJsonAsync<ImageResponse>();
                model.ImageUrl = json?.imageUrl;
                Snackbar.Add("Zdjƒôcie zapisane pomy≈õlnie!", Severity.Success);
            }
            else
            {
                Snackbar.Add("B≈ÇƒÖd podczas zapisywania zdjƒôcia", Severity.Error);
            }
            
            // Clear after upload
            _selectedImage = null;
            _croppedBase64Image = null;
            _selectedImageName = null;
        }
        products = await Db.Products.AsNoTracking().OrderByDescending(p => p.CreatedAtUtc).Take(500).ToListAsync();
        dialogOpen = false;
        StateHasChanged();
    }

    private void Cancel()
    {
        dialogOpen = false;
        StateHasChanged();
    }

    [Inject] private SportRental.Infrastructure.Tenancy.ITenantProvider TenantProvider { get; set; } = default!;
    private Guid CurrentTenantId() => TenantProvider.GetCurrentTenantId() ?? Guid.Empty;

    private string GetProductIcon(string? category) => category?.ToLower() switch
    {
        "pi≈Çka" or "pi≈Çki" => Icons.Material.Filled.SportsSoccer,
        "tenis" or "badminton" => Icons.Material.Filled.SportsTennis,
        "koszyk√≥wka" => Icons.Material.Filled.SportsBasketball,
        "si≈Çownia" or "fitness" => Icons.Material.Filled.FitnessCenter,
        "rower" or "rowery" => Icons.Material.Filled.DirectionsBike,
        "narty" or "snowboard" => Icons.Material.Filled.DownhillSkiing,
        "wodne" or "kajak" => Icons.Material.Filled.Kayaking,
        "bieganie" => Icons.Material.Filled.DirectionsRun,
        "golf" => Icons.Material.Filled.GolfCourse,
        "l√≥d" or "hokej" => Icons.Material.Filled.SportsHockey,
        _ => Icons.Material.Filled.SportsTennis
    };

    private async Task Delete(Product p)
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());
        Db.Products.Remove(p);
        await Db.SaveChangesAsync();
        products.RemoveAll(x => x.Id == p.Id);
        Snackbar.Add($"Produkt '{p.Name}' zosta≈Ç usuniƒôty", Severity.Success);
        StateHasChanged();
    }

    private async Task ToggleActive(Product p)
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(CurrentTenantId());
        p.IsActive = !p.IsActive;
        Db.Products.Update(p);
        await Db.SaveChangesAsync();
        
        // Aktualizuj lokalnƒÖ listƒô
        var localProduct = products.FirstOrDefault(x => x.Id == p.Id);
        if (localProduct != null)
        {
            localProduct.IsActive = p.IsActive;
        }
        
        Snackbar.Add($"Produkt '{p.Name}' zosta≈Ç {(p.IsActive ? "aktywowany" : "deaktywowany")}", Severity.Success);
        StateHasChanged();
    }
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    private IBrowserFile? _selectedImage;
    private string? _croppedBase64Image;
    private class ImageResponse { public string? imageUrl { get; set; } }
    
    // Called when user skips crop
    private void OnImageReadySkipCrop(IBrowserFile file)
    {
        _selectedImage = file;
        _selectedImageName = file?.Name;
        _croppedBase64Image = null; // Use original file
    }

    // Called when user crops image
    private void OnImageReadyCropped(string base64Image)
    {
        _croppedBase64Image = base64Image;
        _selectedImageName = "cropped-image.jpg";
        _selectedImage = null; // Will use base64 instead
    }

    private static string Alt(Product p) => string.IsNullOrWhiteSpace(p.ImageAlt) ? p.Name : p.ImageAlt!;
    
    private static string Img(Product p, int width)
    {
        if (string.IsNullOrWhiteSpace(p.ImageUrl))
            return string.Empty;

        // Check if ImageUrl is a full URL (Azure Blob, S3, etc.)
        if (p.ImageUrl.StartsWith("http://", StringComparison.OrdinalIgnoreCase) || 
            p.ImageUrl.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
        {
            // Replace w800 (or any wXXX) with requested width in the URL
            var ext = Path.GetExtension(p.ImageUrl);
            var urlWithoutFilename = p.ImageUrl.Substring(0, p.ImageUrl.LastIndexOf('/') + 1);
            return $"{urlWithoutFilename}w{width}{ext}";
        }

        // Fallback to relative path (for local storage)
        if (!string.IsNullOrWhiteSpace(p.ImageBasePath))
        {
            return $"/{p.ImageBasePath}/w{width}{Path.GetExtension(p.ImageUrl)}";
        }

        return p.ImageUrl;
    }
    
    private static string SrcSet(Product p)
    {
        if (string.IsNullOrWhiteSpace(p.ImageUrl))
            return string.Empty;

        var ext = Path.GetExtension(p.ImageUrl);
        
        // Check if ImageUrl is a full URL (Azure Blob, S3, etc.)
        if (!string.IsNullOrEmpty(p.ImageUrl) &&
            (p.ImageUrl.StartsWith("http://", StringComparison.OrdinalIgnoreCase) || 
            p.ImageUrl.StartsWith("https://", StringComparison.OrdinalIgnoreCase)))
        {
            // Build srcset with full URLs
            var lastSlashIndex = p.ImageUrl.LastIndexOf('/');
            if (lastSlashIndex > 0)
            {
                var urlWithoutFilename = p.ImageUrl.Substring(0, lastSlashIndex + 1);
                return $"{urlWithoutFilename}w400{ext} 400w, {urlWithoutFilename}w800{ext} 800w, {urlWithoutFilename}w1280{ext} 1280w";
            }
        }

        // Fallback to relative paths (for local storage)
        if (!string.IsNullOrWhiteSpace(p.ImageBasePath))
        {
            return $"/{p.ImageBasePath}/w400{ext} 400w, /{p.ImageBasePath}/w800{ext} 800w, /{p.ImageBasePath}/w1280{ext} 1280w";
        }

        return string.Empty;
    }
}
