@page "/admin/company-settings"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Owner,SuperAdmin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject SportRental.Infrastructure.Tenancy.ITenantProvider TenantProvider
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Ustawienia firmy</MudText>
    
    @if (tenant == null)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else
    {
        <MudGrid Spacing="3">
            <MudItem xs="12" md="6">
                <MudPaper Class="p-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Informacje podstawowe</MudText>
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                        <MudText Typo="Typo.body2">
                            ðŸ“„ Te dane bÄ™dÄ… automatycznie uwzglÄ™dniane w umowach PDF wysyÅ‚anych do klientÃ³w!
                        </MudText>
                    </MudAlert>
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="tenant.Name" Label="Nazwa firmy" Required="true" />
                        <MudTextField @bind-Value="companyInfo.Address" Label="Adres" Lines="2" />
                        <MudTextField @bind-Value="companyInfo.PhoneNumber" Label="Telefon" />
                        <MudTextField @bind-Value="companyInfo.Email" Label="Email" InputType="InputType.Email" />
                        <MudTextField @bind-Value="companyInfo.NIP" Label="NIP" HelperText="10 cyfr" MaxLength="20" />
                        <MudTextField @bind-Value="companyInfo.REGON" Label="REGON" HelperText="9 lub 14 cyfr" MaxLength="14" />
                        <MudTextField @bind-Value="companyInfo.LegalForm" Label="Forma prawna" />
                        <MudTextField @bind-Value="companyInfo.OpeningHours" Label="Godziny otwarcia" />
                        <MudTextField @bind-Value="companyInfo.Description" Label="Opis" Lines="2" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudPaper Class="p-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Personalizacja</MudText>
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="tenant.PrimaryColorHex" Label="Kolor gÅ‚Ã³wny (#RRGGBB)" />
                        <MudTextField @bind-Value="tenant.SecondaryColorHex" Label="Kolor dodatkowy (#RRGGBB)" />
                        <MudText Typo="Typo.caption">Logo firmy (PNG/SVG)</MudText>
                        <InputFile OnChange="OnLogoSelected" accept="image/*" />
                        @if (!string.IsNullOrWhiteSpace(tenant.LogoUrl))
                        {
                            <div>
                                <MudText Typo="Typo.caption">Obecne logo:</MudText>
                                <img src="@tenant.LogoUrl" alt="Logo" style="max-height: 80px; max-width: 200px;" />
                            </div>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudPaper Class="p-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Szablony SMS</MudText>
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="companyInfo.SmsThanksText" 
                                      Label="SMS - podziÄ™kowanie" 
                                      Lines="2"
                                      HelperText="SMS po zakoÅ„czeniu wynajmu" />
                        <MudTextField @bind-Value="companyInfo.SmsReminderText" 
                                      Label="SMS - przypomnienie 1" 
                                      Lines="2" />
                        <MudTextField @bind-Value="companyInfo.SmsReminderText2" 
                                      Label="SMS - przypomnienie 2" 
                                      Lines="2" />
                        <MudTextField @bind-Value="companyInfo.SmsReminderText3" 
                                      Label="SMS - przypomnienie 3" 
                                      Lines="2" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudPaper Class="p-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Szablony Email</MudText>
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="companyInfo.EmailThanksText" 
                                      Label="Email - podziÄ™kowanie" 
                                      Lines="3"
                                      HelperText="Email po zakoÅ„czeniu wynajmu" />
                        <MudTextField @bind-Value="companyInfo.EmailReminderText" 
                                      Label="Email - przypomnienie 1" 
                                      Lines="3" />
                        <MudTextField @bind-Value="companyInfo.EmailReminderText2" 
                                      Label="Email - przypomnienie 2" 
                                      Lines="3" />
                        <MudTextField @bind-Value="companyInfo.EmailReminderText3" 
                                      Label="Email - przypomnienie 3" 
                                      Lines="3" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12">
                <MudPaper Class="p-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Dodatkowe informacje</MudText>
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="companyInfo.ExtraInfo" 
                                      Label="Dodatkowe informacje" 
                                      Lines="3"
                                      HelperText="Informacje dodatkowe o firmie" />
                        <MudText Typo="Typo.subtitle2">Lokalizacja GPS</MudText>
                        <MudStack Row="true" Spacing="2">
                            <MudNumericField T="double?" @bind-Value="companyInfo.Lat" Label="SzerokoÅ›Ä‡ geograficzna" />
                            <MudNumericField T="double?" @bind-Value="companyInfo.Lon" Label="DÅ‚ugoÅ›Ä‡ geograficzna" />
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12">
                <MudStack Row="true" Spacing="2" Class="mud-justify-end">
                    <MudButton Href="/admin/owner" Variant="Variant.Outlined">Anuluj</MudButton>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save" Disabled="@isSaving">
                        @if (isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ml-2">Zapisywanie...</MudText>
                        }
                        else
                        {
                            <MudText>Zapisz ustawienia</MudText>
                        }
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private Tenant? tenant;
    private CompanyInfoDto companyInfo = new();
    private IBrowserFile? selectedLogoFile;
    private bool isSaving = false;
    
    private Guid TenantId => TenantProvider.GetCurrentTenantId() ?? Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        Db.SetTenant(TenantId);
        
        tenant = await Db.Tenants.FirstOrDefaultAsync(t => t.Id == TenantId);
        if (tenant == null)
        {
            // UtwÃ³rz nowy tenant jeÅ›li nie istnieje (dla SuperAdmina)
            if (TenantId != Guid.Empty)
            {
                tenant = new Tenant { Id = TenantId, Name = "Nowa wypoÅ¼yczalnia" };
                Db.Tenants.Add(tenant);
                await Db.SaveChangesAsync();
                Snackbar.Add("Utworzono nowÄ… firmÄ™ - uzupeÅ‚nij dane", Severity.Info);
            }
            else
            {
                Snackbar.Add("Nie znaleziono danych firmy - zaloguj siÄ™ ponownie", Severity.Error);
                return;
            }
        }

        var existingCompanyInfo = await Db.CompanyInfos.FirstOrDefaultAsync(ci => ci.TenantId == TenantId);
        if (existingCompanyInfo != null)
        {
            companyInfo = new CompanyInfoDto
            {
                Address = existingCompanyInfo.Address,
                PhoneNumber = existingCompanyInfo.PhoneNumber,
                Email = existingCompanyInfo.Email,
                NIP = existingCompanyInfo.NIP,
                REGON = existingCompanyInfo.REGON,
                LegalForm = existingCompanyInfo.LegalForm,
                OpeningHours = existingCompanyInfo.OpeningHours,
                Description = existingCompanyInfo.Description,
                ExtraInfo = existingCompanyInfo.ExtraInfo,
                Lat = existingCompanyInfo.Lat,
                Lon = existingCompanyInfo.Lon,
                SmsThanksText = existingCompanyInfo.SmsThanksText,
                SmsReminderText = existingCompanyInfo.SmsReminderText,
                SmsReminderText2 = existingCompanyInfo.SmsReminderText2,
                SmsReminderText3 = existingCompanyInfo.SmsReminderText3,
                EmailThanksText = existingCompanyInfo.EmailThanksText,
                EmailReminderText = existingCompanyInfo.EmailReminderText,
                EmailReminderText2 = existingCompanyInfo.EmailReminderText2,
                EmailReminderText3 = existingCompanyInfo.EmailReminderText3
            };
        }
    }

    private void OnLogoSelected(InputFileChangeEventArgs e)
    {
        selectedLogoFile = e.File;
    }

    private async Task Save()
    {
        if (tenant == null) return;
        
        isSaving = true;
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            Db.SetTenant(TenantId);
            
            // Update tenant info
            Db.Tenants.Update(tenant);
            
            // Handle logo upload
            if (selectedLogoFile != null)
            {
                using var content = new MultipartFormDataContent();
                content.Add(new StreamContent(selectedLogoFile.OpenReadStream(5 * 1024 * 1024)), "file", selectedLogoFile.Name);
                
                var client = new HttpClient { BaseAddress = new Uri(Navigation.ToAbsoluteUri("/").ToString()) };
                var res = await client.PostAsync($"api/tenants/{TenantId}/logo", content);
                if (res.IsSuccessStatusCode)
                {
                    var json = await res.Content.ReadFromJsonAsync<LogoResponse>();
                    tenant.LogoUrl = json?.logoUrl;
                }
            }
            
            // Update or create company info
            var existingCompanyInfo = await Db.CompanyInfos.FirstOrDefaultAsync(ci => ci.TenantId == TenantId);
            if (existingCompanyInfo != null)
            {
                existingCompanyInfo.Address = companyInfo.Address;
                existingCompanyInfo.PhoneNumber = companyInfo.PhoneNumber;
                existingCompanyInfo.Email = companyInfo.Email;
                existingCompanyInfo.NIP = companyInfo.NIP;
                existingCompanyInfo.REGON = companyInfo.REGON;
                existingCompanyInfo.LegalForm = companyInfo.LegalForm;
                existingCompanyInfo.OpeningHours = companyInfo.OpeningHours;
                existingCompanyInfo.Description = companyInfo.Description;
                existingCompanyInfo.ExtraInfo = companyInfo.ExtraInfo;
                existingCompanyInfo.Lat = companyInfo.Lat;
                existingCompanyInfo.Lon = companyInfo.Lon;
                existingCompanyInfo.SmsThanksText = companyInfo.SmsThanksText;
                existingCompanyInfo.SmsReminderText = companyInfo.SmsReminderText;
                existingCompanyInfo.SmsReminderText2 = companyInfo.SmsReminderText2;
                existingCompanyInfo.SmsReminderText3 = companyInfo.SmsReminderText3;
                existingCompanyInfo.EmailThanksText = companyInfo.EmailThanksText;
                existingCompanyInfo.EmailReminderText = companyInfo.EmailReminderText;
                existingCompanyInfo.EmailReminderText2 = companyInfo.EmailReminderText2;
                existingCompanyInfo.EmailReminderText3 = companyInfo.EmailReminderText3;
                existingCompanyInfo.UpdatedAtUtc = DateTime.UtcNow;
                
                Db.CompanyInfos.Update(existingCompanyInfo);
            }
            else
            {
                var newCompanyInfo = new CompanyInfo
                {
                    Id = Guid.NewGuid(),
                    TenantId = TenantId,
                    Address = companyInfo.Address,
                    PhoneNumber = companyInfo.PhoneNumber,
                    Email = companyInfo.Email,
                    NIP = companyInfo.NIP,
                    REGON = companyInfo.REGON,
                    LegalForm = companyInfo.LegalForm,
                    OpeningHours = companyInfo.OpeningHours,
                    Description = companyInfo.Description,
                    ExtraInfo = companyInfo.ExtraInfo,
                    Lat = companyInfo.Lat,
                    Lon = companyInfo.Lon,
                    SmsThanksText = companyInfo.SmsThanksText,
                    SmsReminderText = companyInfo.SmsReminderText,
                    SmsReminderText2 = companyInfo.SmsReminderText2,
                    SmsReminderText3 = companyInfo.SmsReminderText3,
                    EmailThanksText = companyInfo.EmailThanksText,
                    EmailReminderText = companyInfo.EmailReminderText,
                    EmailReminderText2 = companyInfo.EmailReminderText2,
                    EmailReminderText3 = companyInfo.EmailReminderText3,
                    CreatedAtUtc = DateTime.UtcNow,
                    UpdatedAtUtc = DateTime.UtcNow
                };
                
                await Db.CompanyInfos.AddAsync(newCompanyInfo);
            }
            
            await Db.SaveChangesAsync();
            
            Snackbar.Add("Ustawienia zostaÅ‚y zapisane", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"BÅ‚Ä…d podczas zapisywania: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private class CompanyInfoDto
    {
        public string? Address { get; set; }
        public string? PhoneNumber { get; set; }
        public string? Email { get; set; }
        public string? NIP { get; set; }
        public string? REGON { get; set; }
        public string? LegalForm { get; set; }
        public string? OpeningHours { get; set; }
        public string? Description { get; set; }
        public string? ExtraInfo { get; set; }
        public double? Lat { get; set; }
        public double? Lon { get; set; }
        public string? SmsThanksText { get; set; }
        public string? SmsReminderText { get; set; }
        public string? SmsReminderText2 { get; set; }
        public string? SmsReminderText3 { get; set; }
        public string? EmailThanksText { get; set; }
        public string? EmailReminderText { get; set; }
        public string? EmailReminderText2 { get; set; }
        public string? EmailReminderText3 { get; set; }
    }

    private class LogoResponse 
    { 
        public string? logoUrl { get; set; } 
    }
}
