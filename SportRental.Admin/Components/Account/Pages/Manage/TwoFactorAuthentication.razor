@page "/Account/Manage/TwoFactorAuthentication"

@using Microsoft.AspNetCore.Http.Features
@using Microsoft.AspNetCore.Identity
@using SportRental.Admin.Data
@using MudBlazor

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager

<PageTitle>Weryfikacja dwuetapowa - SportRental</PageTitle>

<MudStack Spacing="3">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
        <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Primary" />
        <MudText Typo="Typo.h5">Weryfikacja dwuetapowa (2FA)</MudText>
    </MudStack>

    <StatusMessage />
    
    @if (canTrack)
    {
        @if (is2faEnabled)
        {
            <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.Shield" Class="mb-3">
                Weryfikacja dwuetapowa jest <strong>włączona</strong>.
            </MudAlert>
            
            @if (recoveryCodesLeft == 0)
            {
                <MudAlert Severity="Severity.Error" Icon="@Icons.Material.Filled.Warning">
                    <strong>Nie masz żadnych kodów odzyskiwania!</strong><br/>
                    Musisz <MudLink Href="Account/Manage/GenerateRecoveryCodes">wygenerować nowe kody</MudLink> przed kolejnym logowaniem.
                </MudAlert>
            }
            else if (recoveryCodesLeft == 1)
            {
                <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Filled.Warning">
                    <strong>Pozostał tylko 1 kod odzyskiwania.</strong><br/>
                    Zalecamy <MudLink Href="Account/Manage/GenerateRecoveryCodes">wygenerowanie nowych kodów</MudLink>.
                </MudAlert>
            }
            else if (recoveryCodesLeft <= 3)
            {
                <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Filled.Info">
                    <strong>Pozostało @recoveryCodesLeft kody odzyskiwania.</strong><br/>
                    Rozważ <MudLink Href="Account/Manage/GenerateRecoveryCodes">wygenerowanie nowych kodów</MudLink>.
                </MudAlert>
            }

            <MudPaper Class="pa-4" Elevation="0" Style="background: var(--mud-palette-background-grey); border-radius: 12px;">
                <MudText Typo="Typo.h6" Class="mb-3">Zarządzanie 2FA</MudText>
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    @if (isMachineRemembered)
                    {
                        <form @formname="forget-browser" @onsubmit="OnSubmitForgetBrowserAsync" method="post" style="display: inline;">
                            <AntiforgeryToken />
                            <MudButton ButtonType="ButtonType.Submit" 
                                       Variant="Variant.Outlined" 
                                       Color="Color.Default"
                                       StartIcon="@Icons.Material.Filled.DevicesOther">
                                Zapomnij tę przeglądarkę
                            </MudButton>
                        </form>
                    }
                    <MudButton Href="Account/Manage/Disable2fa" 
                               Variant="Variant.Outlined" 
                               Color="Color.Error"
                               StartIcon="@Icons.Material.Filled.Close">
                        Wyłącz 2FA
                    </MudButton>
                    <MudButton Href="Account/Manage/GenerateRecoveryCodes" 
                               Variant="Variant.Outlined" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Refresh">
                        Resetuj kody odzyskiwania
                    </MudButton>
                </MudStack>
            </MudPaper>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Outlined.Shield" Class="mb-3">
                Weryfikacja dwuetapowa jest <strong>wyłączona</strong>. Włącz ją, aby zwiększyć bezpieczeństwo konta.
            </MudAlert>
        }

        <MudPaper Class="pa-4" Elevation="0" Style="background: var(--mud-palette-background-grey); border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.PhoneAndroid" Color="Color.Primary" />
                <MudText Typo="Typo.h6">Aplikacja Authenticator</MudText>
            </MudStack>
            <MudText Typo="Typo.body2" Class="mb-3">
                Użyj aplikacji takich jak Google Authenticator, Microsoft Authenticator lub Authy do generowania kodów.
            </MudText>
            <MudStack Row="true" Spacing="2">
                @if (!hasAuthenticator)
                {
                    <MudButton Href="Account/Manage/EnableAuthenticator" 
                               Variant="Variant.Filled" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add">
                        Dodaj aplikację Authenticator
                    </MudButton>
                }
                else
                {
                    <MudButton Href="Account/Manage/EnableAuthenticator" 
                               Variant="Variant.Filled" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Settings">
                        Skonfiguruj Authenticator
                    </MudButton>
                    <MudButton Href="Account/Manage/ResetAuthenticator" 
                               Variant="Variant.Outlined" 
                               Color="Color.Warning"
                               StartIcon="@Icons.Material.Filled.RestartAlt">
                        Resetuj Authenticator
                    </MudButton>
                }
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudAlert Severity="Severity.Error" Icon="@Icons.Material.Filled.Cookie">
            <strong>Polityka prywatności nie została zaakceptowana.</strong><br/>
            Musisz zaakceptować politykę, aby móc włączyć weryfikację dwuetapową.
        </MudAlert>
    }
</MudStack>

@code {
    private bool canTrack;
    private bool hasAuthenticator;
    private int recoveryCodesLeft;
    private bool is2faEnabled;
    private bool isMachineRemembered;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        canTrack = HttpContext.Features.Get<ITrackingConsentFeature>()?.CanTrack ?? true;
        hasAuthenticator = await UserManager.GetAuthenticatorKeyAsync(user) is not null;
        is2faEnabled = await UserManager.GetTwoFactorEnabledAsync(user);
        isMachineRemembered = await SignInManager.IsTwoFactorClientRememberedAsync(user);
        recoveryCodesLeft = await UserManager.CountRecoveryCodesAsync(user);
    }

    private async Task OnSubmitForgetBrowserAsync()
    {
        await SignInManager.ForgetTwoFactorClientAsync();

        RedirectManager.RedirectToCurrentPageWithStatus(
            "Ta przeglądarka została zapomniana. Przy następnym logowaniu zostaniesz poproszony o kod 2FA.",
            HttpContext);
    }
}
