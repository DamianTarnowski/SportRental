@page "/Account/ResetPassword"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using SportRental.Admin.Data

@inject IdentityRedirectManager RedirectManager
@inject UserManager<ApplicationUser> UserManager

<PageTitle>Nowe hasło - SportRental</PageTitle>

<div class="auth-page">
    <div class="auth-card">
        <div class="auth-brand-accent"></div>
        
        <div class="auth-logo">
            <div class="auth-logo-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                </svg>
            </div>
            <h1 class="auth-title">Ustaw nowe hasło</h1>
            <p class="auth-subtitle">Wprowadź nowe hasło do swojego konta</p>
        </div>

        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="auth-alert auth-alert-error">
                <svg class="auth-alert-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <span>@Message</span>
            </div>
        }

        <EditForm Model="Input" FormName="reset-password" OnValidSubmit="OnValidSubmitAsync" method="post" class="auth-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="auth-validation-summary" role="alert" />

            <input type="hidden" name="Input.Code" value="@Input.Code" />
            
            <div class="auth-field">
                <label class="auth-label" for="reset-email">Email</label>
                <svg class="auth-field-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
                <InputText id="reset-email" @bind-Value="Input.Email" class="auth-input" type="email" 
                           placeholder="twoj@email.pl" autocomplete="email" required />
                <ValidationMessage For="() => Input.Email" />
            </div>

            <div class="auth-field">
                <label class="auth-label" for="reset-password">Nowe hasło</label>
                <svg class="auth-field-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                <InputText id="reset-password" @bind-Value="Input.Password" class="auth-input" type="password" 
                           placeholder="Min. 6 znaków" autocomplete="new-password" required />
                <ValidationMessage For="() => Input.Password" />
            </div>

            <div class="auth-field">
                <label class="auth-label" for="reset-confirm">Potwierdź hasło</label>
                <svg class="auth-field-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    <path d="M9 12l2 2 4-4"/>
                </svg>
                <InputText id="reset-confirm" @bind-Value="Input.ConfirmPassword" class="auth-input" type="password" 
                           placeholder="Powtórz nowe hasło" autocomplete="new-password" required />
                <ValidationMessage For="() => Input.ConfirmPassword" />
            </div>

            <button type="submit" class="auth-submit">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 8px;">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Zapisz nowe hasło
            </button>
        </EditForm>

        <div class="auth-links">
            <a href="Account/Login" class="auth-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
                Wróć do logowania
            </a>
        </div>
        
        <div class="auth-footer">
            &copy; @DateTime.Now.Year SportRental. Wszelkie prawa zastrzeżone.
        </div>
    </div>
</div>

@code {
    private IEnumerable<IdentityError>? identityErrors;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? Code { get; set; }

    private string? Message => identityErrors is null ? null : string.Join(" ", identityErrors.Select(error => error.Description));

    protected override void OnInitialized()
    {
        if (Code is null)
        {
            RedirectManager.RedirectTo("Account/InvalidPasswordReset");
        }

        Input.Code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Code));
    }

    private async Task OnValidSubmitAsync()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user is null)
        {
            // Don't reveal that the user does not exist
            RedirectManager.RedirectTo("Account/ResetPasswordConfirmation");
        }

        var result = await UserManager.ResetPasswordAsync(user, Input.Code, Input.Password);
        if (result.Succeeded)
        {
            RedirectManager.RedirectTo("Account/ResetPasswordConfirmation");
        }

        identityErrors = result.Errors;
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Email jest wymagany")]
        [EmailAddress(ErrorMessage = "Nieprawidłowy format adresu email")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Hasło jest wymagane")]
        [StringLength(100, ErrorMessage = "Hasło musi mieć od {2} do {1} znaków.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Potwierdź hasło")]
        [Compare("Password", ErrorMessage = "Hasła muszą być identyczne.")]
        public string ConfirmPassword { get; set; } = "";

        [Required]
        public string Code { get; set; } = "";
    }
}
