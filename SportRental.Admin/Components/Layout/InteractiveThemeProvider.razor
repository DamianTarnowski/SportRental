@rendermode InteractiveServer
@implements IDisposable

@inject SportRental.Admin.Services.UI.ThemeService Theme

<MudThemeProvider @ref="_mudThemeProvider" @bind-IsDarkMode="_isDarkMode" Theme="@Theme.CurrentTheme" />

@code {
    private MudThemeProvider? _mudThemeProvider;
    private bool _isDarkMode;
    
    protected override void OnInitialized()
    {
        // Domyślnie jasny motyw
        _isDarkMode = false;
        Theme.IsDarkMode = false;
        Theme.OnChanged += HandleThemeChanged;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _mudThemeProvider != null)
        {
            try
            {
                // NIE pobieramy preferencji systemowych - zawsze zaczynamy od jasnego motywu
                // Użytkownik może przełączyć motyw ręcznie
                await _mudThemeProvider.WatchSystemPreference(OnSystemPreferenceChanged);
            }
            catch
            {
                // Ignore JS interop errors during prerendering
            }
        }
    }
    
    private async Task OnSystemPreferenceChanged(bool newValue)
    {
        // Reagujemy na zmianę preferencji systemowych tylko jeśli użytkownik tego chce
        // Na razie ignorujemy - motyw zmienia się tylko przez przycisk
        // _isDarkMode = newValue;
        // Theme.IsDarkMode = newValue;
        // await InvokeAsync(StateHasChanged);
    }
    
    private void HandleThemeChanged()
    {
        _isDarkMode = Theme.IsDarkMode;
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        Theme.OnChanged -= HandleThemeChanged;
    }
}
