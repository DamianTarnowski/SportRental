@implements IDisposable

@inject NavigationManager NavigationManager

<MudNavMenu Class="mud-width-full py-2">
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
        Home
    </MudNavLink>
    <MudNavLink Href="dashboard" Icon="@Icons.Material.Filled.Dashboard">
        Dashboard
    </MudNavLink>

    <AuthorizeView>
        <Authorized>
            <AuthorizeView Roles="SuperAdmin" Context="superCtx">
                <MudNavLink Href="admin/super" Icon="@Icons.Material.Filled.AdminPanelSettings">
                    SuperAdmin
                </MudNavLink>
            </AuthorizeView>
            
            @* Sekcja dla Owner i SuperAdmin - pełny dostęp *@
            <AuthorizeView Roles="Owner,SuperAdmin" Context="ownerCtx">
                <MudNavGroup Title="Zarządzanie" Icon="@Icons.Material.Filled.Business" @bind-Expanded="_managementExpanded">
                    <MudNavLink Href="admin/owner" Icon="@Icons.Material.Filled.Stars">
                        Panel właściciela
                    </MudNavLink>
                    <MudNavLink Href="admin/products" Icon="@Icons.Material.Filled.Inventory">
                        Produkty
                    </MudNavLink>
                    <MudNavLink Href="admin/customers" Icon="@Icons.Material.Filled.Groups">
                        Klienci
                    </MudNavLink>
                    <MudNavLink Href="admin/rentals" Icon="@Icons.Material.Filled.Assignment">
                        Wynajmy
                    </MudNavLink>
                    <MudNavLink Href="admin/equipment-handling" Icon="@Icons.Material.Filled.LocalShipping">
                        Wydania/Zwroty
                    </MudNavLink>
                    <MudNavLink Href="admin/schedule" Icon="@Icons.Material.Filled.CalendarMonth">
                        Kalendarz
                    </MudNavLink>
                </MudNavGroup>
                
                <MudNavGroup Title="Ustawienia" Icon="@Icons.Material.Filled.Settings" @bind-Expanded="_settingsExpanded">
                    <MudNavLink Href="admin/contract-template" Icon="@Icons.Material.Filled.Description">
                        Szablon umowy
                    </MudNavLink>
                    <MudNavLink Href="admin/employees" Icon="@Icons.Material.Filled.Badge">
                        Pracownicy
                    </MudNavLink>
                    <MudNavLink Href="admin/reports" Icon="@Icons.Material.Filled.Analytics">
                        Raporty
                    </MudNavLink>
                    <MudNavLink Href="admin/company-settings" Icon="@Icons.Material.Filled.Store">
                        Ustawienia firmy
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>
            
            @* Sekcja dla Employee - ograniczony dostęp (bez szablonu umowy, ustawień firmy, pracowników) *@
            <AuthorizeView Roles="Employee" Context="employeeCtx">
                @* Pokaż tylko jeśli NIE jest Owner/SuperAdmin (bo wtedy ma pełne menu powyżej) *@
                @if (!context.User.IsInRole("Owner") && !context.User.IsInRole("SuperAdmin"))
                {
                    <MudNavGroup Title="Zarządzanie" Icon="@Icons.Material.Filled.Business" @bind-Expanded="_managementExpanded">
                        <MudNavLink Href="admin/products" Icon="@Icons.Material.Filled.Inventory">
                            Produkty
                        </MudNavLink>
                        <MudNavLink Href="admin/customers" Icon="@Icons.Material.Filled.Groups">
                            Klienci
                        </MudNavLink>
                        <MudNavLink Href="admin/rentals" Icon="@Icons.Material.Filled.Assignment">
                            Wynajmy
                        </MudNavLink>
                        <MudNavLink Href="admin/equipment-handling" Icon="@Icons.Material.Filled.LocalShipping">
                            Wydania/Zwroty
                        </MudNavLink>
                        <MudNavLink Href="admin/schedule" Icon="@Icons.Material.Filled.CalendarMonth">
                            Kalendarz
                        </MudNavLink>
                    </MudNavGroup>
                }
            </AuthorizeView>
            
            <MudDivider Class="my-2" />
            
            <MudNavLink Href="Account/Manage" Icon="@Icons.Material.Filled.Person">
                @context.User.Identity?.Name
            </MudNavLink>
            <MudNavLink Href="Account/Logout" Icon="@Icons.Material.Filled.Logout" IconColor="Color.Error">
                Wyloguj
            </MudNavLink>
        </Authorized>
        <NotAuthorized>
            <MudDivider Class="my-2" />
            <MudNavLink Href="Account/Register" Icon="@Icons.Material.Filled.PersonAdd">
                Rejestracja
            </MudNavLink>
            <MudNavLink Href="Account/Login" Icon="@Icons.Material.Filled.Login">
                Logowanie
            </MudNavLink>
        </NotAuthorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    private string? currentUrl;
    private bool _managementExpanded = true;
    private bool _settingsExpanded = false;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
