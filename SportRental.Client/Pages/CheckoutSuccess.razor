@page "/checkout/success"
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@using SportRental.Client.Services
@inject NavigationManager NavigationManager
@inject IApiService ApiService
@inject ICustomerSessionService CustomerSession
@inject ISnackbar Snackbar

<PageTitle>P≈Çatno≈õƒá zako≈Ñczona sukcesem - SportRental</PageTitle>

<div class="success-container">
    @if (_isLoading)
    {
        <div class="success-card">
            <div class="w-20 h-20 border-4 border-green-200 border-t-green-500 rounded-full animate-spin mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold text-gray-800">≈Åadowanie szczeg√≥≈Ç√≥w rezerwacji...</h2>
        </div>
    }
    else
    {
        <div class="success-card">
            <div class="success-icon">‚úì</div>
            <h1 class="success-title">P≈Çatno≈õƒá zako≈Ñczona sukcesem! üéâ</h1>
            <p class="success-subtitle">
                Dziƒôkujemy za wypo≈ºyczenie sprzƒôtu. Twoja rezerwacja zosta≈Ça potwierdzona.
            </p>

            @if (!string.IsNullOrEmpty(SessionId))
            {
                <div class="inline-block px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm mb-6">
                    ID p≈Çatno≈õci: <code class="font-mono">@SessionId[..Math.Min(20, SessionId.Length)]...</code>
                </div>
            }

            @if (_latestRental != null)
            {
                <div class="success-details">
                    <div class="text-lg font-semibold text-gray-800 mb-4">üìã Szczeg√≥≈Çy rezerwacji</div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">üë§ Klient</span>
                        <span class="font-medium">@_latestRental.CustomerName</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">üìÖ Od</span>
                        <span class="font-medium">@_latestRental.StartDateUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">üìÖ Do</span>
                        <span class="font-medium">@_latestRental.EndDateUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">üí∞ Kwota</span>
                        <span class="font-bold text-green-600">@_latestRental.TotalAmount.ToString("C")</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">üîê Depozyt</span>
                        <span class="font-medium">@_latestRental.DepositAmount.ToString("C")</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">üìä Status</span>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                            @_latestRental.Status
                        </span>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-sm font-medium text-gray-700 mb-2">üì¶ Wypo≈ºyczone produkty:</div>
                        @foreach (var item in _latestRental.Items)
                        {
                            <div class="flex justify-between text-sm py-1">
                                <span>@item.ProductName √ó @item.Quantity</span>
                                <span class="text-gray-600">@item.TotalPrice.ToString("C")</span>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(_latestRental.ContractUrl))
                    {
                        <div class="mt-4 p-4 bg-green-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">üìÑ</span>
                                <div>
                                    <div class="font-medium text-green-800">Umowa jest gotowa!</div>
                                    <a href="@_latestRental.ContractUrl" target="_blank" class="text-green-600 hover:underline text-sm">
                                        Pobierz umowƒô (PDF)
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (_loadError != null)
            {
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-yellow-800 mb-6">
                    ‚ö†Ô∏è Nie uda≈Ço siƒô pobraƒá szczeg√≥≈Ç√≥w rezerwacji, ale p≈Çatno≈õƒá zosta≈Ça przyjƒôta pomy≈õlnie.
                </div>
            }

            <p class="text-gray-500 text-sm mb-8">
                Szczeg√≥≈Çy rezerwacji zosta≈Çy wys≈Çane na Tw√≥j adres email.<br />
                Mo≈ºesz teraz odebraƒá sprzƒôt w naszym punkcie.
            </p>

            <div class="success-actions">
                <a href="/my-rentals" class="checkout-submit-btn" style="text-decoration: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    üìã Moje wypo≈ºyczenia
                </a>
                <a href="/" class="product-details-back-btn" style="text-decoration: none;">
                    üè† Strona g≈Ç√≥wna
                </a>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "session_id")]
    public string? SessionId { get; set; }

    private bool _isLoading = true;
    private MyRentalDto? _latestRental;
    private string? _loadError;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        
        try
        {
            // Najpierw spr√≥buj sfinalizowaƒá sesjƒô (utworzyƒá rental je≈õli webhook nie zadzia≈Ça≈Ç)
            if (!string.IsNullOrEmpty(SessionId))
            {
                await FinalizeSessionAsync(SessionId);
            }

            // Pobierz customerId z sesji
            var customer = await CustomerSession.GetCustomerAsync();
            var customerId = customer?.Id;

            // Pobierz wypo≈ºyczenia dla tego klienta
            var rentals = await ApiService.GetMyRentalsAsync(customerId: customerId);
            
            if (rentals != null && rentals.Any())
            {
                _latestRental = rentals
                    .OrderByDescending(r => r.StartDateUtc)
                    .FirstOrDefault();
            }
        }
        catch (Exception ex)
        {
            _loadError = ex.Message;
            Snackbar.Add($"Nie uda≈Ço siƒô pobraƒá szczeg√≥≈Ç√≥w rezerwacji: {ex.Message}", Severity.Warning);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task FinalizeSessionAsync(string sessionId)
    {
        try
        {
            var response = await ApiService.FinalizeCheckoutSessionAsync(sessionId);
            if (response != null && response.Success)
            {
                Console.WriteLine($"[CheckoutSuccess] Session finalized: {response.Message}, RentalId: {response.RentalId}");
            }
            else if (response != null)
            {
                Console.WriteLine($"[CheckoutSuccess] Session not finalized: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            // Nie pokazuj b≈Çƒôdu - mo≈ºe webhook ju≈º zadzia≈Ça≈Ç
            Console.WriteLine($"[CheckoutSuccess] Finalize error (may be OK if webhook worked): {ex.Message}");
        }
    }
}
