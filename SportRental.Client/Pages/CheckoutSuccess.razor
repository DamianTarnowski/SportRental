@page "/checkout/success"
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@inject NavigationManager NavigationManager
@inject IApiService ApiService
@inject ISnackbar Snackbar

<PageTitle>PÅ‚atnoÅ›Ä‡ zakoÅ„czona sukcesem - SportRental</PageTitle>

<div class="success-container">
    @if (_isLoading)
    {
        <div class="success-card">
            <div class="w-20 h-20 border-4 border-green-200 border-t-green-500 rounded-full animate-spin mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold text-gray-800">Åadowanie szczegÃ³Å‚Ã³w rezerwacji...</h2>
        </div>
    }
    else
    {
        <div class="success-card">
            <div class="success-icon">âœ“</div>
            <h1 class="success-title">PÅ‚atnoÅ›Ä‡ zakoÅ„czona sukcesem! ğŸ‰</h1>
            <p class="success-subtitle">
                DziÄ™kujemy za wypoÅ¼yczenie sprzÄ™tu. Twoja rezerwacja zostaÅ‚a potwierdzona.
            </p>

            @if (!string.IsNullOrEmpty(SessionId))
            {
                <div class="inline-block px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm mb-6">
                    ID pÅ‚atnoÅ›ci: <code class="font-mono">@SessionId[..Math.Min(20, SessionId.Length)]...</code>
                </div>
            }

            @if (_latestRental != null)
            {
                <div class="success-details">
                    <div class="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ SzczegÃ³Å‚y rezerwacji</div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">ğŸ‘¤ Klient</span>
                        <span class="font-medium">@_latestRental.CustomerName</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">ğŸ“… Od</span>
                        <span class="font-medium">@_latestRental.StartDateUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">ğŸ“… Do</span>
                        <span class="font-medium">@_latestRental.EndDateUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">ğŸ’° Kwota</span>
                        <span class="font-bold text-green-600">@_latestRental.TotalAmount.ToString("C")</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">ğŸ” Depozyt</span>
                        <span class="font-medium">@_latestRental.DepositAmount.ToString("C")</span>
                    </div>
                    
                    <div class="success-details-row">
                        <span class="text-gray-600">ğŸ“Š Status</span>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                            @_latestRental.Status
                        </span>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-sm font-medium text-gray-700 mb-2">ğŸ“¦ WypoÅ¼yczone produkty:</div>
                        @foreach (var item in _latestRental.Items)
                        {
                            <div class="flex justify-between text-sm py-1">
                                <span>@item.ProductName Ã— @item.Quantity</span>
                                <span class="text-gray-600">@item.TotalPrice.ToString("C")</span>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(_latestRental.ContractUrl))
                    {
                        <div class="mt-4 p-4 bg-green-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ğŸ“„</span>
                                <div>
                                    <div class="font-medium text-green-800">Umowa jest gotowa!</div>
                                    <a href="@_latestRental.ContractUrl" target="_blank" class="text-green-600 hover:underline text-sm">
                                        Pobierz umowÄ™ (PDF)
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (_loadError != null)
            {
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-yellow-800 mb-6">
                    âš ï¸ Nie udaÅ‚o siÄ™ pobraÄ‡ szczegÃ³Å‚Ã³w rezerwacji, ale pÅ‚atnoÅ›Ä‡ zostaÅ‚a przyjÄ™ta pomyÅ›lnie.
                </div>
            }

            <p class="text-gray-500 text-sm mb-8">
                SzczegÃ³Å‚y rezerwacji zostaÅ‚y wysÅ‚ane na TwÃ³j adres email.<br />
                MoÅ¼esz teraz odebraÄ‡ sprzÄ™t w naszym punkcie.
            </p>

            <div class="success-actions">
                <a href="/my-rentals" class="checkout-submit-btn" style="text-decoration: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    ğŸ“‹ Moje wypoÅ¼yczenia
                </a>
                <a href="/" class="product-details-back-btn" style="text-decoration: none;">
                    ğŸ  Strona gÅ‚Ã³wna
                </a>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "session_id")]
    public string? SessionId { get; set; }

    private bool _isLoading = true;
    private MyRentalDto? _latestRental;
    private string? _loadError;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        
        try
        {
            var rentals = await ApiService.GetMyRentalsAsync();
            
            if (rentals != null && rentals.Any())
            {
                _latestRental = rentals
                    .OrderByDescending(r => r.StartDateUtc)
                    .FirstOrDefault();
            }
        }
        catch (Exception ex)
        {
            _loadError = ex.Message;
            Snackbar.Add($"Nie udaÅ‚o siÄ™ pobraÄ‡ szczegÃ³Å‚Ã³w rezerwacji: {ex.Message}", Severity.Warning);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
