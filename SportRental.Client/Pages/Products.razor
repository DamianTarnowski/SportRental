@page "/products"
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@using SportRental.Shared.Models
@inject IApiService ApiService
@inject ICartService CartService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>SportRental - Katalog produktów</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-4">
    
    <!-- =============================================
         HERO SECTION
         ============================================= -->
    <div class="products-hero">
        <div class="products-hero-content">
            <h1 class="products-hero-title">🎿 Znajdź swoją przygodę</h1>
            <p class="products-hero-subtitle">
                Przeglądaj nasz katalog profesjonalnego sprzętu sportowego
            </p>
            <div class="products-stats">
                <div class="products-stat">
                    <span class="products-stat-icon">📦</span>
                    <span class="products-stat-value">@products.Count</span>
                    <span class="products-stat-label">produktów</span>
                </div>
                <div class="products-stat">
                    <span class="products-stat-icon">✅</span>
                    <span class="products-stat-value">@availableCount</span>
                    <span class="products-stat-label">dostępnych</span>
                </div>
                <div class="products-stat">
                    <span class="products-stat-icon">💰</span>
                    <span class="products-stat-value">@averagePrice.ToString("C")</span>
                    <span class="products-stat-label">śr. cena</span>
                </div>
            </div>
        </div>
    </div>

    <!-- =============================================
         FILTERS SECTION
         ============================================= -->
    <div class="products-filters">
        <MudGrid Spacing="3">
            <!-- Search -->
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="searchText"
                              Label="🔍 Szukaj produktów"
                              Placeholder="Wpisz nazwę..."
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              OnKeyDown="OnSearchKeyDown"
                              Style="border-radius: 12px;" />
            </MudItem>
            
            <!-- Category chips -->
            <MudItem xs="12" md="8">
                <div class="filter-section-title">Kategorie</div>
                <div class="filter-chips">
                    <div class="filter-chip @(string.IsNullOrEmpty(selectedCategory) ? "active" : "")" 
                         @onclick="@(() => SelectCategory(string.Empty))">
                        <span>🎯</span> Wszystkie
                    </div>
                    @foreach (var cat in GetCategoryChips())
                    {
                        <div class="filter-chip @(selectedCategory == cat.Name ? "active" : "")"
                             @onclick="@(() => SelectCategory(cat.Name))">
                            <span>@cat.Icon</span> @cat.Name
                        </div>
                    }
                </div>
            </MudItem>
            
            <!-- Additional filters row -->
            <MudItem xs="12" md="3">
                <MudSelect T="string" Label="Sortuj" @bind-Value="SelectedSort" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("featured")">⭐ Polecane</MudSelectItem>
                    <MudSelectItem Value="@("price-asc")">💵 Najtańsze</MudSelectItem>
                    <MudSelectItem Value="@("price-desc")">💎 Najdroższe</MudSelectItem>
                    <MudSelectItem Value="@("name")">🔤 Nazwa A-Z</MudSelectItem>
                </MudSelect>
            </MudItem>
            
            <MudItem xs="6" md="2">
                <MudNumericField T="decimal"
                                 Label="Cena od"
                                 Variant="Variant.Outlined"
                                 Value="selectedMinPrice"
                                 ValueChanged="OnMinPriceChanged"
                                 Adornment="Adornment.End"
                                 AdornmentText="zł"
                                 Min="@minPrice"
                                 Max="@selectedMaxPrice" />
            </MudItem>
            
            <MudItem xs="6" md="2">
                <MudNumericField T="decimal"
                                 Label="Cena do"
                                 Variant="Variant.Outlined"
                                 Value="selectedMaxPrice"
                                 ValueChanged="OnMaxPriceChanged"
                                 Adornment="Adornment.End"
                                 AdornmentText="zł"
                                 Min="@selectedMinPrice"
                                 Max="@maxPrice" />
            </MudItem>
            
            <MudItem xs="12" md="3">
                <MudSwitch @bind-Value="ShowOnlyAvailable" Color="Color.Success" Label="✅ Tylko dostępne" />
            </MudItem>
            
            <MudItem xs="12" md="2">
                <MudButton Variant="Variant.Text" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="ClearFilters"
                           FullWidth="true">
                    Resetuj
                </MudButton>
            </MudItem>
        </MudGrid>
    </div>

    <!-- =============================================
         PRODUCTS GRID
         ============================================= -->
    @if (isLoading)
    {
        <div class="products-grid">
            @for (int i = 0; i < 8; i++)
            {
                <div class="product-skeleton">
                    <div class="skeleton-shimmer" style="height: 220px;"></div>
                    <div style="padding: 1.25rem;">
                        <div class="skeleton-shimmer" style="height: 24px; border-radius: 8px; margin-bottom: 0.75rem;"></div>
                        <div class="skeleton-shimmer" style="height: 32px; width: 60%; border-radius: 8px; margin-bottom: 0.75rem;"></div>
                        <div class="skeleton-shimmer" style="height: 44px; border-radius: 12px;"></div>
                    </div>
                </div>
            }
        </div>
    }
    else if (!filteredProducts.Any())
    {
        <div class="products-empty">
            <div class="products-empty-icon">🔍</div>
            <h3 class="products-empty-title">Brak produktów</h3>
            <p class="products-empty-text">Nie znaleźliśmy produktów spełniających Twoje kryteria.</p>
            <button class="products-reset-btn" @onclick="ClearFilters">
                Resetuj filtry
            </button>
        </div>
    }
    else
    {
        <div class="products-grid">
            @foreach (var product in filteredProducts)
            {
                var imageUrl = product.GetImageUrl(400);
                var categoryIcon = GetCategoryIcon(product.Category);
                
                <div class="product-card" @onclick="@(() => ViewProduct(product))">
                    <!-- Image section -->
                    <div class="product-card-image">
                        @if (!string.IsNullOrEmpty(imageUrl))
                        {
                            <img src="@imageUrl" alt="@product.Name" loading="lazy" />
                        }
                        else
                        {
                            <div class="product-card-placeholder">
                                <span class="product-card-placeholder-icon">📷</span>
                            </div>
                        }
                        
                        <!-- Badges -->
                        <div class="product-card-badges">
                            @if (product.IsAvailable && product.AvailableQuantity > 0)
                            {
                                <span class="product-badge product-badge-available">Dostępny</span>
                            }
                            else
                            {
                                <span class="product-badge product-badge-unavailable">Niedostępny</span>
                            }
                            
                            @if (!string.IsNullOrEmpty(product.Category))
                            {
                                <span class="product-badge product-badge-category">
                                    @categoryIcon @product.Category
                                </span>
                            }
                        </div>
                        
                        <!-- Quick actions overlay -->
                        <div class="product-card-actions-overlay">
                            <button class="product-quick-btn product-quick-btn-primary"
                                    disabled="@(product.AvailableQuantity <= 0 || !product.IsAvailable)"
                                    @onclick="@(async () => await AddToCart(product))"
                                    @onclick:stopPropagation="true">
                                🛒 Do koszyka
                            </button>
                            <button class="product-quick-btn product-quick-btn-secondary"
                                    @onclick="@(() => NavigateToProduct(product.Id))"
                                    @onclick:stopPropagation="true">
                                👁️
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content section -->
                    <div class="product-card-content">
                        <h3 class="product-card-title">@product.Name</h3>
                        
                        <div class="product-card-price">
                            <span class="product-price-amount">@product.DailyPrice.ToString("N0") zł</span>
                            <span class="product-price-period">/ dzień</span>
                        </div>
                        
                        <div class="product-card-meta">
                            <div class="product-meta-item">
                                <span class="product-meta-icon">📦</span>
                                <span>@product.AvailableQuantity szt.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer with button -->
                    <div class="product-card-footer">
                        <button class="product-add-btn"
                                disabled="@(product.AvailableQuantity <= 0 || !product.IsAvailable)"
                                @onclick="@(async () => await AddToCart(product))"
                                @onclick:stopPropagation="true">
                            <span>🛒</span> Dodaj do koszyka
                        </button>
                    </div>
                </div>
            }
        </div>

        @if (totalPages > 1)
        {
            <div class="products-pagination">
                <MudPagination Count="totalPages"
                               @bind-Selected="CurrentPage"
                               Color="Color.Primary"
                               ShowFirstButton="true"
                               ShowLastButton="true"
                               BoundaryCount="1"
                               MiddleCount="3" />
            </div>
        }
    }
</MudContainer>

@code {
    private readonly List<ProductDto> products = new();
    private List<ProductDto> filteredProducts = new();
    private List<string> categories = new();
    private bool isLoading = true;

    private string searchText = string.Empty;
    private string selectedCategory = string.Empty;
    private int currentPage = 1;
    private int totalPages = 1;
    private const int PageSize = 12;

    private bool showOnlyAvailable;
    private string selectedSort = "featured";
    private decimal minPrice;
    private decimal maxPrice;
    private decimal selectedMinPrice;
    private decimal selectedMaxPrice;

    private int availableCount => products.Count(p => p.IsAvailable && p.AvailableQuantity > 0);
    private decimal averagePrice => products.Any() ? Math.Round(products.Average(p => p.DailyPrice), 2) : 0m;

    private record CategoryChip(string Name, string Icon);

    private List<CategoryChip> GetCategoryChips()
    {
        return categories.Select(c => new CategoryChip(c, GetCategoryIcon(c))).ToList();
    }

    private string GetCategoryIcon(string? category) => category?.ToLower() switch
    {
        "narty" or "ski" => "⛷️",
        "snowboard" => "🏂",
        "rowery" or "bike" or "rower" => "🚴",
        "sporty wodne" or "water" or "sup" or "kajak" => "🏄",
        "buty" or "buty narciarskie" => "👢",
        "kaski" or "kask" => "⛑️",
        "akcesoria" => "🎒",
        _ => "🎿"
    };

    private void SelectCategory(string category)
    {
        selectedCategory = category;
        currentPage = 1;
        ApplyFilters();
    }

    private string SelectedSort
    {
        get => selectedSort;
        set
        {
            var newValue = value ?? "featured";
            if (selectedSort != newValue)
            {
                selectedSort = newValue;
                currentPage = 1;
                ApplyFilters();
            }
        }
    }

    private bool ShowOnlyAvailable
    {
        get => showOnlyAvailable;
        set
        {
            if (showOnlyAvailable != value)
            {
                showOnlyAvailable = value;
                currentPage = 1;
                ApplyFilters();
            }
        }
    }

    private int CurrentPage
    {
        get => currentPage;
        set
        {
            var clamped = Math.Clamp(value, 1, Math.Max(1, totalPages));
            if (currentPage != clamped)
            {
                currentPage = clamped;
                ApplyFilters();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        isLoading = true;
        try
        {
            var loaded = await ApiService.GetProductsAsync(1, 200);
            products.Clear();
            products.AddRange(loaded);

            categories = products
                .Where(p => !string.IsNullOrWhiteSpace(p.Category))
                .Select(p => p.Category!)
                .Distinct()
                .OrderBy(c => c)
                .ToList();

            if (products.Any())
            {
                minPrice = products.Min(p => p.DailyPrice);
                maxPrice = products.Max(p => p.DailyPrice);
                selectedMinPrice = minPrice;
                selectedMaxPrice = maxPrice;
            }

            ApplyFilters();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Nie udało się załadować produktów: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        IEnumerable<ProductDto> query = products;

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            query = query.Where(p =>
                p.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (p.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        if (!string.IsNullOrWhiteSpace(selectedCategory))
        {
            query = query.Where(p => string.Equals(p.Category, selectedCategory, StringComparison.OrdinalIgnoreCase));
        }

        if (ShowOnlyAvailable)
        {
            query = query.Where(p => p.IsAvailable && p.AvailableQuantity > 0);
        }

        if (products.Any())
        {
            var min = Math.Min(selectedMinPrice, selectedMaxPrice);
            var max = Math.Max(selectedMinPrice, selectedMaxPrice);
            query = query.Where(p => p.DailyPrice >= min && p.DailyPrice <= max);
        }

        query = SortProducts(query);

        var list = query.ToList();
        totalPages = list.Count == 0 ? 1 : (int)Math.Ceiling(list.Count / (double)PageSize);
        currentPage = Math.Clamp(currentPage, 1, totalPages);
        filteredProducts = list
            .Skip((currentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    private IEnumerable<ProductDto> SortProducts(IEnumerable<ProductDto> source) => SelectedSort switch
    {
        "price-asc" => source.OrderBy(p => p.DailyPrice),
        "price-desc" => source.OrderByDescending(p => p.DailyPrice),
        "name" => source.OrderBy(p => p.Name),
        _ => source.OrderByDescending(p => p.IsAvailable).ThenBy(p => p.Name)
    };

    private void SearchProducts()
    {
        currentPage = 1;
        ApplyFilters();
    }

    private void ClearFilters()
    {
        searchText = string.Empty;
        selectedCategory = string.Empty;
        SelectedSort = "featured";
        ShowOnlyAvailable = false;
        currentPage = 1;

        if (products.Any())
        {
            selectedMinPrice = minPrice;
            selectedMaxPrice = maxPrice;
        }

        ApplyFilters();
    }

    private void OnMinPriceChanged(decimal value)
    {
        selectedMinPrice = ClampPrice(value);
        currentPage = 1;
        ApplyFilters();
    }

    private void OnMaxPriceChanged(decimal value)
    {
        selectedMaxPrice = ClampPrice(value);
        currentPage = 1;
        ApplyFilters();
    }

    private decimal ClampPrice(decimal value)
    {
        if (!products.Any()) return value;
        return Math.Clamp(value, minPrice, maxPrice);
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            SearchProducts();
            await Task.CompletedTask;
        }
    }

    private async Task AddToCart(ProductDto product)
    {
        await CartService.AddToCartAsync(product);
        Snackbar.Add($"✅ {product.Name} dodany do koszyka!", Severity.Success);
    }

    private Task AddToCartFromDialog(ProductDto product) => AddToCart(product);

    private void ViewProduct(ProductDto product)
    {
        var parameters = new DialogParameters
        {
            ["Product"] = product,
            ["AddToCart"] = EventCallback.Factory.Create<ProductDto>(this, AddToCartFromDialog)
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        DialogService.Show<ProductDetailsDialog>("Product details", parameters, options);
    }

    private void NavigateToProduct(Guid id)
    {
        Navigation.NavigateTo($"/products/{id}");
    }
}
