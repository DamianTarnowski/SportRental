@page "/products"
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@using SportRental.Shared.Models
@inject IApiService ApiService
@inject ICartService CartService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>SportRental - Katalog produkt√≥w</PageTitle>

@* ============================================
   MOBILE UI - Compact cards, bottom sheet filters
   ============================================ *@
@if (_isMobile)
{
    <div class="products-mobile">
        <!-- Mobile Header - Sticky -->
        <div class="products-mobile-header">
            <div class="products-mobile-title">
                <span>üéø</span>
                <h1>Katalog</h1>
                <span class="products-mobile-count">@totalProductCount</span>
            </div>
            <button class="products-mobile-filter-btn" @onclick="ToggleMobileFilters">
                <span>üîç</span>
                @if (HasActiveFilters())
                {
                    <span class="filter-badge">!</span>
                }
            </button>
        </div>

        <!-- Mobile Quick Stats -->
        <div class="products-mobile-stats">
            <div class="mobile-stat">
                <span>‚úÖ</span>
                <span>@availableProductCount dostƒôpnych</span>
            </div>
            <div class="mobile-stat">
                <span>üí∞</span>
                <span>od @minPrice.ToString("N0") z≈Ç</span>
            </div>
        </div>

        <!-- Mobile Filters Panel -->
        @if (_showMobileFilters)
        {
            <div class="products-mobile-filters">
                <!-- Search -->
                <MudTextField @bind-Value="searchText"
                              Placeholder="Szukaj produkt√≥w..."
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              OnKeyDown="OnSearchKeyDown"
                              Class="mb-2" />

                <!-- Category chips - horizontal scroll -->
                <div class="mobile-filter-chips">
                    <div class="filter-chip-mobile @(string.IsNullOrEmpty(selectedCategory) ? "active" : "")" 
                         @onclick="@(() => SelectCategory(string.Empty))">
                        üéØ Wszystkie
                    </div>
                    @foreach (var cat in GetCategoryChips())
                    {
                        <div class="filter-chip-mobile @(selectedCategory == cat.Name ? "active" : "")"
                             @onclick="@(() => SelectCategory(cat.Name))">
                            @cat.Icon @cat.Name
                        </div>
                    }
                </div>

                <!-- Location selects -->
                <div class="mobile-filter-row">
                    <MudSelect T="string" Label="Wojew√≥dztwo" @bind-Value="SelectedVoivodeship" 
                               Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" Clearable="true">
                        @foreach (var v in voivodeships)
                        {
                            <MudSelectItem Value="@v">@v</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="string" Label="Miasto" @bind-Value="SelectedCity" 
                               Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" Clearable="true">
                        @foreach (var c in filteredCities)
                        {
                            <MudSelectItem Value="@c">@c</MudSelectItem>
                        }
                    </MudSelect>
                </div>

                <!-- Availability & Sort -->
                <div class="mobile-filter-row">
                    <MudSwitch @bind-Value="ShowOnlyAvailable" Color="Color.Success" Label="Dostƒôpne" />
                    <MudSelect T="string" Label="Sortuj" @bind-Value="SelectedSort" 
                               Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense">
                        <MudSelectItem Value="@("featured")">‚≠ê Polecane</MudSelectItem>
                        @if (userLat.HasValue && userLon.HasValue)
                        {
                            <MudSelectItem Value="@("distance")">üìç Najbli≈ºej</MudSelectItem>
                        }
                        <MudSelectItem Value="@("price-asc")">üíµ Najta≈Ñsze</MudSelectItem>
                        <MudSelectItem Value="@("price-desc")">üíé Najdro≈ºsze</MudSelectItem>
                    </MudSelect>
                </div>

                <MudButton Variant="Variant.Text" Color="Color.Secondary" 
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="ClearFilters" Size="Size.Small" FullWidth="true">
                    Resetuj filtry
                </MudButton>
            </div>
        }

        <!-- Mobile Products Grid -->
        @if (isLoading)
        {
            <div class="products-mobile-loading">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                <span>≈Åadowanie...</span>
            </div>
        }
        else if (!filteredProducts.Any())
        {
            <div class="products-mobile-empty">
                <span class="empty-icon">üîç</span>
                <h3>Brak produkt√≥w</h3>
                <p>Zmie≈Ñ kryteria wyszukiwania</p>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ClearFilters">
                    Resetuj filtry
                </MudButton>
            </div>
        }
        else
        {
            <div class="products-mobile-grid">
                @foreach (var product in filteredProducts)
                {
                    var imageUrl = product.GetImageUrl(300);
                    var categoryIcon = GetCategoryIcon(product.Category);
                    
                    <div class="product-mobile-card" @onclick="@(() => NavigateToProduct(product.Id))">
                        <div class="product-mobile-image">
                            @if (!string.IsNullOrEmpty(imageUrl))
                            {
                                <img src="@imageUrl" alt="@product.Name" loading="lazy" />
                            }
                            else
                            {
                                <div class="product-mobile-placeholder">üì∑</div>
                            }
                            @if (product.IsAvailable && product.AvailableQuantity > 0)
                            {
                                <span class="product-mobile-badge available">‚úì</span>
                            }
                            else
                            {
                                <span class="product-mobile-badge unavailable">‚úó</span>
                            }
                        </div>
                        <div class="product-mobile-info">
                            <span class="product-mobile-category">@categoryIcon @product.Category</span>
                            <h4 class="product-mobile-name">@product.Name</h4>
                            <div class="product-mobile-price">
                                <span class="price-main">@product.DailyPrice.ToString("N0") z≈Ç</span>
                                <span class="price-period">/dzie≈Ñ</span>
                            </div>
                        </div>
                        <button class="product-mobile-cart-btn" 
                                disabled="@(product.AvailableQuantity <= 0 || !product.IsAvailable)"
                                @onclick="@(async () => await AddToCart(product))"
                                @onclick:stopPropagation="true">
                            üõí
                        </button>
                    </div>
                }
            </div>

            @if (totalPages > 1)
            {
                <div class="products-mobile-pagination">
                    <MudPagination Count="totalPages"
                                   @bind-Selected="CurrentPage"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   BoundaryCount="1"
                                   MiddleCount="1" />
                </div>
            }
        }
    </div>
}
@* ============================================
   DESKTOP UI - Original design with full features
   ============================================ *@
else
{
<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-4">
    
    <!-- =============================================
         HERO SECTION
         ============================================= -->
    <div class="products-hero">
        <div class="products-hero-content">
            <h1 class="products-hero-title">üéø Znajd≈∫ swojƒÖ przygodƒô</h1>
            <p class="products-hero-subtitle">
                PrzeglƒÖdaj nasz katalog profesjonalnego sprzƒôtu sportowego
            </p>
            <div class="products-stats">
                <div class="products-stat">
                    <span class="products-stat-icon">üì¶</span>
                    <span class="products-stat-value">@totalProductCount</span>
                    <span class="products-stat-label">produkt√≥w</span>
                </div>
                <div class="products-stat">
                    <span class="products-stat-icon">‚úÖ</span>
                    <span class="products-stat-value">@availableProductCount</span>
                    <span class="products-stat-label">dostƒôpnych</span>
                </div>
                <div class="products-stat">
                    <span class="products-stat-icon">üí∞</span>
                    <span class="products-stat-value">@avgPrice.ToString("C")</span>
                    <span class="products-stat-label">≈õr. cena</span>
                </div>
            </div>
        </div>
    </div>

    <!-- =============================================
         FILTERS SECTION
         ============================================= -->
    <div class="products-filters">
        <MudGrid Spacing="3">
            <!-- Search -->
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="searchText"
                              Label="üîç Szukaj produkt√≥w"
                              Placeholder="Wpisz nazwƒô..."
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              OnKeyDown="OnSearchKeyDown"
                              Style="border-radius: 12px;" />
            </MudItem>
            
            <!-- Category chips -->
            <MudItem xs="12" md="8">
                <div class="filter-section-title">Kategorie</div>
                <div class="filter-chips">
                    <div class="filter-chip @(string.IsNullOrEmpty(selectedCategory) ? "active" : "")" 
                         @onclick="@(() => SelectCategory(string.Empty))">
                        <span>üéØ</span> Wszystkie
                    </div>
                    @foreach (var cat in GetCategoryChips())
                    {
                        <div class="filter-chip @(selectedCategory == cat.Name ? "active" : "")"
                             @onclick="@(() => SelectCategory(cat.Name))">
                            <span>@cat.Icon</span> @cat.Name
                        </div>
                    }
                </div>
            </MudItem>
            
            <!-- Location filters -->
            <MudItem xs="12" md="3">
                <MudSelect T="string" Label="üìç Wojew√≥dztwo" @bind-Value="SelectedVoivodeship" Variant="Variant.Outlined" Clearable="true">
                    @foreach (var v in voivodeships)
                    {
                        <MudSelectItem Value="@v">@v</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" md="3">
                <MudSelect T="string" Label="üèôÔ∏è Miasto" @bind-Value="SelectedCity" Variant="Variant.Outlined" Clearable="true">
                    @foreach (var c in filteredCities)
                    {
                        <MudSelectItem Value="@c">@c</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" md="3">
                <MudSelect T="string" Label="üè™ Wypo≈ºyczalnia" @bind-Value="SelectedTenant" Variant="Variant.Outlined" Clearable="true">
                    @foreach (var t in filteredTenants)
                    {
                        <MudSelectItem Value="@t">@t</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <!-- Additional filters row -->
            <MudItem xs="12" md="3">
                <MudSelect T="string" Label="Sortuj" @bind-Value="SelectedSort" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("featured")">‚≠ê Polecane</MudSelectItem>
                    @if (userLat.HasValue && userLon.HasValue)
                    {
                        <MudSelectItem Value="@("distance")">üìç Najbli≈ºej mnie</MudSelectItem>
                    }
                    <MudSelectItem Value="@("price-asc")">üíµ Najta≈Ñsze</MudSelectItem>
                    <MudSelectItem Value="@("price-desc")">üíé Najdro≈ºsze</MudSelectItem>
                    <MudSelectItem Value="@("name")">üî§ Nazwa A-Z</MudSelectItem>
                </MudSelect>
            </MudItem>
            
            <MudItem xs="6" md="2">
                <MudNumericField T="decimal"
                                 Label="Cena od"
                                 Variant="Variant.Outlined"
                                 Value="selectedMinPrice"
                                 ValueChanged="OnMinPriceChanged"
                                 Adornment="Adornment.End"
                                 AdornmentText="z≈Ç"
                                 Min="@minPrice"
                                 Max="@selectedMaxPrice" />
            </MudItem>
            
            <MudItem xs="6" md="2">
                <MudNumericField T="decimal"
                                 Label="Cena do"
                                 Variant="Variant.Outlined"
                                 Value="selectedMaxPrice"
                                 ValueChanged="OnMaxPriceChanged"
                                 Adornment="Adornment.End"
                                 AdornmentText="z≈Ç"
                                 Min="@selectedMinPrice"
                                 Max="@maxPrice" />
            </MudItem>
            
            <MudItem xs="12" md="3">
                <MudSwitch @bind-Value="ShowOnlyAvailable" Color="Color.Success" Label="‚úÖ Tylko dostƒôpne" />
            </MudItem>
            
            <MudItem xs="12" md="2">
                <MudButton Variant="Variant.Text" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="ClearFilters"
                           FullWidth="true">
                    Resetuj
                </MudButton>
            </MudItem>
        </MudGrid>
    </div>

    <!-- =============================================
         PRODUCTS GRID
         ============================================= -->
    @if (isLoading)
    {
        <div class="products-grid">
            @for (int i = 0; i < 8; i++)
            {
                <div class="product-skeleton">
                    <div class="skeleton-shimmer" style="height: 220px;"></div>
                    <div style="padding: 1.25rem;">
                        <div class="skeleton-shimmer" style="height: 24px; border-radius: 8px; margin-bottom: 0.75rem;"></div>
                        <div class="skeleton-shimmer" style="height: 32px; width: 60%; border-radius: 8px; margin-bottom: 0.75rem;"></div>
                        <div class="skeleton-shimmer" style="height: 44px; border-radius: 12px;"></div>
                    </div>
                </div>
            }
        </div>
    }
    else if (!filteredProducts.Any())
    {
        <div class="products-empty">
            <div class="products-empty-icon">üîç</div>
            <h3 class="products-empty-title">Brak produkt√≥w</h3>
            <p class="products-empty-text">Nie znale≈∫li≈õmy produkt√≥w spe≈ÇniajƒÖcych Twoje kryteria.</p>
            <button class="products-reset-btn" @onclick="ClearFilters">
                Resetuj filtry
            </button>
        </div>
    }
    else
    {
        <div class="products-grid">
            @foreach (var product in filteredProducts)
            {
                var imageUrl = product.GetImageUrl(400);
                var categoryIcon = GetCategoryIcon(product.Category);
                
                <div class="product-card" @onclick="@(() => ViewProduct(product))">
                    <!-- Image section -->
                    <div class="product-card-image">
                        @if (!string.IsNullOrEmpty(imageUrl))
                        {
                            <img src="@imageUrl" alt="@product.Name" loading="lazy" />
                        }
                        else
                        {
                            <div class="product-card-placeholder">
                                <span class="product-card-placeholder-icon">üì∑</span>
                            </div>
                        }
                        
                        <!-- Badges -->
                        <div class="product-card-badges">
                            @if (product.IsAvailable && product.AvailableQuantity > 0)
                            {
                                <span class="product-badge product-badge-available">Dostƒôpny</span>
                            }
                            else
                            {
                                <span class="product-badge product-badge-unavailable">Niedostƒôpny</span>
                            }
                            
                            @if (!string.IsNullOrEmpty(product.Category))
                            {
                                <span class="product-badge product-badge-category">
                                    @categoryIcon @product.Category
                                </span>
                            }
                        </div>
                        
                        <!-- Quick actions overlay -->
                        <div class="product-card-actions-overlay">
                            <button class="product-quick-btn product-quick-btn-primary"
                                    disabled="@(product.AvailableQuantity <= 0 || !product.IsAvailable)"
                                    @onclick="@(async () => await AddToCart(product))"
                                    @onclick:stopPropagation="true">
                                üõí Do koszyka
                            </button>
                            <button class="product-quick-btn product-quick-btn-secondary"
                                    @onclick="@(() => NavigateToProduct(product.Id))"
                                    @onclick:stopPropagation="true">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content section -->
                    <div class="product-card-content">
                        <h3 class="product-card-title">@product.Name</h3>
                        
                        <div class="product-card-price">
                            <span class="product-price-amount">@product.DailyPrice.ToString("N0") z≈Ç</span>
                            <span class="product-price-period">/ dzie≈Ñ</span>
                            @if (product.HourlyPrice.HasValue && product.HourlyPrice.Value > 0)
                            {
                                <div class="product-price-hourly">
                                    <span class="product-price-amount-small">@product.HourlyPrice.Value.ToString("N0") z≈Ç</span>
                                    <span class="product-price-period-small">/ godz.</span>
                                </div>
                            }
                        </div>
                        
                        <div class="product-card-meta">
                            <div class="product-meta-item">
                                <span class="product-meta-icon">üì¶</span>
                                <span>@product.AvailableQuantity szt.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer with button -->
                    <div class="product-card-footer">
                        <button class="product-add-btn"
                                disabled="@(product.AvailableQuantity <= 0 || !product.IsAvailable)"
                                @onclick="@(async () => await AddToCart(product))"
                                @onclick:stopPropagation="true">
                            <span>üõí</span> Dodaj do koszyka
                        </button>
                    </div>
                </div>
            }
        </div>

        @if (totalPages > 1)
        {
            <div class="products-pagination">
                <MudPagination Count="totalPages"
                               @bind-Selected="CurrentPage"
                               Color="Color.Primary"
                               ShowFirstButton="true"
                               ShowLastButton="true"
                               BoundaryCount="1"
                               MiddleCount="3" />
            </div>
        }
    }
</MudContainer>
} @* End of Desktop UI *@

@code {
    // Mobile detection
    private bool _isMobile = false;
    private bool _showMobileFilters = false;
    private DotNetObjectReference<Products>? _dotNetRef;
    
    private void ToggleMobileFilters() => _showMobileFilters = !_showMobileFilters;
    
    private bool HasActiveFilters() => 
        !string.IsNullOrEmpty(searchText) || 
        !string.IsNullOrEmpty(selectedCategory) || 
        !string.IsNullOrEmpty(selectedVoivodeship) || 
        !string.IsNullOrEmpty(selectedCity) ||
        showOnlyAvailable;
    private List<ProductDto> filteredProducts = new();
    private List<string> categories = new();
    private bool isLoading = true;

    private string searchText = string.Empty;
    private string selectedCategory = string.Empty;
    private int currentPage = 1;
    private int totalPages = 1;
    private const int PageSize = 12;

    private bool showOnlyAvailable;
    private string selectedSort = "featured";
    private decimal minPrice;
    private decimal maxPrice;
    private decimal selectedMinPrice;
    private decimal selectedMaxPrice;
    
    // Location filters
    private List<string> voivodeships = new();
    private List<string> cities = new();
    private List<string> filteredCities = new();
    private string? selectedVoivodeship;
    private string? selectedCity;
    
    // Tenant (wypo≈ºyczalnia) filter
    private List<string> tenants = new();
    private List<string> filteredTenants = new();
    private string? selectedTenant;
    
    // User location (from localStorage - set on map page)
    private double? userLat;
    private double? userLon;
    
    // Stats (loaded once at init)
    private int totalProductCount;
    private int availableProductCount;
    private decimal avgPrice;

    private record CategoryChip(string Name, string Icon);

    private List<CategoryChip> GetCategoryChips()
    {
        return categories.Select(c => new CategoryChip(c, GetCategoryIcon(c))).ToList();
    }

    private string GetCategoryIcon(string? category) => category?.ToLower() switch
    {
        "narty" or "ski" => "‚õ∑Ô∏è",
        "snowboard" => "üèÇ",
        "rowery" or "bike" or "rower" => "üö¥",
        "sporty wodne" or "water" or "sup" or "kajak" => "üèÑ",
        "buty" or "buty narciarskie" => "üë¢",
        "kaski" or "kask" => "‚õëÔ∏è",
        "akcesoria" => "üéí",
        _ => "üéø"
    };

    private void SelectCategory(string category)
    {
        selectedCategory = category;
        currentPage = 1;
        _ = LoadProductsAsync();
    }

    private string SelectedSort
    {
        get => selectedSort;
        set
        {
            var newValue = value ?? "featured";
            if (selectedSort != newValue)
            {
                selectedSort = newValue;
                currentPage = 1;
                _ = LoadProductsAsync();
            }
        }
    }

    private bool ShowOnlyAvailable
    {
        get => showOnlyAvailable;
        set
        {
            if (showOnlyAvailable != value)
            {
                showOnlyAvailable = value;
                currentPage = 1;
                _ = LoadProductsAsync();
            }
        }
    }

    private int CurrentPage
    {
        get => currentPage;
        set
        {
            var clamped = Math.Clamp(value, 1, Math.Max(1, totalPages));
            if (currentPage != clamped)
            {
                currentPage = clamped;
                _ = LoadProductsAsync();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Setup mobile detection
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("setupMobileDetection", _dotNetRef);
            
            await LoadUserLocationFromStorage();
        }
    }
    
    [JSInvokable]
    public void OnScreenResize(bool isMobile)
    {
        if (_isMobile != isMobile)
        {
            _isMobile = isMobile;
            InvokeAsync(StateHasChanged);
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("removeMobileDetection");
        }
        catch { }
        _dotNetRef?.Dispose();
    }

    private async Task LoadUserLocationFromStorage()
    {
        try
        {
            var location = await JS.InvokeAsync<UserLocationData?>("leafletMap.getUserLocation");
            if (location != null && location.Lat != 0 && location.Lon != 0)
            {
                userLat = location.Lat;
                userLon = location.Lon;
                
                // If user has location, default to distance sorting
                if (selectedSort == "featured")
                {
                    selectedSort = "distance";
                }
                
                await LoadProductsAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user location: {ex.Message}");
        }
    }

    private class UserLocationData
    {
        public double Lat { get; set; }
        public double Lon { get; set; }
    }

    private async Task LoadInitialData()
    {
        isLoading = true;
        try
        {
            // Load first page and get filter options from a larger sample
            var initialResponse = await ApiService.GetProductsPagedAsync(new ProductFilterRequest { Page = 1, PageSize = 200 });
            
            // Extract filter options from initial load
            var allProducts = initialResponse.Items;
            
            categories = allProducts
                .Where(p => !string.IsNullOrWhiteSpace(p.Category))
                .Select(p => p.Category!)
                .Distinct()
                .OrderBy(c => c)
                .ToList();

            voivodeships = allProducts
                .Where(p => !string.IsNullOrWhiteSpace(p.Voivodeship))
                .Select(p => p.Voivodeship!)
                .Distinct()
                .OrderBy(v => v)
                .ToList();

            cities = allProducts
                .Where(p => !string.IsNullOrWhiteSpace(p.City))
                .Select(p => p.City!)
                .Distinct()
                .OrderBy(c => c)
                .ToList();
            
            filteredCities = cities;

            tenants = allProducts
                .Where(p => !string.IsNullOrWhiteSpace(p.TenantName))
                .Select(p => p.TenantName!)
                .Distinct()
                .OrderBy(t => t)
                .ToList();
            
            filteredTenants = tenants;

            if (allProducts.Any())
            {
                minPrice = allProducts.Min(p => p.DailyPrice);
                maxPrice = allProducts.Max(p => p.DailyPrice);
                selectedMinPrice = minPrice;
                selectedMaxPrice = maxPrice;
            }

            // Store for stats
            totalProductCount = initialResponse.TotalCount;
            availableProductCount = allProducts.Count(p => p.IsAvailable && p.AvailableQuantity > 0);
            avgPrice = allProducts.Any() ? Math.Round(allProducts.Average(p => p.DailyPrice), 2) : 0m;

            // Now load first page with actual filters
            await LoadProductsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Nie uda≈Ço siƒô za≈Çadowaƒá produkt√≥w: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadProductsAsync()
    {
        isLoading = true;
        try
        {
            var filter = new ProductFilterRequest
            {
                Page = currentPage,
                PageSize = PageSize,
                Search = string.IsNullOrWhiteSpace(searchText) ? null : searchText,
                Category = string.IsNullOrWhiteSpace(selectedCategory) ? null : selectedCategory,
                City = string.IsNullOrWhiteSpace(selectedCity) ? null : selectedCity,
                Voivodeship = string.IsNullOrWhiteSpace(selectedVoivodeship) ? null : selectedVoivodeship,
                Tenant = string.IsNullOrWhiteSpace(selectedTenant) ? null : selectedTenant,
                MinPrice = selectedMinPrice > minPrice ? selectedMinPrice : null,
                MaxPrice = selectedMaxPrice < maxPrice ? selectedMaxPrice : null,
                Available = showOnlyAvailable ? true : null,
                Sort = selectedSort,
                UserLat = userLat,
                UserLon = userLon
            };

            var response = await ApiService.GetProductsPagedAsync(filter);
            
            filteredProducts = response.Items;
            totalPages = response.TotalPages > 0 ? response.TotalPages : 1;
            currentPage = Math.Clamp(response.Page, 1, totalPages);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd ≈Çadowania: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void SearchProducts()
    {
        currentPage = 1;
        _ = LoadProductsAsync();
    }

    private void ClearFilters()
    {
        searchText = string.Empty;
        selectedCategory = string.Empty;
        selectedVoivodeship = null;
        selectedCity = null;
        selectedTenant = null;
        filteredCities = cities;
        filteredTenants = tenants;
        selectedSort = "featured";
        showOnlyAvailable = false;
        currentPage = 1;
        selectedMinPrice = minPrice;
        selectedMaxPrice = maxPrice;
        _ = LoadProductsAsync();
    }

    private string? SelectedVoivodeship
    {
        get => selectedVoivodeship;
        set
        {
            if (selectedVoivodeship != value)
            {
                selectedVoivodeship = value;
                // Clear city if voivodeship changed
                if (!string.IsNullOrWhiteSpace(selectedCity))
                {
                    selectedCity = null;
                }
                currentPage = 1;
                _ = LoadProductsAsync();
            }
        }
    }

    private string? SelectedCity
    {
        get => selectedCity;
        set
        {
            if (selectedCity != value)
            {
                selectedCity = value;
                currentPage = 1;
                _ = LoadProductsAsync();
            }
        }
    }

    private string? SelectedTenant
    {
        get => selectedTenant;
        set
        {
            if (selectedTenant != value)
            {
                selectedTenant = value;
                currentPage = 1;
                _ = LoadProductsAsync();
            }
        }
    }

    private void OnMinPriceChanged(decimal value)
    {
        selectedMinPrice = Math.Clamp(value, minPrice, maxPrice);
        currentPage = 1;
        _ = LoadProductsAsync();
    }

    private void OnMaxPriceChanged(decimal value)
    {
        selectedMaxPrice = Math.Clamp(value, minPrice, maxPrice);
        currentPage = 1;
        _ = LoadProductsAsync();
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            SearchProducts();
            await Task.CompletedTask;
        }
    }

    private async Task AddToCart(ProductDto product)
    {
        await CartService.AddToCartAsync(product);
        Snackbar.Add($"‚úÖ {product.Name} dodany do koszyka!", Severity.Success);
    }

    private Task AddToCartFromDialog(ProductDto product) => AddToCart(product);

    private void ViewProduct(ProductDto product)
    {
        var parameters = new DialogParameters
        {
            ["Product"] = product,
            ["AddToCart"] = EventCallback.Factory.Create<ProductDto>(this, AddToCartFromDialog)
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        DialogService.Show<ProductDetailsDialog>("Product details", parameters, options);
    }

    private void NavigateToProduct(Guid id)
    {
        Navigation.NavigateTo($"/products/{id}");
    }
}
