@page "/products/{id:guid}"
@using MudBlazor
@using SportRental.Shared.Models
@inject IApiService ApiService
@inject ICartService CartService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>@(product?.Name ?? "Szczeg√≥≈Çy produktu") - SportRental</PageTitle>

<div class="product-details-container">
    <div class="max-w-6xl mx-auto">
        <!-- Breadcrumbs -->
        <div class="mb-6">
            <nav class="flex items-center gap-2 text-sm text-gray-500">
                <a href="/" class="hover:text-gray-700">üè† Home</a>
                <span>/</span>
                <a href="/products" class="hover:text-gray-700">üì¶ Katalog</a>
                <span>/</span>
                <span class="text-gray-800 font-medium">@(product?.Name ?? "...")</span>
            </nav>
        </div>

        @if (isLoading)
        {
            <div class="product-details-grid">
                <div class="animate-pulse">
                    <div class="bg-gray-200 rounded-3xl h-96"></div>
                </div>
                <div class="animate-pulse space-y-4">
                    <div class="h-8 bg-gray-200 rounded w-3/4"></div>
                    <div class="h-6 bg-gray-200 rounded w-1/2"></div>
                    <div class="h-24 bg-gray-200 rounded"></div>
                    <div class="h-12 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        }
        else if (notFound || product is null)
        {
            <div class="text-center py-20">
                <div class="text-8xl mb-6">üòî</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-3">Produkt nie zosta≈Ç znaleziony</h1>
                <p class="text-gray-600 mb-8">Produkt m√≥g≈Ç zostaƒá usuniƒôty lub jest chwilowo niedostƒôpny.</p>
                <button @onclick="GoBack" class="product-details-add-btn" style="max-width: 250px; margin: 0 auto;">
                    ‚Üê Wr√≥ƒá do katalogu
                </button>
            </div>
        }
        else
        {
            <div class="product-details-grid">
                <!-- Image Section -->
                <div>
                    @{
                        var imageUrl = product.GetImageUrl(1280);
                        var imageSrcSet = product.GetImageSrcSet();
                        var originalUrl = product.GetOriginalImageUrl();
                    }
                    @if (!string.IsNullOrWhiteSpace(imageUrl))
                    {
                        <div class="product-details-image-wrapper" @onclick="@(() => ShowImageLightbox(originalUrl, product.Name))">
                            @if (!string.IsNullOrEmpty(imageSrcSet))
                            {
                                <img src="@imageUrl"
                                     srcset="@imageSrcSet"
                                     sizes="(max-width: 600px) 400px, (max-width: 900px) 800px, 1280px"
                                     alt="@product.Name"
                                     class="product-details-image" />
                            }
                            else
                            {
                                <img src="@imageUrl"
                                     alt="@product.Name"
                                     class="product-details-image" />
                            }
                            <div class="product-details-zoom-hint">
                                üîç Kliknij aby powiƒôkszyƒá
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="product-details-image-placeholder">
                            <div class="text-6xl mb-4">üì∑</div>
                            <p>Zdjƒôcie wkr√≥tce dostƒôpne</p>
                        </div>
                    }
                </div>

                <!-- Info Section -->
                <div class="product-details-info">
                    @if (!string.IsNullOrWhiteSpace(product.Category))
                    {
                        <div class="product-details-category">
                            üè∑Ô∏è @product.Category
                        </div>
                    }

                    <h1 class="product-details-title">@product.Name</h1>

                    <div class="product-details-price-row">
                        <span class="product-details-price">@product.DailyPrice.ToString("C") / dzie≈Ñ</span>
                        @if (product.IsAvailable && product.AvailableQuantity > 0)
                        {
                            <span class="product-details-availability available">‚úÖ Dostƒôpny</span>
                        }
                        else
                        {
                            <span class="product-details-availability unavailable">‚ùå Niedostƒôpny</span>
                        }
                        <span class="product-details-stock">üì¶ @product.AvailableQuantity szt.</span>
                    </div>

                    <!-- Date Selection -->
                    <div class="product-details-dates">
                        <h3>üìÖ Wybierz okres wypo≈ºyczenia</h3>
                        <div class="product-details-dates-grid">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Data rozpoczƒôcia</label>
                                <input type="date" 
                                       @bind="startDate"
                                       min="@DateTime.Today.ToString("yyyy-MM-dd")"
                                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Data zako≈Ñczenia</label>
                                <input type="date" 
                                       @bind="endDate"
                                       min="@startDate?.AddDays(1).ToString("yyyy-MM-dd")"
                                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none" />
                            </div>
                        </div>
                        @if (startDate.HasValue && endDate.HasValue && endDate > startDate)
                        {
                            var days = (endDate.Value - startDate.Value).Days;
                            var totalPrice = product.DailyPrice * days;
                            <div class="mt-4 p-4 bg-purple-50 rounded-xl">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">‚è±Ô∏è @days dni √ó @product.DailyPrice.ToString("C")</span>
                                    <span class="text-xl font-bold text-purple-600">= @totalPrice.ToString("C")</span>
                                </div>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrWhiteSpace(product.Description))
                    {
                        <p class="product-details-description">@product.Description</p>
                    }
                    else
                    {
                        <p class="product-details-description text-gray-400 italic">Szczeg√≥≈Çowy opis bƒôdzie wkr√≥tce dostƒôpny.</p>
                    }

                    <div class="product-details-actions">
                        <button class="product-details-add-btn" 
                                disabled="@(product.AvailableQuantity <= 0 || !product.IsAvailable)"
                                @onclick="AddToCart">
                            üõí Dodaj do koszyka
                        </button>
                        <button class="product-details-back-btn" @onclick="GoBack">
                            ‚Üê Wr√≥ƒá
                        </button>
                    </div>
                </div>
            </div>

            <!-- Related Products -->
            @if (relatedProducts.Any())
            {
                <div class="related-products">
                    <h2>‚ú® Polecane dla Ciebie</h2>
                    <div class="related-products-grid">
                        @foreach (var related in relatedProducts)
                        {
                            <div class="related-product-card" @onclick="@(() => NavigateToProduct(related.Id))">
                                @{ var relatedImage = related.FullImageUrl ?? related.ImageUrl; }
                                @if (!string.IsNullOrWhiteSpace(relatedImage))
                                {
                                    <img src="@relatedImage" alt="@related.Name" class="related-product-image" />
                                }
                                else
                                {
                                    <div class="related-product-image bg-gray-100 flex items-center justify-center text-4xl">üì¶</div>
                                }
                                <div class="related-product-info">
                                    <div class="related-product-name">@related.Name</div>
                                    <div class="related-product-price">@related.DailyPrice.ToString("C") / dzie≈Ñ</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- Lightbox Dialog -->
<MudDialog @bind-Visible="_showLightbox" Options="@(new DialogOptions { FullWidth = true, MaxWidth = MaxWidth.ExtraExtraLarge, CloseButton = true, CloseOnEscapeKey = true })">
    <DialogContent>
        <div class="text-center p-4">
            <h3 class="text-xl font-bold mb-4">@_lightboxImageTitle</h3>
            <img src="@_lightboxImageUrl" alt="@_lightboxImageTitle" class="max-w-full max-h-[80vh] mx-auto rounded-lg" />
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseLightbox" Color="Color.Primary" Variant="Variant.Text">Zamknij</MudButton>
        <MudButton Href="@_lightboxImageUrl" Target="_blank" Color="Color.Secondary" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Download">
            Pobierz
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public Guid Id { get; set; }

    private ProductDto? product;
    private List<ProductDto> relatedProducts = new();
    private bool isLoading = true;
    private bool notFound;
    private DateTime? startDate;
    private DateTime? endDate;

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        notFound = false;
        product = null;
        relatedProducts.Clear();

        try
        {
            product = await ApiService.GetProductAsync(Id);
            if (product is null)
            {
                notFound = true;
                return;
            }

            startDate ??= DateTime.Today;
            endDate ??= DateTime.Today.AddDays(1);

            await LoadRelatedProductsAsync(product);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Nie uda≈Ço siƒô wczytaƒá produktu: {ex.Message}", Severity.Error);
            notFound = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadRelatedProductsAsync(ProductDto current)
    {
        try
        {
            var catalog = await ApiService.GetProductsAsync(1, 200);
            IEnumerable<ProductDto> candidates = catalog.Where(p => p.Id != current.Id);

            if (!string.IsNullOrWhiteSpace(current.Category))
            {
                var sameCategory = candidates.Where(p => string.Equals(p.Category, current.Category, StringComparison.OrdinalIgnoreCase)).ToList();
                if (sameCategory.Count >= 4)
                {
                    candidates = sameCategory;
                }
                else if (sameCategory.Any())
                {
                    var remainder = candidates.Except(sameCategory).OrderByDescending(p => p.IsAvailable).ThenBy(p => p.Name);
                    candidates = sameCategory.Concat(remainder);
                }
            }

            relatedProducts = candidates
                .OrderByDescending(p => p.IsAvailable)
                .ThenBy(p => Math.Abs(p.DailyPrice - current.DailyPrice))
                .Take(4)
                .ToList();
        }
        catch
        {
            // Recommendations are optional
        }
    }

    private async Task AddToCart()
    {
        if (product is null) return;

        if (!startDate.HasValue || !endDate.HasValue || endDate <= startDate)
        {
            Snackbar.Add("Wybierz poprawny okres wypo≈ºyczenia.", Severity.Warning);
            return;
        }

        await CartService.AddToCartAsync(product, 1, startDate, endDate);
        var holdSecured = await CartService.EnsureHoldsAsync();
        if (!holdSecured)
        {
            Snackbar.Add("Nie uda≈Ço siƒô zarezerwowaƒá wybranego produktu. Zmie≈Ñ daty i spr√≥buj ponownie.", Severity.Warning);
            return;
        }

        Snackbar.Add($"Produkt {product.Name} dodany do koszyka.", Severity.Success);
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/products");
    }

    private void NavigateToProduct(Guid id)
    {
        Navigation.NavigateTo($"/products/{id}");
    }

    // Image Lightbox
    private bool _showLightbox = false;
    private string _lightboxImageUrl = string.Empty;
    private string _lightboxImageTitle = string.Empty;

    private void ShowImageLightbox(string imageUrl, string title)
    {
        _lightboxImageUrl = imageUrl;
        _lightboxImageTitle = title;
        _showLightbox = true;
    }

    private void CloseLightbox()
    {
        _showLightbox = false;
    }
}
