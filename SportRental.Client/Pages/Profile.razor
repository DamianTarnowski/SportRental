@page "/profile"
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Navigation
@inject IApiService Api
@inject SportRental.Client.Services.ICustomerSessionService Session
@inject ISnackbar Snackbar

<PageTitle>Moje dane - SportRental</PageTitle>

<div class="profile-container">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="profile-header">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1>üë§ Moje dane</h1>
                    <p>Aktualizuj informacje kontaktowe wykorzystywane przy rezerwacjach</p>
                </div>
                @if (!_loading && _customerId.HasValue)
                {
                    <button class="profile-logout-btn" @onclick="LogoutAsync">
                        üö™ Wyloguj siƒô
                    </button>
                }
            </div>
        </div>

        @if (_loading)
        {
            <div class="flex items-center justify-center py-20">
                <div class="text-center">
                    <div class="w-16 h-16 border-4 border-emerald-200 border-t-emerald-500 rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-600">≈Åadowanie profilu...</p>
                </div>
            </div>
        }
        else if (!_customerId.HasValue)
        {
            <div class="profile-card text-center py-12">
                <div class="text-6xl mb-4">üîí</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Brak zalogowanego u≈ºytkownika</h2>
                <p class="text-gray-600 mb-6">Zaloguj siƒô lub za≈Ç√≥≈º konto, aby zarzƒÖdzaƒá swoimi danymi.</p>
                <div class="flex justify-center gap-4 flex-wrap">
                    <a href="/login" class="profile-save-btn" style="text-decoration: none;">
                        üîë Zaloguj siƒô
                    </a>
                    <a href="/register" class="profile-logout-btn" style="text-decoration: none; color: #11998e; border-color: #11998e;">
                        ‚ú® Zarejestruj siƒô
                    </a>
                </div>
            </div>
        }
        else if (_model is not null)
        {
            <div class="profile-card">
                <EditForm Model="_model" OnValidSubmit="SaveAsync">
                    <DataAnnotationsValidator />
                    
                    @if (_saveSuccess)
                    {
                        <div class="mb-6 p-4 bg-green-50 border border-green-200 text-green-800 rounded-xl flex items-center gap-3">
                            ‚úÖ Dane zosta≈Çy zapisane pomy≈õlnie!
                        </div>
                    }

                    <div class="profile-form-group">
                        <label for="fullName">üë§ Imiƒô i nazwisko *</label>
                        <InputText id="fullName" @bind-Value="_model.FullName" class="profile-input" placeholder="Jan Kowalski" />
                        <ValidationMessage For="() => _model.FullName" class="text-red-500 text-sm mt-1" />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="profile-form-group">
                            <label for="email">üìß Email *</label>
                            <InputText id="email" @bind-Value="_model.Email" type="email" class="profile-input" placeholder="jan@example.com" />
                            <ValidationMessage For="() => _model.Email" class="text-red-500 text-sm mt-1" />
                        </div>
                        <div class="profile-form-group">
                            <label for="phone">üì± Telefon *</label>
                            <InputText id="phone" @bind-Value="_model.PhoneNumber" type="tel" class="profile-input" placeholder="+48 123 456 789" />
                            <ValidationMessage For="() => _model.PhoneNumber" class="text-red-500 text-sm mt-1" />
                        </div>
                    </div>

                    <div class="profile-form-group">
                        <label for="address">üè† Adres (opcjonalnie)</label>
                        <InputTextArea id="address" @bind-Value="_model.Address" rows="2" class="profile-input" placeholder="ul. Sportowa 123, 00-001 Warszawa" />
                    </div>

                    <div class="profile-form-group">
                        <label for="document">ü™™ Dokument to≈ºsamo≈õci (opcjonalnie)</label>
                        <InputText id="document" @bind-Value="_model.DocumentNumber" class="profile-input" placeholder="ABC123456" />
                        <p class="text-sm text-gray-500 mt-1">Numer dokumentu przyspieszy proces weryfikacji przy odbiorze sprzƒôtu</p>
                    </div>

                    <div class="flex justify-end mt-6">
                        <button type="submit" class="profile-save-btn" disabled="@_isSaving">
                            @if (_isSaving)
                            {
                                <span>üíæ Zapisywanie...</span>
                            }
                            else
                            {
                                <span>üíæ Zapisz zmiany</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>

            <!-- Quick Links -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <a href="/my-rentals" class="block p-6 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow text-center">
                    <div class="text-4xl mb-3">üìã</div>
                    <h3 class="font-semibold text-gray-800">Moje wypo≈ºyczenia</h3>
                    <p class="text-sm text-gray-500">Zobacz historiƒô wypo≈ºycze≈Ñ</p>
                </a>
                <a href="/products" class="block p-6 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow text-center">
                    <div class="text-4xl mb-3">üéø</div>
                    <h3 class="font-semibold text-gray-800">Katalog produkt√≥w</h3>
                    <p class="text-sm text-gray-500">PrzeglƒÖdaj dostƒôpny sprzƒôt</p>
                </a>
            </div>
        }
    </div>
</div>

<style>
    .profile-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .profile-input:focus {
        outline: none;
        border-color: #11998e;
        box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
    }
</style>

@code {
    private Guid? _customerId;
    private ProfileModel? _model;
    private bool _loading = true;
    private bool _isSaving;
    private bool _saveSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfileAsync();
    }

    private async Task LoadProfileAsync()
    {
        _loading = true;
        try
        {
            var customer = await Session.GetCustomerAsync();
            if (customer is null)
            {
                _customerId = null;
                _model = null;
                return;
            }

            _customerId = customer.Id;
            _model = new ProfileModel
            {
                FullName = customer.FullName,
                Email = customer.Email,
                PhoneNumber = customer.PhoneNumber,
                Address = customer.Address,
                DocumentNumber = customer.DocumentNumber
            };
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SaveAsync()
    {
        if (_model is null || !_customerId.HasValue)
        {
            return;
        }

        _isSaving = true;
        _saveSuccess = false;
        
        try
        {
            var request = new CreateCustomerRequest
            {
                FullName = _model.FullName.Trim(),
                Email = _model.Email.Trim(),
                PhoneNumber = _model.PhoneNumber.Trim(),
                Address = string.IsNullOrWhiteSpace(_model.Address) ? null : _model.Address.Trim(),
                DocumentNumber = string.IsNullOrWhiteSpace(_model.DocumentNumber) ? null : _model.DocumentNumber.Trim()
            };

            var updated = await Api.UpdateCustomerAsync(_customerId.Value, request);
            if (updated is null)
            {
                Snackbar.Add("Nie uda≈Ço siƒô zaktualizowaƒá danych (konto nie istnieje).", Severity.Error);
                return;
            }

            await Session.SetCustomerAsync(updated);
            _saveSuccess = true;
            Snackbar.Add("Dane zosta≈Çy zaktualizowane.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisu danych: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task LogoutAsync()
    {
        await Session.ClearAsync();
        Snackbar.Add("Wylogowano.", Severity.Info);
        Navigation.NavigateTo("/", true);
    }

    private class ProfileModel
    {
        [Required(ErrorMessage = "Imiƒô i nazwisko jest wymagane.")]
        [StringLength(100)]
        public string FullName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email jest wymagany.")]
        [EmailAddress(ErrorMessage = "Podaj poprawny adres email.")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Telefon jest wymagany.")]
        [Phone(ErrorMessage = "Podaj poprawny numer telefonu.")]
        public string PhoneNumber { get; set; } = string.Empty;

        [StringLength(200)]
        public string? Address { get; set; }

        [StringLength(50)]
        public string? DocumentNumber { get; set; }
    }
}
