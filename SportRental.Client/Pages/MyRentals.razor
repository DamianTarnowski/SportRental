@page "/my-rentals"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@inject IApiService Api
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<PageTitle>Moje wypo≈ºyczenia - SportRental</PageTitle>

<div class="rentals-container">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="rentals-header">
            <h1>üìã Moje wypo≈ºyczenia</h1>
            <p>PrzeglƒÖdaj historiƒô swoich wypo≈ºycze≈Ñ i aktywne rezerwacje</p>
        </div>

        @if (_isLoading)
        {
            <div class="flex items-center justify-center py-20">
                <div class="text-center">
                    <div class="w-16 h-16 border-4 border-pink-200 border-t-pink-500 rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-600">≈Åadowanie wypo≈ºycze≈Ñ...</p>
                </div>
            </div>
        }
        else if (_rentals == null || !_rentals.Any())
        {
            <div class="rentals-empty">
                <div class="rentals-empty-icon">üì≠</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Brak wypo≈ºycze≈Ñ</h2>
                <p class="text-gray-600 mb-6">Nie masz jeszcze ≈ºadnych wypo≈ºycze≈Ñ. Zacznij swojƒÖ przygodƒô ze sportem!</p>
                <a href="/products" class="cart-checkout-btn" style="max-width: 300px; margin: 0 auto; text-decoration: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    üéø PrzeglƒÖdaj sprzƒôt
                </a>
            </div>
        }
        else
        {
            <div class="space-y-4">
                @foreach (var rental in _rentals.OrderByDescending(r => r.StartDateUtc))
                {
                    <div class="rental-card">
                        <div class="rental-card-header">
                            <div class="rental-card-dates">
                                <div class="rental-date-group">
                                    <div class="rental-date-label">Od</div>
                                    <div class="rental-date-value">@rental.StartDateUtc.ToLocalTime().ToString("dd.MM.yyyy")</div>
                                </div>
                                <div class="rental-date-group">
                                    <div class="rental-date-label">Do</div>
                                    <div class="rental-date-value">@rental.EndDateUtc.ToLocalTime().ToString("dd.MM.yyyy")</div>
                                </div>
                            </div>
                            <span class="rental-status @GetStatusClass(rental.Status)">
                                @GetStatusEmoji(rental.Status) @rental.Status
                            </span>
                        </div>

                        <div class="rental-products">
                            @foreach (var item in rental.Items.Take(3))
                            {
                                <div class="rental-product-item">
                                    <span>üì¶ @item.ProductName</span>
                                    <span class="font-medium">x@item.Quantity</span>
                                </div>
                            }
                            @if (rental.Items.Count > 3)
                            {
                                <div class="text-sm text-gray-500 mt-2">
                                    + @(rental.Items.Count - 3) wiƒôcej...
                                </div>
                            }
                        </div>

                        <div class="rental-card-footer">
                            <div class="rental-total">
                                @rental.TotalAmount.ToString("C")
                                <span>depozyt: @rental.DepositAmount.ToString("C")</span>
                            </div>
                            <div class="rental-actions">
                                <button class="rental-btn rental-btn-primary" @onclick="@(() => ViewDetails(rental.Id))">
                                    üëÅÔ∏è Szczeg√≥≈Çy
                                </button>
                                @if (rental.ContractUrl != null)
                                {
                                    <a href="@rental.ContractUrl" target="_blank" class="rental-btn rental-btn-secondary">
                                        üìÑ Umowa
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private bool _isLoading = true;
    private List<MyRentalDto>? _rentals;

    protected override async Task OnInitializedAsync()
    {
        await LoadRentalsAsync();
    }

    private async Task LoadRentalsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _rentals = await Api.GetMyRentalsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd podczas ≈Çadowania wypo≈ºycze≈Ñ: {ex.Message}", Severity.Error);
            _rentals = new List<MyRentalDto>();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "reserved" or "confirmed" => "reserved",
            "active" or "onrent" => "active",
            "returned" or "completed" => "completed",
            "cancelled" => "cancelled",
            "overdue" => "overdue",
            _ => ""
        };
    }

    private string GetStatusEmoji(string status)
    {
        return status.ToLower() switch
        {
            "reserved" or "confirmed" => "üìÖ",
            "active" or "onrent" => "‚úÖ",
            "returned" or "completed" => "üèÅ",
            "cancelled" => "‚ùå",
            "overdue" => "‚ö†Ô∏è",
            _ => "üìã"
        };
    }

    private void ViewDetails(Guid rentalId)
    {
        Nav.NavigateTo($"/my-rentals/{rentalId}");
    }
}
