@page "/cart"
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@inject ICartService CartService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Koszyk - SportRental</PageTitle>

<div class="cart-container">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="cart-header">
            <h1>üõí Tw√≥j Koszyk</h1>
            <p>Sprawd≈∫ wybrane produkty przed wypo≈ºyczeniem</p>
        </div>

        @if (_cart.Items.Count == 0)
        {
            <!-- Empty Cart -->
            <div class="cart-empty">
                <div class="cart-empty-icon">üõí</div>
                <h2>Tw√≥j koszyk jest pusty</h2>
                <p>Dodaj sprzƒôt sportowy, aby rozpoczƒÖƒá wypo≈ºyczenie</p>
                <a href="/products" class="cart-checkout-btn" style="max-width: 300px; margin: 0 auto; text-decoration: none;">
                    üì¶ PrzeglƒÖdaj katalog
                </a>
            </div>
        }
        else
        {
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Cart Items -->
                <div class="lg:col-span-2 space-y-4">
                    @foreach (var item in _cart.Items)
                    {
                        <div class="cart-item">
                            <!-- Image -->
                            @if (!string.IsNullOrEmpty(item.ProductImageUrl))
                            {
                                <img src="@item.ProductImageUrl" alt="@item.ProductName" class="cart-item-image" />
                            }
                            else
                            {
                                <div class="cart-item-placeholder">üì¶</div>
                            }

                            <!-- Details -->
                            <div class="cart-item-details">
                                <h3>@item.ProductName</h3>
                                <p class="cart-item-price">@item.DailyPrice.ToString("C") / dzie≈Ñ</p>
                                
                                <div class="cart-item-dates">
                                    <div class="flex flex-col">
                                        <label class="text-xs text-gray-500 mb-1">üìÖ Od</label>
                                        <input type="date" 
                                               value="@item.StartDate.ToString("yyyy-MM-dd")" 
                                               min="@DateTime.Today.ToString("yyyy-MM-dd")"
                                               @onchange="@((e) => OnStartDateChanged(item, e))"
                                               class="px-3 py-2 border rounded-lg text-sm" />
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-xs text-gray-500 mb-1">üìÖ Do</label>
                                        <input type="date" 
                                               value="@item.EndDate.ToString("yyyy-MM-dd")" 
                                               min="@item.StartDate.AddDays(1).ToString("yyyy-MM-dd")"
                                               @onchange="@((e) => OnEndDateChanged(item, e))"
                                               class="px-3 py-2 border rounded-lg text-sm" />
                                    </div>
                                </div>
                                
                                <p class="text-sm text-gray-500 mt-2">
                                    ‚è±Ô∏è @item.TotalDays dni wynajmu
                                </p>

                                @if (item.HoldId is not null)
                                {
                                    <div class="mt-2 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-sm inline-flex items-center gap-1">
                                        ‚úÖ Rezerwacja do @item.HoldExpiresAtUtc?.ToLocalTime().ToString("HH:mm:ss")
                                    </div>
                                }
                            </div>

                            <!-- Actions -->
                            <div class="cart-item-actions">
                                <div class="cart-quantity">
                                    <button @onclick="@(() => UpdateQuantity(item, item.Quantity - 1))">‚àí</button>
                                    <span>@item.Quantity</span>
                                    <button @onclick="@(() => UpdateQuantity(item, item.Quantity + 1))">+</button>
                                </div>
                                
                                <div class="cart-item-total">@item.TotalPrice.ToString("C")</div>
                                
                                <button class="cart-remove-btn" @onclick="@(() => RemoveFromCart(item.ProductId))">
                                    üóëÔ∏è Usu≈Ñ
                                </button>
                            </div>
                        </div>
                    }
                </div>

                <!-- Summary -->
                <div class="lg:col-span-1">
                    <div class="cart-summary">
                        <h2>üìã Podsumowanie</h2>
                        
                        <div class="cart-summary-row">
                            <span>Produkty (@_cart.TotalItems)</span>
                            <span>@_cart.TotalAmount.ToString("C")</span>
                        </div>
                        
                        <div class="cart-summary-row">
                            <span>Dostawa</span>
                            <span class="text-green-600 font-medium">Gratis</span>
                        </div>
                        
                        <div class="cart-summary-row cart-summary-total">
                            <span>≈ÅƒÖcznie</span>
                            <span class="text-xl text-purple-600">@_cart.TotalAmount.ToString("C")</span>
                        </div>

                        <button class="cart-checkout-btn" @onclick="ProceedToCheckout">
                            üí≥ Przejd≈∫ do p≈Çatno≈õci
                        </button>
                        
                        <button class="cart-continue-btn" @onclick="@(() => Navigation.NavigateTo("/products"))">
                            üõí Kontynuuj zakupy
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private SportRental.Shared.Models.Cart _cart = new();

    private CancellationTokenSource? _refreshCts;
    private Task? _refreshLoop;

    protected override void OnInitialized()
    {
        _cart = CartService.GetCart();
        CartService.CartChanged += OnCartChanged;
        StartRefreshLoop();
    }

    private void OnCartChanged(object? sender, EventArgs e)
    {
        _cart = CartService.GetCart();
        InvokeAsync(StateHasChanged);
    }

    private async Task UpdateQuantity(CartItem item, int newQuantity)
    {
        await CartService.UpdateQuantityAsync(item.ProductId, newQuantity);
    }

    private async Task RemoveFromCart(Guid productId)
    {
        await CartService.RemoveFromCartAsync(productId);
        Snackbar.Add("Produkt zosta≈Ç usuniƒôty z koszyka", Severity.Success);
    }

    private async Task OnStartDateChanged(CartItem item, ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var newDate))
        {
            if (newDate < DateTime.Today)
            {
                Snackbar.Add("Data rozpoczƒôcia nie mo≈ºe byƒá z przesz≈Ço≈õci", Severity.Warning);
                return;
            }

            item.StartDate = newDate;
            
            if (item.EndDate <= item.StartDate)
            {
                item.EndDate = item.StartDate.AddDays(1);
                Snackbar.Add("Data zako≈Ñczenia zosta≈Ça dostosowana", Severity.Info);
            }
            
            await CartService.UpdateDatesAsync(item.ProductId, item.StartDate, item.EndDate);
        }
    }

    private async Task OnEndDateChanged(CartItem item, ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var newDate))
        {
            if (newDate <= item.StartDate)
            {
                Snackbar.Add("Data zako≈Ñczenia musi byƒá p√≥≈∫niejsza ni≈º data rozpoczƒôcia", Severity.Warning);
                return;
            }

            var daysDiff = (newDate - item.StartDate).Days;
            if (daysDiff > 365)
            {
                Snackbar.Add("Maksymalny okres wypo≈ºyczenia to 365 dni", Severity.Warning);
                return;
            }

            item.EndDate = newDate;
            await CartService.UpdateDatesAsync(item.ProductId, item.StartDate, item.EndDate);
        }
    }

    private async Task ProceedToCheckout()
    {
        if (_cart.Items.Count == 0)
        {
            Snackbar.Add("Koszyk jest pusty", Severity.Warning);
            return;
        }

        foreach (var item in _cart.Items)
        {
            if (item.StartDate < DateTime.Today)
            {
                Snackbar.Add($"Data rozpoczƒôcia dla {item.ProductName} jest nieprawid≈Çowa", Severity.Error);
                return;
            }

            if (item.EndDate <= item.StartDate)
            {
                Snackbar.Add($"Daty wypo≈ºyczenia dla {item.ProductName} sƒÖ nieprawid≈Çowe", Severity.Error);
                return;
            }
        }

        await CartService.RefreshHoldsIfNeededAsync();
        var holdsOk = await CartService.EnsureHoldsAsync();
        if (!holdsOk)
        {
            Snackbar.Add("Nie uda≈Ço siƒô zarezerwowaƒá wybranych produkt√≥w. Zaktualizuj koszyk i spr√≥buj ponownie.", Severity.Error);
            return;
        }

        var isAvailable = await CartService.ValidateAvailabilityAsync();
        if (!isAvailable)
        {
            var unavailableNames = _cart.Items
                .Where(i => CartService.LastUnavailableProductIds.Contains(i.ProductId))
                .Select(i => i.ProductName)
                .Distinct()
                .ToList();

            var message = unavailableNames.Count > 0
                ? $"Produkty niedostƒôpne: {string.Join(", ", unavailableNames)}"
                : "Nie uda≈Ço siƒô potwierdziƒá dostƒôpno≈õci produkt√≥w. Spr√≥buj ponownie.";

            Snackbar.Add(message, Severity.Error);
            return;
        }

        Navigation.NavigateTo("/checkout");
    }

    private void StartRefreshLoop()
    {
        _refreshCts = new CancellationTokenSource();
        var token = _refreshCts.Token;
        _refreshLoop = Task.Run(async () =>
        {
            try
            {
                while (!token.IsCancellationRequested)
                {
                    await CartService.RefreshHoldsIfNeededAsync();
                    await Task.Delay(TimeSpan.FromSeconds(60), token);
                }
            }
            catch (TaskCanceledException) { }
        }, token);
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
        _refreshCts?.Cancel();
    }
}
