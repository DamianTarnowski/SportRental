@page "/checkout"
@implements IDisposable
@using System.ComponentModel.DataAnnotations
@using SportRental.Shared.Models
@using CartModel = SportRental.Shared.Models.Cart
@using SportRental.Shared.Services
@using SportRental.Client.Services
@inject ICartService CartService
@inject IApiService Api
@inject ICustomerSessionService Session
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<PageTitle>Finalizacja zam√≥wienia - SportRental</PageTitle>

<div class="checkout-container">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="checkout-header">
            <h1>üí≥ Finalizacja zam√≥wienia</h1>
            <p>Ostatni krok - sprawd≈∫ szczeg√≥≈Çy i dokonaj p≈Çatno≈õci</p>
            <div class="checkout-steps">
                <div class="checkout-step">
                    <span class="checkout-step-number">‚úì</span>
                    <span>Koszyk</span>
                </div>
                <div class="checkout-step active">
                    <span class="checkout-step-number">2</span>
                    <span>Finalizacja</span>
                </div>
                <div class="checkout-step">
                    <span class="checkout-step-number">3</span>
                    <span>P≈Çatno≈õƒá</span>
                </div>
            </div>
        </div>

        @if (_isPaymentInProgress)
        {
            <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                <div class="bg-white rounded-3xl p-10 text-center shadow-2xl">
                    <div class="w-20 h-20 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-6"></div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Przekierowanie do p≈Çatno≈õci...</h2>
                    <p class="text-gray-600">Proszƒô czekaƒá, nie zamykaj okna</p>
                </div>
            </div>
        }

        @if (_cart.Items.Count == 0)
        {
            <div class="text-center py-20 bg-white rounded-3xl shadow-sm">
                <div class="text-8xl mb-6">üõí</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Koszyk jest pusty</h2>
                <p class="text-gray-600 mb-8">Dodaj produkty do koszyka aby kontynuowaƒá</p>
                <a href="/products" class="checkout-submit-btn" style="max-width: 280px; margin: 0 auto; text-decoration: none;">
                    üì¶ PrzeglƒÖdaj katalog
                </a>
            </div>
        }
        else
        {
            <div class="checkout-grid">
                <!-- Items List -->
                <div class="checkout-items-card">
                    <h2>üì¶ Produkty do wypo≈ºyczenia</h2>
                    
                    @foreach (var item in _cart.Items)
                    {
                        <div class="checkout-item">
                            <div>
                                <div class="checkout-item-name">@item.ProductName</div>
                                <div class="checkout-item-details">
                                    @item.Quantity szt. √ó @item.TotalDays dni
                                    (@item.StartDate.ToShortDateString() - @item.EndDate.ToShortDateString())
                                </div>
                                @if (item.HoldId is not null)
                                {
                                    <span class="inline-block mt-1 px-2 py-1 bg-blue-50 text-blue-600 text-xs rounded-lg">
                                        ‚úÖ Zarezerwowany do @item.HoldExpiresAtUtc?.ToLocalTime().ToString("HH:mm:ss")
                                    </span>
                                }
                            </div>
                            <div class="checkout-item-price">@item.TotalPrice.ToString("C")</div>
                        </div>
                    }

                    @if (_hasMixedDates)
                    {
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-yellow-800">
                            ‚ö†Ô∏è Pozycje majƒÖ r√≥≈ºne daty. Ujednoliƒá daty przed finalizacjƒÖ.
                        </div>
                    }
                </div>

                <!-- Form & Summary -->
                <div class="checkout-form-card">
                    <h2>üë§ Dane do rezerwacji</h2>

                    <EditForm Model="_customer">
                        <DataAnnotationsValidator />
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Imiƒô i nazwisko *</label>
                                <InputText @bind-Value="_customer.FullName" 
                                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none"
                                           placeholder="Jan Kowalski" />
                            </div>

                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                    <InputText @bind-Value="_customer.Email" type="email"
                                               @onfocusout="HandleEmailBlur"
                                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none"
                                               placeholder="jan@example.com" />
                                </div>
                                <button type="button" 
                                        class="self-end px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl text-sm font-medium transition"
                                        disabled="@(!CanSearchExisting || _isLookupInProgress)"
                                        @onclick="LookupCustomerButtonAsync">
                                    @if (_isLookupInProgress)
                                    {
                                        <span>üîÑ</span>
                                    }
                                    else
                                    {
                                        <span>üîç</span>
                                    }
                                </button>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefon *</label>
                                <InputText @bind-Value="_customer.PhoneNumber" type="tel"
                                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none"
                                           placeholder="+48 123 456 789" />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Adres (opcjonalnie)</label>
                                <InputTextArea @bind-Value="_customer.Address" rows="2"
                                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none"
                                               placeholder="ul. Sportowa 123, Warszawa" />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Uwagi do rezerwacji</label>
                                <InputTextArea @bind-Value="_notes" rows="2"
                                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none"
                                               placeholder="Dodatkowe informacje..." />
                            </div>
                        </div>
                    </EditForm>

                    <!-- Payment Summary -->
                    <div class="checkout-summary">
                        <h3 class="font-semibold text-gray-800 mb-3">üí∞ Podsumowanie p≈Çatno≈õci</h3>
                        
                        @if (_quoteError is not null)
                        {
                            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-yellow-800 text-sm mb-3">
                                ‚ö†Ô∏è @_quoteError
                                <button @onclick="RefreshPaymentSummaryAsync" class="ml-2 underline">Od≈õwie≈º</button>
                            </div>
                        }
                        else if (_quote is null)
                        {
                            <div class="flex items-center gap-2 text-gray-500">
                                <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                Obliczanie kwoty...
                            </div>
                        }
                        else
                        {
                            <div class="checkout-summary-row">
                                <span>≈ÅƒÖcznie za wypo≈ºyczenie</span>
                                <span class="font-semibold">@_quote.TotalAmount.ToString("C")</span>
                            </div>
                            <div class="checkout-summary-row">
                                <span>Depozyt (p≈Çatne teraz)</span>
                                <span class="font-semibold text-blue-600">@_quote.DepositAmount.ToString("C")</span>
                            </div>
                            <div class="checkout-summary-row">
                                <span>Pozosta≈Ço przy odbiorze</span>
                                <span>@((_quote.TotalAmount - _quote.DepositAmount).ToString("C"))</span>
                            </div>
                            <div class="checkout-summary-row checkout-summary-total">
                                <span>Do zap≈Çaty teraz</span>
                                <span class="text-xl text-blue-600">@_quote.DepositAmount.ToString("C")</span>
                            </div>
                        }
                    </div>

                    <button class="checkout-submit-btn" 
                            disabled="@(_isSubmitting || _isPaymentInProgress || _cart.Items.Count == 0 || _hasMixedDates || _quote is null || _quoteError is not null)"
                            @onclick="SubmitAsync">
                        @if (_isSubmitting)
                        {
                            <span>‚è≥ Przetwarzanie...</span>
                        }
                        else
                        {
                            <span>‚úÖ Potwierd≈∫ i zap≈Çaƒá</span>
                        }
                    </button>

                    <p class="text-center text-sm text-gray-500 mt-4">
                        üîí P≈Çatno≈õƒá obs≈Çugiwana przez Stripe
                    </p>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private CartModel _cart = new();
    private bool _isSubmitting;
    private CheckoutCustomerModel _customer = new();
    private string? _notes;
    private bool _hasMixedDates;
    private Guid? _existingCustomerId;
    private string? _lastLookupEmail;
    private bool _isLookupInProgress;
    private CancellationTokenSource? _refreshCts;
    private Task? _refreshLoop;
    private PaymentQuoteResponse? _quote;
    private string? _quoteError;
    private bool _isPaymentInProgress;

    private bool CanSearchExisting => !string.IsNullOrWhiteSpace(_customer.Email);

    protected override async Task OnInitializedAsync()
    {
        _cart = CartService.GetCart();
        _hasMixedDates = HasMixedDates(_cart);
        CartService.CartChanged += OnCartChanged;
        await PrefillFromSessionAsync();
        _ = RefreshPaymentSummaryAsync();
        StartRefreshLoop();
    }

    private async Task PrefillFromSessionAsync()
    {
        try
        {
            var customer = await Session.GetCustomerAsync();
            if (customer is null) return;

            _existingCustomerId = customer.Id;
            _customer.FullName = customer.FullName ?? string.Empty;
            _customer.Email = customer.Email ?? string.Empty;
            _customer.PhoneNumber = customer.PhoneNumber ?? string.Empty;
            _customer.Address = customer.Address;
            _customer.DocumentNumber = customer.DocumentNumber;
            _customer.Notes = customer.Notes;
            _lastLookupEmail = _customer.Email;

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine("[Checkout] Failed to prefill customer session: {0}", ex);
        }
    }

    private void OnCartChanged(object? sender, EventArgs e)
    {
        _cart = CartService.GetCart();
        _hasMixedDates = HasMixedDates(_cart);
        _ = RefreshPaymentSummaryAsync();
    }

    private static bool HasMixedDates(CartModel cart)
    {
        if (cart.Items.Count == 0) return false;
        var start = cart.Items[0].StartDate;
        var end = cart.Items[0].EndDate;
        return cart.Items.Any(i => i.StartDate != start || i.EndDate != end);
    }

    private async Task RefreshPaymentSummaryAsync()
    {
        if (_cart.Items.Count == 0)
        {
            _quote = null;
            _quoteError = null;
            await InvokeAsync(StateHasChanged);
            return;
        }

        var first = _cart.Items[0];
        var request = new PaymentQuoteRequest
        {
            StartDateUtc = first.StartDate.ToUniversalTime(),
            EndDateUtc = first.EndDate.ToUniversalTime(),
            Items = BuildCartItemsPayload()
        };

        try
        {
            _quote = await Api.GetPaymentQuoteAsync(request);
            _quoteError = null;
        }
        catch (Exception ex)
        {
            _quote = null;
            _quoteError = $"Nie uda≈Ço siƒô obliczyƒá kosztu: {ex.Message}";
        }

        await InvokeAsync(StateHasChanged);
    }

    private List<CreateRentalItem> BuildCartItemsPayload()
    {
        return _cart.Items.Select(i => new CreateRentalItem
        {
            ProductId = i.ProductId,
            Quantity = i.Quantity
        }).ToList();
    }

    private async Task HandleEmailBlur(FocusEventArgs _)
    {
        await LookupCustomerAsync(showFeedback: false);
    }

    private async Task LookupCustomerButtonAsync()
    {
        await LookupCustomerAsync(showFeedback: true);
    }

    private async Task LookupCustomerAsync(bool showFeedback)
    {
        if (_isLookupInProgress) return;

        var email = _customer.Email?.Trim();
        if (string.IsNullOrWhiteSpace(email))
        {
            _existingCustomerId = null;
            _lastLookupEmail = null;
            return;
        }

        if (string.Equals(email, _lastLookupEmail, StringComparison.OrdinalIgnoreCase) && _existingCustomerId.HasValue && !showFeedback)
        {
            return;
        }

        _isLookupInProgress = true;
        try
        {
            var existing = await Api.FindCustomerByEmailAsync(email);
            if (existing is null)
            {
                _existingCustomerId = null;
                _lastLookupEmail = email;
                if (showFeedback)
                {
                    Snackbar.Add("Nie znaleziono klienta z podanym adresem email.", Severity.Info);
                }
                return;
            }

            _existingCustomerId = existing.Id;
            _lastLookupEmail = existing.Email;
            _customer.FullName = existing.FullName;
            _customer.Email = existing.Email;
            _customer.PhoneNumber = existing.PhoneNumber;
            _customer.Address = existing.Address;
            _customer.DocumentNumber = existing.DocumentNumber;
            _customer.Notes = existing.Notes;
            await InvokeAsync(StateHasChanged);

            if (showFeedback)
            {
                Snackbar.Add("Za≈Çadowano dane istniejƒÖcego klienta.", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            if (showFeedback)
            {
                Snackbar.Add($"B≈ÇƒÖd podczas wyszukiwania klienta: {ex.Message}", Severity.Error);
            }
        }
        finally
        {
            _isLookupInProgress = false;
        }
    }

    private async Task SubmitAsync()
    {
        if (_isSubmitting) return;
        _isSubmitting = true;
        try
        {
            if (_cart.Items.Count == 0)
            {
                Snackbar.Add("Koszyk jest pusty", Severity.Warning);
                return;
            }

            if (_hasMixedDates)
            {
                Snackbar.Add("R√≥≈ºne daty w pozycjach koszyka - ustaw te same daty dla wszystkich pozycji.", Severity.Error);
                return;
            }

            if (string.IsNullOrWhiteSpace(_customer.FullName) || string.IsNullOrWhiteSpace(_customer.Email) || string.IsNullOrWhiteSpace(_customer.PhoneNumber))
            {
                Snackbar.Add("Uzupe≈Çnij poprawnie dane klienta.", Severity.Error);
                return;
            }

            await CartService.RefreshHoldsIfNeededAsync();
            var holdsOk = await CartService.EnsureHoldsAsync();
            if (!holdsOk)
            {
                Snackbar.Add("Nie uda≈Ço siƒô od≈õwie≈ºyƒá/utworzyƒá hold√≥w. Spr√≥buj ponownie.", Severity.Error);
                return;
            }

            var normalizedEmail = _customer.Email?.Trim();
            CustomerDto? customer = null;

            if (!string.IsNullOrWhiteSpace(normalizedEmail) &&
                _existingCustomerId.HasValue &&
                string.Equals(normalizedEmail, _lastLookupEmail, StringComparison.OrdinalIgnoreCase))
            {
                try
                {
                    customer = await Api.UpdateCustomerAsync(_existingCustomerId.Value, new CreateCustomerRequest
                    {
                        FullName = _customer.FullName,
                        Email = _customer.Email,
                        PhoneNumber = _customer.PhoneNumber,
                        Address = _customer.Address,
                        DocumentNumber = _customer.DocumentNumber,
                        Notes = _customer.Notes
                    });
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Nie uda≈Ço siƒô zaktualizowaƒá danych klienta: {ex.Message}", Severity.Error);
                    return;
                }

                if (customer is null)
                {
                    _existingCustomerId = null;
                    _lastLookupEmail = null;
                }
            }

            if (customer is null)
            {
                try
                {
                    customer = await Api.CreateCustomerAsync(new CreateCustomerRequest
                    {
                        FullName = _customer.FullName,
                        Email = _customer.Email,
                        PhoneNumber = _customer.PhoneNumber,
                        Address = _customer.Address,
                        DocumentNumber = _customer.DocumentNumber,
                        Notes = _customer.Notes
                    });
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Nie uda≈Ço siƒô zapisaƒá danych klienta: {ex.Message}", Severity.Error);
                    return;
                }
            }

            if (customer is null)
            {
                Snackbar.Add("Nie uda≈Ço siƒô otrzymaƒá danych klienta.", Severity.Error);
                return;
            }

            var customerId = customer.Id;
            _existingCustomerId = customer.Id;
            _lastLookupEmail = customer.Email;
            _customer.FullName = customer.FullName;
            _customer.Email = customer.Email;
            _customer.PhoneNumber = customer.PhoneNumber;
            _customer.Address = customer.Address;
            _customer.DocumentNumber = customer.DocumentNumber;
            _customer.Notes = customer.Notes;

            await Session.SetCustomerAsync(customer);

            var itemsPayload = BuildCartItemsPayload();
            var first = _cart.Items[0];
            var startUtc = first.StartDate.ToUniversalTime();
            var endUtc = first.EndDate.ToUniversalTime();

            PaymentQuoteResponse quote;
            try
            {
                quote = await Api.GetPaymentQuoteAsync(new PaymentQuoteRequest
                {
                    StartDateUtc = startUtc,
                    EndDateUtc = endUtc,
                    Items = itemsPayload
                });
                _quote = quote;
                _quoteError = null;
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Nie uda≈Ço siƒô obliczyƒá p≈Çatno≈õci: {ex.Message}", Severity.Error);
                return;
            }

            CheckoutSessionResponse session;
            try
            {
                _isPaymentInProgress = true;
                
                var customerEmail = _customer?.Email ?? "";
                
                session = await Api.CreateCheckoutSessionAsync(new CreateCheckoutSessionRequest(
                    StartDateUtc: startUtc,
                    EndDateUtc: endUtc,
                    Items: itemsPayload.Select(i => new CheckoutItem(i.ProductId, i.Quantity)).ToList(),
                    CustomerEmail: customerEmail,
                    CustomerId: customerId
                ));
                
                Snackbar.Add("Przekierowanie do Stripe...", Severity.Info);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"B≈ÇƒÖd p≈Çatno≈õci: {ex.Message}", Severity.Error);
                _isPaymentInProgress = false;
                return;
            }

            await CartService.ReleaseAllHoldsAsync();
            await CartService.ClearCartAsync();
            
            Nav.NavigateTo(session.Url, forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"B≈ÇƒÖd podczas finalizacji: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void StartRefreshLoop()
    {
        _refreshCts = new CancellationTokenSource();
        var token = _refreshCts.Token;
        _refreshLoop = Task.Run(async () =>
        {
            try
            {
                while (!token.IsCancellationRequested)
                {
                    await CartService.RefreshHoldsIfNeededAsync();
                    await RefreshPaymentSummaryAsync();
                    await Task.Delay(TimeSpan.FromSeconds(60), token);
                }
            }
            catch (TaskCanceledException) { }
        }, token);
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
        _refreshCts?.Cancel();
    }

    private class CheckoutCustomerModel
    {
        [Required(ErrorMessage = "Imiƒô i nazwisko jest wymagane.")]
        [StringLength(100)]
        public string FullName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email jest wymagany.")]
        [EmailAddress(ErrorMessage = "Podaj poprawny adres email.")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Telefon jest wymagany.")]
        [Phone(ErrorMessage = "Podaj poprawny numer telefonu.")]
        public string PhoneNumber { get; set; } = string.Empty;

        [StringLength(200)]
        public string? Address { get; set; }

        [StringLength(50)]
        public string? DocumentNumber { get; set; }

        public string? Notes { get; set; }
    }
}
