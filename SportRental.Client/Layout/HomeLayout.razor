@inherits LayoutComponentBase
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@using SportRental.Client.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject ICartService CartService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthService AuthService
@implements IDisposable

<!-- Home Layout - Full width, no sidebar -->
<div class="min-h-screen">
    <!-- Floating Header (transparent on hero, solid when scrolled) -->
    <header class="fixed inset-x-0 top-0 z-50 transition-all duration-300 @(_scrolled ? "bg-white/95 backdrop-blur-lg shadow-sm" : "bg-transparent")">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-20 flex items-center gap-3">
            <!-- Mobile menu button -->
            <button type="button" class="lg:hidden inline-flex items-center justify-center rounded-md p-2 @(_scrolled ? "text-gray-700 hover:bg-gray-100" : "text-white hover:bg-white/10")"
                    @onclick="ToggleDrawer" aria-label="Open menu">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 5.25h16.5M3.75 12h16.5m-16.5 6.75h16.5" />
                </svg>
            </button>
            <a class="text-2xl font-semibold @(_scrolled ? "text-gray-900" : "text-white")" href="/">üèÇ SportRental</a>
            <div class="ml-auto flex items-center gap-2">
                <!-- Navigation links (desktop) -->
                <nav class="hidden md:flex items-center gap-1">
                    <a href="/products" class="px-4 py-2 rounded-full text-sm font-medium transition-colors @(_scrolled ? "text-gray-700 hover:bg-gray-100" : "text-white/90 hover:bg-white/10")">
                        Katalog
                    </a>
                    <a href="/contact" class="px-4 py-2 rounded-full text-sm font-medium transition-colors @(_scrolled ? "text-gray-700 hover:bg-gray-100" : "text-white/90 hover:bg-white/10")">
                        Kontakt
                    </a>
                </nav>
                <a href="/cart" class="relative inline-flex items-center justify-center rounded-full p-2.5 transition-colors @(_scrolled ? "text-gray-700 hover:bg-gray-100" : "text-white hover:bg-white/10")" aria-label="Cart">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
                        <path d="M2.25 3a.75.75 0 0 0 0 1.5h1.386c.2 0 .374.133.428.326l2.201 7.705A2.25 2.25 0 0 0 8.45 13.5H17.25a2.25 2.25 0 0 0 2.154-1.59l1.563-5.26A.75.75 0 0 0 20.25 5.25H6.654l-.36-1.26A1.875 1.875 0 0 0 3.636 3H2.25Z" />
                        <path d="M9 21a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm9 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                    </svg>
                    @if (_cart.TotalItems > 0)
                    {
                        <span class="absolute -top-0.5 -right-0.5 inline-flex items-center justify-center rounded-full bg-red-500 w-5 h-5 text-[10px] font-bold text-white">
                            @_cart.TotalItems
                        </span>
                    }
                </a>
                @if (_isAuthenticated)
                {
                    <div class="flex items-center gap-2">
                        <a href="/my-rentals" class="hidden sm:inline-flex px-4 py-2 rounded-full text-sm font-medium transition-colors @(_scrolled ? "text-gray-700 hover:bg-gray-100" : "text-white/90 hover:bg-white/10")">
                            Moje wynajmy
                        </a>
                        <button @onclick="LogoutAsync" class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 rounded-full text-sm font-semibold transition-all @(_scrolled ? "bg-gray-200 text-gray-800 hover:bg-gray-300" : "bg-white/20 text-white hover:bg-white/30")">
                            Wyloguj
                        </button>
                    </div>
                }
                else
                {
                    <div class="flex items-center gap-2">
                        <a href="/login" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-colors @(_scrolled ? "text-gray-700 hover:bg-gray-100 border border-gray-300" : "text-white border border-white/30 hover:bg-white/10")">
                            üîë Zaloguj
                        </a>
                        <a href="/register" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-semibold transition-all shadow-lg @(_scrolled ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-white text-gray-900 hover:bg-gray-100")">
                            ‚ú® Zarejestruj siƒô
                        </a>
                    </div>
                }
            </div>
        </div>
    </header>

    <!-- Mobile drawer -->
    @if (_drawerOpen)
    {
        <div class="fixed inset-0 z-[60] lg:hidden">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @onclick="ToggleDrawer"></div>
            <div class="absolute inset-y-0 left-0 w-80 bg-white shadow-2xl">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-8">
                        <span class="text-xl font-bold text-gray-900">üèÇ SportRental</span>
                        <button @onclick="ToggleDrawer" class="p-2 rounded-full hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <nav class="space-y-2">
                        <a href="/" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-gray-100 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                            </svg>
                            Strona g≈Ç√≥wna
                        </a>
                        <a href="/products" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-gray-100 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
                            </svg>
                            Katalog produkt√≥w
                        </a>
                        <a href="/cart" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-gray-100 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                            </svg>
                            Koszyk
                            @if (_cart.TotalItems > 0)
                            {
                                <span class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">@_cart.TotalItems</span>
                            }
                        </a>
                        <a href="/contact" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-gray-100 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                            </svg>
                            Kontakt
                        </a>
                        <hr class="my-4" />
                        <a href="/login" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-gray-100 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                            </svg>
                            Zaloguj siƒô
                        </a>
                        <a href="/register" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-600 text-white font-medium">
                            Za≈Ç√≥≈º konto
                        </a>
                    </nav>
                </div>
            </div>
        </div>
    }

    <!-- Main content - Full width for home page -->
    <main>
        @Body
    </main>
</div>

@inject IJSRuntime JS

@code {
    private bool _drawerOpen = false;
    private bool _scrolled = false;
    private bool _isAuthenticated = false;
    private string? _userEmail;
    private Cart _cart = new();

    protected override async Task OnInitializedAsync()
    {
        _cart = CartService.GetCart();
        CartService.CartChanged += OnCartChanged;
        
        // Check authentication state
        await UpdateAuthState();
        
        // Subscribe to auth state changes
        if (AuthStateProvider is ApiAuthenticationStateProvider apiAuth)
        {
            apiAuth.AuthenticationStateChanged += OnAuthStateChanged;
        }
    }

    private async void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        await UpdateAuthState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateAuthState()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
        _userEmail = authState.User.Identity?.Name;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Add scroll listener for header transparency
            await JS.InvokeVoidAsync("eval", @"
                window.addEventListener('scroll', function() {
                    const header = document.querySelector('header');
                    if (window.scrollY > 50) {
                        DotNet.invokeMethodAsync('SportRental.Client', 'SetScrolled', true);
                    } else {
                        DotNet.invokeMethodAsync('SportRental.Client', 'SetScrolled', false);
                    }
                });
            ");
        }
    }

    [JSInvokable]
    public static void SetScrolled(bool scrolled)
    {
        // This will be handled by JavaScript
    }

    private void OnCartChanged(object? sender, EventArgs e)
    {
        _cart = CartService.GetCart();
        InvokeAsync(StateHasChanged);
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task LogoutAsync()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/", forceLoad: true);
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
        if (AuthStateProvider is ApiAuthenticationStateProvider apiAuth)
        {
            apiAuth.AuthenticationStateChanged -= OnAuthStateChanged;
        }
    }
}

