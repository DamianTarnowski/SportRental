@inherits LayoutComponentBase
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@inject NavigationManager Navigation
@inject ICartService CartService
@implements IDisposable

<div class="lg:pl-64">
    <!-- Header -->
    <header class="fixed inset-x-0 top-0 z-30 bg-white/90 backdrop-blur border-b shadow-sm">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-24 flex items-center gap-3">
            <!-- Mobile menu button -->
            <button type="button" class="lg:hidden inline-flex items-center justify-center rounded-md p-2 text-gray-700 hover:bg-gray-100"
                    @onclick="ToggleDrawer" aria-label="Open menu">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 5.25h16.5M3.75 12h16.5m-16.5 6.75h16.5" />
                </svg>
            </button>
            <a class="text-2xl font-semibold text-gray-900" href="/">üèÇ SportRental</a>
            <div class="ml-auto flex items-center gap-4">
                <TenantSelector />
                <a href="/cart" class="relative inline-flex items-center justify-center rounded-md p-2 text-gray-700 hover:bg-gray-100" aria-label="Cart">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6">
                        <path d="M2.25 3a.75.75 0 0 0 0 1.5h1.386c.2 0 .374.133.428.326l2.201 7.705A2.25 2.25 0 0 0 8.45 13.5H17.25a2.25 2.25 0 0 0 2.154-1.59l1.563-5.26A.75.75 0 0 0 20.25 5.25H6.654l-.36-1.26A1.875 1.875 0 0 0 3.636 3H2.25Z" />
                        <path d="M9 21a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm9 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                    </svg>
                    @if (_cart.TotalItems > 0)
                    {
                        <span class="absolute -top-1 -right-1 inline-flex items-center justify-center rounded-full bg-red-600 px-2 py-1 text-xs font-bold text-white min-w-[20px] h-5">
                            @_cart.TotalItems
                        </span>
                    }
                </a>
                <a href="/login" class="inline-flex items-center justify-center rounded-md p-2 text-gray-700 hover:bg-gray-100" aria-label="Account">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6">
                        <path fill-rule="evenodd" d="M12 2.25a4.5 4.5 0 0 0-4.5 4.5v.75a4.5 4.5 0 0 0 9 0v-.75A4.5 4.5 0 0 0 12 2.25ZM4.5 20.25a7.5 7.5 0 0 1 15 0v.75H4.5v-.75Z" clip-rule="evenodd" />
                    </svg>
                </a>
            </div>
        </div>
    </header>

    <!-- Spacer to offset fixed header height (and provide extra breathing room) -->
    <div class="h-28"></div>

    <!-- Desktop sidebar -->
    <aside class="hidden lg:flex fixed left-0 top-28 z-20 w-64 h-[calc(100vh-7rem)] bg-white border-r">
        <div class="w-full h-full overflow-y-auto p-4">
            <NavMenu />
        </div>
    </aside>

    <!-- Mobile drawer -->
    @if (_drawerOpen)
    {
        <div class="fixed inset-0 z-50 lg:hidden">
            <div class="absolute inset-0 bg-black/40" @onclick="ToggleDrawer"></div>
            <div class="absolute inset-y-0 left-0 w-72 bg-white shadow-lg p-4">
                <NavMenu />
            </div>
        </div>
    }

    <!-- Main content -->
    <main class="pt-4 p-4">
        @Body
    </main>

    <!-- Back to top button -->
    <MudFab Color="Color.Primary" 
            StartIcon="@Icons.Material.Filled.KeyboardArrowUp" 
            Class="back-to-top"
            OnClick="ScrollToTop"
            aria-label="Przewi≈Ñ do g√≥ry"
            Style="position: fixed; bottom: 2rem; right: 2rem; z-index: 1000;" />
</div>

@inject IJSRuntime JS

@code {
    private async Task ScrollToTop()
    {
        await JS.InvokeVoidAsync("eval", "window.scrollTo({ top: 0, behavior: 'smooth' })");
    }

    private bool _drawerOpen = false;
    private Cart _cart = new();

    protected override async Task OnInitializedAsync()
    {
        _cart = CartService.GetCart();
        CartService.CartChanged += OnCartChanged;
        await InvokeAsync(StateHasChanged);
    }

    private void OnCartChanged(object? sender, EventArgs e)
    {
        _cart = CartService.GetCart();
        InvokeAsync(StateHasChanged);
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
    }
}
