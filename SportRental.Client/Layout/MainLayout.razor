@inherits LayoutComponentBase
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@using SportRental.Client.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject ICartService CartService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthService AuthService
@implements IDisposable

<!-- =============================================
     HEADER - Premium Dark Glassmorphism
     ============================================= -->
<header class="sr-header">
    <div class="sr-header-content">
        <!-- Mobile Menu Button -->
        <button type="button" class="sr-menu-btn" @onclick="ToggleDrawer" aria-label="Menu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 24px; height: 24px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
        
        <!-- Logo -->
        <a href="/" class="sr-logo">
            <div class="sr-logo-icon">üèÇ</div>
            <div class="sr-logo-text">Sport<span>Rental</span></div>
        </a>
        
        <!-- Header Nav Links -->
        <nav class="sr-header-nav">
            <NavLink href="/products" class="sr-header-link" ActiveClass="active">
                üì¶ Katalog
            </NavLink>
            <NavLink href="/contact" class="sr-header-link" ActiveClass="active">
                ‚úâÔ∏è Kontakt
            </NavLink>
        </nav>
        
        <!-- Header Actions -->
        <div class="sr-header-actions">
            <!-- Cart Button -->
            <a href="/cart" class="sr-header-btn" aria-label="Koszyk">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.25 3a.75.75 0 0 0 0 1.5h1.386c.2 0 .374.133.428.326l2.201 7.705A2.25 2.25 0 0 0 8.45 13.5H17.25a2.25 2.25 0 0 0 2.154-1.59l1.563-5.26A.75.75 0 0 0 20.25 5.25H6.654l-.36-1.26A1.875 1.875 0 0 0 3.636 3H2.25Z" />
                    <path d="M9 21a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm9 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                </svg>
                @if (_cart.TotalItems > 0)
                {
                    <span class="sr-header-btn-badge">@_cart.TotalItems</span>
                }
            </a>
            
            <!-- Account Button -->
            @if (_isAuthenticated)
            {
                <div class="sr-user-menu">
                    <button class="sr-header-user" @onclick="ToggleUserMenu" @onclick:stopPropagation="true">
                        <div class="sr-user-avatar">
                            @(_userEmail?.Substring(0, 1).ToUpper() ?? "U")
                        </div>
                        <span class="sr-user-name">@_userEmail</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 16px; height: 16px;">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    @if (_userMenuOpen)
                    {
                        <div class="sr-user-dropdown">
                            <a href="/profile" class="sr-dropdown-item">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 18px; height: 18px;">
                                    <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" />
                                </svg>
                                M√≥j profil
                            </a>
                            <a href="/my-rentals" class="sr-dropdown-item">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 18px; height: 18px;">
                                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm6 7a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1zm-3 3a1 1 0 100 2h.01a1 1 0 100-2H10zm-4 1a1 1 0 011-1h.01a1 1 0 110 2H7a1 1 0 01-1-1zm1-4a1 1 0 100 2h.01a1 1 0 100-2H7zm2 1a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm4-4a1 1 0 100 2h.01a1 1 0 100-2H13zM9 9a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zM7 8a1 1 0 000 2h.01a1 1 0 000-2H7z" clip-rule="evenodd" />
                                </svg>
                                Moje wypo≈ºyczenia
                            </a>
                            <div class="sr-dropdown-divider"></div>
                            <button class="sr-dropdown-item sr-dropdown-logout" @onclick="LogoutAsync">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 18px; height: 18px;">
                                    <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943h9.546A.75.75 0 0019 10z" clip-rule="evenodd" />
                                </svg>
                                Wyloguj
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <a href="/login" class="sr-header-login">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                        <path fill-rule="evenodd" d="M12 2.25a4.5 4.5 0 0 0-4.5 4.5v.75a4.5 4.5 0 0 0 9 0v-.75A4.5 4.5 0 0 0 12 2.25ZM4.5 20.25a7.5 7.5 0 0 1 15 0v.75H4.5v-.75Z" clip-rule="evenodd" />
                    </svg>
                    Zaloguj
                </a>
            }
        </div>
    </div>
</header>

<!-- =============================================
     SIDEBAR - Modern Dark Theme
     ============================================= -->
<aside class="sr-sidebar">
    <div class="sr-sidebar-content">
        <!-- Main Navigation -->
        <div class="sr-sidebar-section">
            <div class="sr-sidebar-title">Menu</div>
            <NavMenu />
        </div>
    </div>
</aside>

<!-- =============================================
     MOBILE DRAWER
     ============================================= -->
<div class="sr-drawer-overlay @(_drawerOpen ? "open" : "")" @onclick="ToggleDrawer"></div>
<div class="sr-drawer @(_drawerOpen ? "open" : "")">
    <div class="sr-drawer-header">
        <a href="/" class="sr-logo" @onclick="ToggleDrawer">
            <div class="sr-logo-icon">üèÇ</div>
            <div class="sr-logo-text">Sport<span>Rental</span></div>
        </a>
        <button class="sr-drawer-close" @onclick="ToggleDrawer" aria-label="Zamknij">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 24px; height: 24px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    <div class="sr-sidebar-content">
        <div class="sr-sidebar-section">
            <NavMenu OnNavigate="ToggleDrawer" />
        </div>
    </div>
</div>

<!-- =============================================
     MAIN CONTENT
     ============================================= -->
<div class="sr-main">
    <main class="sr-main-content">
        @Body
    </main>
</div>

@inject IJSRuntime JS

@code {
    private bool _drawerOpen = false;
    private bool _userMenuOpen = false;
    private bool _isAuthenticated = false;
    private string? _userEmail;
    private Cart _cart = new();

    protected override async Task OnInitializedAsync()
    {
        _cart = CartService.GetCart();
        CartService.CartChanged += OnCartChanged;
        
        // Check authentication state
        await UpdateAuthState();
        
        // Subscribe to auth state changes
        if (AuthStateProvider is ApiAuthenticationStateProvider apiAuth)
        {
            apiAuth.AuthenticationStateChanged += OnAuthStateChanged;
        }
    }

    private async void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        await UpdateAuthState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateAuthState()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
        _userEmail = authState.User.Identity?.Name;
    }

    private void OnCartChanged(object? sender, EventArgs e)
    {
        _cart = CartService.GetCart();
        InvokeAsync(StateHasChanged);
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void ToggleUserMenu()
    {
        _userMenuOpen = !_userMenuOpen;
    }

    private async Task LogoutAsync()
    {
        _userMenuOpen = false;
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/", forceLoad: true);
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
        if (AuthStateProvider is ApiAuthenticationStateProvider apiAuth)
        {
            apiAuth.AuthenticationStateChanged -= OnAuthStateChanged;
        }
    }
}
