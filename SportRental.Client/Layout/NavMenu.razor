@using SportRental.Client.Services
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject ICartService CartService
@inject ICustomerSessionService Session
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider
@inject IApiService Api
@implements IDisposable

<nav>
    <!-- Main Navigation -->
    <NavLink href="/" Match="NavLinkMatch.All" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
        <span class="sr-sidebar-link-icon">ğŸ </span>
        <span>Strona gÅ‚Ã³wna</span>
    </NavLink>

    <NavLink href="/products" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
        <span class="sr-sidebar-link-icon">ğŸ“¦</span>
        <span>Katalog produktÃ³w</span>
    </NavLink>

    <NavLink href="/cart" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
        <span class="sr-sidebar-link-icon">ğŸ›’</span>
        <span>Koszyk</span>
        @if (_cart.TotalItems > 0)
        {
            <span class="sr-sidebar-badge">@_cart.TotalItems</span>
        }
    </NavLink>

    <NavLink href="/contact" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
        <span class="sr-sidebar-link-icon">âœ‰ï¸</span>
        <span>Kontakt</span>
    </NavLink>

    <div class="sr-sidebar-divider"></div>

    <!-- Account Section -->
    <div class="sr-sidebar-title">Konto</div>
    
    @if (_customer is null)
    {
        <NavLink href="/login" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">ğŸ”‘</span>
            <span>Zaloguj siÄ™</span>
        </NavLink>
        
        <NavLink href="/register" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">âœ¨</span>
            <span>Zarejestruj siÄ™</span>
        </NavLink>
        
        <NavLink href="/my-rentals" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">ğŸ“‹</span>
            <span>Moje wynajmy</span>
        </NavLink>
    }
    else
    {
        <!-- User Info Card -->
        <div class="sr-sidebar-user">
            <div class="sr-sidebar-user-name">ğŸ‘¤ @_customer!.FullName</div>
            <div class="sr-sidebar-user-email">@_customer!.Email</div>
        </div>
        
        <NavLink href="/profile" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">âš™ï¸</span>
            <span>Moje dane</span>
        </NavLink>
        
        <NavLink href="/my-rentals" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">ğŸ“‹</span>
            <span>Moje wynajmy</span>
        </NavLink>
        
        <button type="button" class="sr-sidebar-logout" disabled="@_isLoggingOut" @onclick="LogoutAsync">
            <span class="sr-sidebar-link-icon">ğŸšª</span>
            <span>@(_isLoggingOut ? "Wylogowywanie..." : "Wyloguj siÄ™")</span>
        </button>
    }
</nav>

@code {
    [Parameter]
    public EventCallback OnNavigate { get; set; }
    
    private Cart _cart = new();
    private CustomerDto? _customer;
    private bool _isLoggingOut;

    protected override async Task OnInitializedAsync()
    {
        _cart = CartService.GetCart();
        CartService.CartChanged += OnCartChanged;

        await LoadSessionAsync();
        Session.SessionChanged += OnSessionChanged;
        
        // Subscribe to auth state changes
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
    }

    private async Task HandleNavigation()
    {
        if (OnNavigate.HasDelegate)
        {
            await OnNavigate.InvokeAsync();
        }
    }

    private async Task LoadSessionAsync()
    {
        // First try session
        _customer = await Session.GetCustomerAsync();
        
        // If no session, check if user is authenticated via JWT
        if (_customer is null)
        {
            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                if (user.Identity?.IsAuthenticated == true)
                {
                    var email = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value 
                             ?? user.FindFirst("email")?.Value;
                    
                    if (!string.IsNullOrWhiteSpace(email))
                    {
                        // Try to find existing customer by email
                        var customer = await Api.FindCustomerByEmailAsync(email);
                        
                        // If no customer exists, create one from JWT data
                        if (customer is null)
                        {
                            var name = user.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value 
                                    ?? user.FindFirst("name")?.Value 
                                    ?? email.Split('@')[0];
                            
                            var request = new CreateCustomerRequest
                            {
                                Email = email,
                                FullName = name,
                                PhoneNumber = "" // Will need to be filled later
                            };
                            
                            customer = await Api.CreateCustomerAsync(request);
                        }
                        
                        if (customer is not null)
                        {
                            _customer = customer;
                            await Session.SetCustomerAsync(customer);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine("[NavMenu] Failed to load auth state: {0}", ex);
            }
        }
    }

    private void OnCartChanged(object? sender, EventArgs e)
    {
        _cart = CartService.GetCart();
        InvokeAsync(StateHasChanged);
    }

    private void OnSessionChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(async () =>
        {
            await LoadSessionAsync();
            StateHasChanged();
        });
    }

    private void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        _ = InvokeAsync(async () =>
        {
            await LoadSessionAsync();
            StateHasChanged();
        });
    }

    private async Task LogoutAsync()
    {
        if (_isLoggingOut)
        {
            return;
        }

        _isLoggingOut = true;
        try
        {
            // Clear customer session
            await Session.ClearAsync();
            
            // Also logout from JWT auth
            if (AuthStateProvider is ApiAuthenticationStateProvider apiAuth)
            {
                await apiAuth.MarkUserAsLoggedOut();
            }
            
            _customer = null;
            Snackbar.Add("Wylogowano.", Severity.Info);
            Navigation.NavigateTo("/", true);
        }
        finally
        {
            _isLoggingOut = false;
        }
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
        Session.SessionChanged -= OnSessionChanged;
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
    }
}
