@using SportRental.Client.Services
@using SportRental.Shared.Models
@using SportRental.Shared.Services
@inject ICartService CartService
@inject ICustomerSessionService Session
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IDisposable

<nav>
    <!-- Main Navigation -->
    <NavLink href="/" Match="NavLinkMatch.All" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
        <span class="sr-sidebar-link-icon">ğŸ </span>
        <span>Strona gÅ‚Ã³wna</span>
    </NavLink>

    <NavLink href="/products" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
        <span class="sr-sidebar-link-icon">ğŸ“¦</span>
        <span>Katalog produktÃ³w</span>
    </NavLink>

    <NavLink href="/cart" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
        <span class="sr-sidebar-link-icon">ğŸ›’</span>
        <span>Koszyk</span>
        @if (_cart.TotalItems > 0)
        {
            <span class="sr-sidebar-badge">@_cart.TotalItems</span>
        }
    </NavLink>

    <NavLink href="/contact" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
        <span class="sr-sidebar-link-icon">âœ‰ï¸</span>
        <span>Kontakt</span>
    </NavLink>

    <div class="sr-sidebar-divider"></div>

    <!-- Account Section -->
    <div class="sr-sidebar-title">Konto</div>
    
    @if (_customer is null)
    {
        <NavLink href="/login" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">ğŸ”‘</span>
            <span>Zaloguj siÄ™</span>
        </NavLink>
        
        <NavLink href="/register" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">âœ¨</span>
            <span>Zarejestruj siÄ™</span>
        </NavLink>
        
        <NavLink href="/my-rentals" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">ğŸ“‹</span>
            <span>Moje wynajmy</span>
        </NavLink>
    }
    else
    {
        <!-- User Info Card -->
        <div class="sr-sidebar-user">
            <div class="sr-sidebar-user-name">ğŸ‘¤ @_customer!.FullName</div>
            <div class="sr-sidebar-user-email">@_customer!.Email</div>
        </div>
        
        <NavLink href="/profile" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">âš™ï¸</span>
            <span>Moje dane</span>
        </NavLink>
        
        <NavLink href="/my-rentals" class="sr-sidebar-link" ActiveClass="active" @onclick="HandleNavigation">
            <span class="sr-sidebar-link-icon">ğŸ“‹</span>
            <span>Moje wynajmy</span>
        </NavLink>
        
        <button type="button" class="sr-sidebar-logout" disabled="@_isLoggingOut" @onclick="LogoutAsync">
            <span class="sr-sidebar-link-icon">ğŸšª</span>
            <span>@(_isLoggingOut ? "Wylogowywanie..." : "Wyloguj siÄ™")</span>
        </button>
    }
</nav>

@code {
    [Parameter]
    public EventCallback OnNavigate { get; set; }
    
    private Cart _cart = new();
    private CustomerDto? _customer;
    private bool _isLoggingOut;

    protected override async Task OnInitializedAsync()
    {
        _cart = CartService.GetCart();
        CartService.CartChanged += OnCartChanged;

        await LoadSessionAsync();
        Session.SessionChanged += OnSessionChanged;
    }

    private async Task HandleNavigation()
    {
        if (OnNavigate.HasDelegate)
        {
            await OnNavigate.InvokeAsync();
        }
    }

    private async Task LoadSessionAsync()
    {
        _customer = await Session.GetCustomerAsync();
    }

    private void OnCartChanged(object? sender, EventArgs e)
    {
        _cart = CartService.GetCart();
        InvokeAsync(StateHasChanged);
    }

    private void OnSessionChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(async () =>
        {
            await LoadSessionAsync();
            StateHasChanged();
        });
    }

    private async Task LogoutAsync()
    {
        if (_isLoggingOut)
        {
            return;
        }

        _isLoggingOut = true;
        try
        {
            await Session.ClearAsync();
            Snackbar.Add("Wylogowano.", Severity.Info);
            Navigation.NavigateTo("/", true);
        }
        finally
        {
            _isLoggingOut = false;
        }
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
        Session.SessionChanged -= OnSessionChanged;
    }
}
